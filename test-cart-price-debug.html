<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тест логування цін в кошику</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .product-card {
            border: 1px solid #ccc;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .color-option {
            display: inline-block;
            width: 30px;
            height: 30px;
            margin: 5px;
            border: 2px solid #ddd;
            border-radius: 50%;
            cursor: pointer;
            position: relative;
        }
        .color-option.selected {
            border-color: #007bff;
        }
        .color-option:hover {
            border-color: #0056b3;
        }
        .price {
            font-size: 18px;
            font-weight: bold;
            color: #28a745;
            margin: 10px 0;
        }
        .add-to-cart-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .add-to-cart-btn:hover {
            background: #0056b3;
        }
        .cart-section {
            margin-top: 30px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 5px;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 3px;
        }
        .console-output {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Тест логування цін в кошику</h1>
        <p>Цей тест допоможе відстежити, як розраховується ціна при додаванні товару в кошик.</p>
        
        <div class="test-section">
            <h3>Тестовий товар з кольорами</h3>
            <div class="product-card">
                <h4>Меблі з кольорами (ID: test-product-1)</h4>
                <p>Базова ціна: <span class="price">1000 грн</span></p>
                
                <div>
                    <strong>Кольори:</strong><br>
                    <div class="color-option" style="background-color: #8B4513;" data-color="brown" data-price-change="0" onclick="selectColor('test-product-1', 0, 0)"></div>
                    <span>Коричневий (+0 грн)</span><br>
                    
                    <div class="color-option" style="background-color: #000080;" data-color="navy" data-price-change="200" onclick="selectColor('test-product-1', 0, 1)"></div>
                    <span>Темно-синій (+200 грн)</span><br>
                    
                    <div class="color-option" style="background-color: #FFD700;" data-color="gold" data-price-change="500" onclick="selectColor('test-product-1', 0, 2)"></div>
                    <span>Золотий (+500 грн)</span>
                </div>
                
                <div style="margin-top: 15px;">
                    <strong>Кількість:</strong>
                    <input type="number" id="quantity-test-product-1" value="1" min="1" style="width: 60px; margin-left: 10px;">
                </div>
                
                <button class="add-to-cart-btn" onclick="addToCartTest('test-product-1')">Додати в кошик</button>
            </div>
        </div>
        
        <div class="cart-section">
            <h3>Кошик</h3>
            <div id="cart-items"></div>
            <div id="cart-content"></div>
        </div>
        
        <div class="console-output" id="console-output">
            <strong>Логи консолі:</strong><br>
            <div id="log-content"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <script>
        // Мокуємо дані для тестування
        window.products = [
            {
                _id: 'test-product-1',
                id: 'test-product-1',
                name: 'Меблі з кольорами',
                price: 1000,
                salePrice: null,
                saleEnd: null,
                photos: ['https://placehold.co/300x200?text=Меблі'],
                colorBlocks: [
                    [
                        { name: 'Коричневий', value: 'brown', priceChange: 0, photo: null, globalIndex: 0 },
                        { name: 'Темно-синій', value: 'navy', priceChange: 200, photo: null, globalIndex: 1 },
                        { name: 'Золотий', value: 'gold', priceChange: 500, photo: null, globalIndex: 2 }
                    ]
                ],
                type: 'furniture'
            }
        ];
        
        window.cart = [];
        window.selectedColors = {};
        window.categories = [];
        window.orders = [];
        window.slides = [];
        window.filters = [];
        window.orderFields = [];
        window.settings = {};
        window.currentProduct = null;
        window.currentCategory = null;
        window.currentSubcategory = null;
        window.currentSort = '';
        window.currentPage = 1;
        window.perPage = 20;
        window.selectedMattressSizes = {};
        window.currentSlideIndex = 0;
        window.slideInterval = null;
        window.currentGalleryIndex = 0;
        window.currentGalleryImages = [];
        window.removeCartIndex = -1;
        window.searchResults = [];
        window.baseSearchResults = [];
        window.baseFilteredProducts = [];
        window.isSearchActive = false;
        window.isSearchPending = false;
        window.filteredProducts = [];
        window.ws = null;
        window.activeTimers = new Map();
        window.parentGroupProduct = null;
        window.searchQuery = '';
        window.BASE_URL = 'http://localhost:3000';
        window.NO_IMAGE_URL = 'https://placehold.co/300x200?text=Фото+відсутнє';

        // Функції для логування
        function log(message) {
            const logContent = document.getElementById('log-content');
            const timestamp = new Date().toLocaleTimeString();
            logContent.innerHTML += `[${timestamp}] ${message}<br>`;
            logContent.scrollTop = logContent.scrollHeight;
            console.log(message);
        }

        // Перехоплюємо console.log
        const originalConsoleLog = console.log;
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            log(args.join(' '));
        };

        // Мокуємо функції
        function loadFromStorage(key, defaultValue) {
            if (key === 'cart') {
                return window.cart;
            }
            if (key === 'selectedColors') {
                return window.selectedColors;
            }
            return defaultValue;
        }

        function saveToStorage(key, value) {
            if (key === 'cart') {
                window.cart = value;
            }
            if (key === 'selectedColors') {
                window.selectedColors = value;
            }
        }

        function getAllColors(product) {
            if (product.colorBlocks && product.colorBlocks.length > 0) {
                return product.colorBlocks.flat();
            }
            return [];
        }

        function selectColor(productId, blockIndex, globalIndex) {
            if (!window.selectedColors[productId]) {
                window.selectedColors[productId] = {};
            }
            window.selectedColors[productId][blockIndex] = globalIndex;
            
            // Оновлюємо вигляд
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            log(`Вибрано колір: productId=${productId}, blockIndex=${blockIndex}, globalIndex=${globalIndex}`);
        }

        function addToCartTest(productId) {
            log('=== ПОЧАТОК ТЕСТУ ДОДАВАННЯ В КОШИК ===');
            
            const product = window.products.find(p => p._id === productId || p.id === productId);
            if (!product) {
                log('Товар не знайдено!');
                return;
            }
            
            log('Товар: ' + product.name);
            log('Базова ціна товару: ' + product.price);
            log('Акційна ціна товару: ' + product.salePrice);
            
            const allColors = getAllColors(product);
            const selectedColorIndices = window.selectedColors[product._id] || {};
            
            log('Всі кольори товару: ' + JSON.stringify(allColors));
            log('Вибрані кольори: ' + JSON.stringify(selectedColorIndices));
            
            let price = product.price;
            log('Ціна після розміру/акції: ' + price);
            
            let totalPriceChange = 0;
            Object.values(selectedColorIndices).forEach(globalIndex => {
                const selectedColor = allColors.find(color => color.globalIndex === globalIndex);
                if (selectedColor && selectedColor.priceChange) {
                    totalPriceChange += parseFloat(selectedColor.priceChange);
                    log(`Колір ${selectedColor.name} змінює ціну на: ${selectedColor.priceChange}`);
                }
            });
            
            log('Загальна зміна ціни від кольорів: ' + totalPriceChange);
            price += totalPriceChange;
            log('Фінальна ціна після кольорів: ' + price);
            
            const selectedColorsForCart = [];
            Object.entries(selectedColorIndices).forEach(([blockIndex, globalIndex]) => {
                const selectedColor = allColors.find(color => color.globalIndex === globalIndex);
                if (selectedColor) {
                    selectedColorsForCart.push({
                        ...selectedColor,
                        blockIndex: parseInt(blockIndex)
                    });
                }
            });
            
            const qtyInput = document.getElementById(`quantity-${product._id}`);
            let quantity = 1;
            if (qtyInput && !isNaN(parseInt(qtyInput.value))) {
                quantity = Math.max(1, parseInt(qtyInput.value));
            }
            
            const cartItem = {
                id: product._id || product.id,
                name: product.name,
                quantity,
                price: parseFloat(price),
                photo: product.photos?.[0] || window.NO_IMAGE_URL,
                colors: selectedColorsForCart,
                size: null
            };
            
            log('Об\'єкт товару для кошика: ' + JSON.stringify(cartItem));
            
            // Додаємо в кошик
            window.cart.push(cartItem);
            log('Товар додано в кошик!');
            
            // Оновлюємо відображення
            renderCartTest();
        }

        function renderCartTest() {
            const cartItems = document.getElementById('cart-items');
            const cartContent = document.getElementById('cart-content');
            
            cartItems.innerHTML = '';
            cartContent.innerHTML = '';
            
            if (window.cart.length === 0) {
                cartItems.innerHTML = '<p>Кошик порожній</p>';
                return;
            }
            
            window.cart.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'cart-item';
                
                const span = document.createElement('span');
                let displayName = item.name;
                
                if (item.colors && Array.isArray(item.colors) && item.colors.length > 0) {
                    const colorNames = item.colors.map(color => color.name).join(', ');
                    displayName += ` (${colorNames})`;
                }
                
                const totalPrice = item.price * item.quantity;
                log(`Відображення товару в кошику: ${displayName}, ціна за одиницю: ${item.price}, кількість: ${item.quantity}, загальна ціна: ${totalPrice}`);
                span.textContent = `${displayName} - ${totalPrice} грн`;
                
                itemDiv.appendChild(span);
                cartItems.appendChild(itemDiv);
            });
            
            const totalP = document.createElement('p');
            totalP.className = 'cart-total';
            const total = window.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            totalP.textContent = `Разом: ${total} грн`;
            cartContent.appendChild(totalP);
        }

        // Ініціалізація
        document.addEventListener('DOMContentLoaded', function() {
            log('Тест ініціалізовано');
            renderCartTest();
        });
    </script>
</body>
</html> 