<!DOCTYPE html>
<html lang="uk">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>
   Адмін-панель
  </title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js">
  </script>
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js">
  </script>
  <style>
   body {
            font-family: 'Roboto', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }
        .content {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            display: none;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .section.active {
            display: block;
        }
        h2, h3, h4 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        input, textarea, select {
            margin: 8px 0 2px 0;
            padding: 10px;
            width: 100%;
            max-width: 350px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }
        label {
            display: block;
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 2px;
            margin-bottom: 8px;
        }
        button {
            padding: 10px 20px;
            background: #3498db;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
            font-size: 14px;
        }
        button:hover {
            background: #2980b9;
        }
        .edit-btn {
            background: #27ae60;
        }
        .edit-btn:hover {
            background: #219653;
        }
        .delete-btn {
            background: #e74c3c;
        }
        .delete-btn:hover {
            background: #c0392b;
        }
        .toggle-btn {
            background: #f1c40f;
            color: #333;
        }
        .toggle-btn:hover {
            background: #d4ac0d;
        }
        .move-btn {
            background: #95a5a6;
            padding: 5px 10px;
            font-size: 12px;
        }
        .move-btn:hover {
            background: #7f8c8d;
        }
        .admin-tabs {
            margin: 20px 0;
            display: flex;
            gap: 5px;
        }
        .tab-btn {
            background: #ecf0f1;
            color: #7f8c8d;
            padding: 10px 20px;
            border-radius: 4px 4px 0 0;
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            background: #3498db;
            color: #fff;
        }
        .admin-tab {
            display: none;
        }
        .admin-tab.active {
            display: block;
        }
        .admin-section {
            margin-bottom: 25px;
            padding: 15px;
            background: #fafafa;
            border-radius: 6px;
        }
        .product-admin-item, #product-list-header {
            display: grid;
            grid-template-columns: 5% 15% 25% 15% 10% 10% 20%; /* Збільшуємо колонку "Статус" до 20% */
            align-items: center;
            padding: 10px;
            background: #fff;
            margin: 5px 0;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        #product-list-header {
            font-weight: bold;
            background: #ecf0f1;
        }
        .product-admin-item > span, #product-list-header > span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 0 5px;
            text-align: center; /* Центруємо текст у всіх колонках */
        }
        .product-admin-item .status-column {
            display: flex;
            flex-wrap: wrap; /* Дозволяємо кнопкам переноситися на новий рядок, якщо не вміщаються */
            gap: 5px;
            justify-content: center; /* Центруємо кнопки в колонці */
            padding: 5px;
        }
        .product-admin-item .status-column button {
            padding: 6px 10px;
            font-size: 14px;
        }
        .pagination {
            text-align: center;
            margin-top: 20px;
        }
        .pagination button {
            margin: 0 5px;
            padding: 8px 12px;
            background: #ecf0f1;
            color: #333;
        }
        .pagination button.active {
            background: #3498db;
            color: #fff;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
        }
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            position: relative;
        }
        .modal-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #2ecc71;
            color: #fff;
            padding: 10px 20px;
            border-radius: 4px;
            display: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .notification.active {
            display: block;
        }
        .sort-menu {
            position: relative;
            display: inline-block;
        }
        .sort-btn {
            background: #ecf0f1;
            color: #333;
        }
        .sort-dropdown {
            display: none;
            position: absolute;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .sort-menu:hover .sort-dropdown {
            display: block;
        }
        .sort-dropdown button {
            display: block;
            width: 100%;
            text-align: left;
            background: none;
            color: #333;
            border: none;
            padding: 8px 12px;
        }
        .sort-dropdown button:hover {
            background: #f5f5f5;
        }
        .color-item, .photo-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            gap: 10px;
        }
        .color-item img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
        }
        #cat-list {
            margin-top: 10px;
        }
        #cat-list .category-item {
            margin: 10px 0;
            font-weight: bold;
            padding-left: 5px;
            background-color: #e0f7fa;
            border-left: 4px solid #3498db;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #cat-list .subcat-list {
            margin-left: 40px;
        }
        #cat-list .subcat-list p {
            font-weight: normal;
            margin: 5px 0;
            background-color: #f0f0f0;
            border-left: 4px solid #27ae60;
            padding-left: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .type-specific {
            display: none;
        }
        .type-specific.active {
            display: block;
        }
        .color-preview {
            width: 20px;
            height: 20px;
            border: 1px solid #ddd;
            display: inline-block;
            vertical-align: middle;
        }
        .editor-toolbar {
            margin-bottom: 10px;
        }
        .editor-toolbar button {
            padding: 5px 10px;
            font-size: 12px;
            margin-right: 5px;
        }
        .photo-list, .color-photo-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 5px;
            margin-top: 10px;
        }
        .photo-item.draggable {
            cursor: move;
            padding: 5px;
            border: 1px dashed #ddd;
            margin: 5px 0;
        }
        .photo-item.dragging {
            opacity: 0.5;
        }
        .filter-options {
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .filter-options label {
            font-size: 14px;
            color: #7f8c8d;
        }
        .filter-options select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            max-width: 200px;
        }
        .sale-info {
            color: #e74c3c;
            font-weight: bold;
        }
        .sale-countdown {
            color: #e74c3c;
            font-size: 12px;
        }
        .group-product-search {
            margin-bottom: 10px;
        }
        .group-product-search input {
            width: 100%;
            max-width: 300px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .custom-select-wrapper {
            position: relative;
            width: 100%;
            max-width: 300px;
        }
        .custom-select {
            position: relative;
        }
        .custom-select select {
            display: none;
        }
        .custom-select-trigger {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .custom-options {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
        }
        .custom-options.active {
            display: block;
        }
        .custom-option {
            padding: 8px 12px;
            cursor: pointer;
        }
        .custom-option:hover {
            background: #f5f5f5;
        }
        .custom-option.selected {
            background: #3498db;
            color: #fff;
        }
        .custom-select-search {
            width: 100%;
            padding: 8px;
            border: none;
            border-bottom: 1px solid #ddd;
            box-sizing: border-box;
        }
        .mattress-size, .group-product {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
        }
        .social-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
        }
        .social-icon {
            font-size: 16px;
        }
        .orders-section {
            padding: 20px;
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #fff;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        .order-item:hover {
            transform: translateY(-2px);
        }
        .order-item span {
            font-size: 14px;
            color: #2c3e50;
        }
        .order-item button {
            margin-left: 10px;
        }
.backup-group {
    margin-bottom: 15px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
}
.product-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    margin-bottom: 15px; /* Додаємо відступ знизу */
}

.import-group {
    display: flex;
    align-items: center;
    gap: 10px;
}

.import-group input[type="file"] {
    display: none; /* Приховуємо стандартний input */
}

.import-btn {
    background: #27ae60; /* Зелений колір для кнопки імпорту */
    padding: 10px 20px;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.3s ease;
    font-size: 14px;
}

.import-btn:hover {
    background: #219653; /* Темніший зелений при наведенні */
}

/* Модальне вікно для зміни розмірів */
.resize-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 1001; /* Вище, ніж основне модальне вікно */
    justify-content: center;
    align-items: center;
}

.resize-modal.active {
    display: flex;
}

.resize-modal-content {
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    max-width: 400px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    position: relative;
}

.resize-modal-content h4 {
    margin-top: 0;
    color: #2c3e50;
}

.resize-modal-content input {
    width: 100%;
    margin: 5px 0;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.resize-modal-actions {
    margin-top: 15px;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

/* Стиль для виділення зображення/відео при кліку */
.quill-media-selected {
    border: 2px solid #3498db;
    box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
}

/* Стилі для кнопок "Назад" і "Вперед" */
.ql-undo,
.ql-redo {
    background: none;
    border: none;
    padding: 0 8px;
    cursor: pointer;
    color: #000; /* Чорний колір для видимості */
    font-size: 16px;
    line-height: 1;
}

.ql-undo::before,
.ql-redo::before {
    font-family: 'Arial', sans-serif;
    display: inline-block;
    width: 16px;
    height: 16px;
}

.ql-undo::before {
    content: '↶'; /* Символ для "Назад" */
}

.ql-redo::before {
    content: '↷'; /* Символ для "Вперед" */
}

.ql-undo:hover,
.ql-redo:hover {
    background: #f0f0f0;
}


@media (max-width: 768px) {
    .product-admin-item, #product-list-header {
        grid-template-columns: 10% 20% 30% 20% 20%; /* Спрощуємо сітку */
        font-size: 12px; /* Зменшуємо розмір шрифту */
    }
    .product-admin-item > span, #product-list-header > span {
        white-space: normal; /* Дозволяємо перенос тексту */
        text-overflow: unset;
        overflow: visible;
    }
    .product-admin-item .status-column {
        flex-direction: column; /* Розміщуємо кнопки вертикально */
        gap: 8px;
    }
    .product-admin-item .status-column button {
        width: 100%; /* Кнопки на всю ширину */
    }
}

@media (max-width: 480px) {
    .product-admin-item, #product-list-header {
        grid-template-columns: 1fr; /* Одна колонка на дуже маленьких екранах */
        text-align: left; /* Вирівнюємо текст зліва */
    }
    .product-admin-item > span, #product-list-header > span {
        padding: 5px;
        border-bottom: 1px solid #ddd; /* Додаємо роздільник між полями */
    }
    .product-admin-item .status-column {
        flex-direction: row; /* Повертаємо горизонтальне розміщення */
        flex-wrap: wrap;
    }
}

@media (max-width: 600px) {
    .modal-content {
        width: 90%;
        max-width: none;
        padding: 15px;
    }
    .modal-content input,
    .modal-content select,
    .modal-content textarea {
        max-width: 100%;
    }
}
  </style>
 </head>
 <body>
  <div class="content">
<div class="section active" id="admin-login">
    <h2>Вхід в адмін-панель</h2>
    <input id="admin-username" placeholder="Логін" type="text"/><br/>
    <label for="admin-username">Введіть логін</label>
    <input id="admin-password" placeholder="Пароль" type="password"/><br/>
    <label for="admin-password">Введіть пароль</label>
    <button id="login-btn">Увійти</button>
</div>
   <div class="section" id="admin-panel">
    <h2>
     Адмін-панель
    </h2>
    <button onclick="logout()" style="position: absolute; top: 20px; right: 20px;">
     Вийти
    </button>
    <div class="admin-tabs">
     <button class="tab-btn active" onclick="showAdminTab('site-editing')">
      Редагування сайту
     </button>
     <button class="tab-btn" onclick="showAdminTab('products')">
      Товари
     </button>
     <button class="tab-btn" onclick="showAdminTab('orders')">
      Замовлення
     </button>
    </div>
    <div class="admin-tab active" id="site-editing">
     <div class="admin-section">
      <h3>
       Логотип та назва
      </h3>
      <input id="store-name" placeholder="Назва магазину" type="text"/>
      <br/>
      <label for="store-name">
       Назва магазину
      </label>
      <input id="base-url" placeholder="Базовий URL (наприклад, https://www.yourdomain.com)" type="text"/>
      <br/>
      <!-- Added Base URL input -->
      <label for="base-url">
       Базовий URL сайту
      </label>
      <input class="logo-input" id="logo-url" placeholder="URL логотипу" type="text"/>
      <br/>
      <label for="logo-url">
       URL логотипу
      </label>
      <input accept="image/*" id="logo-file" type="file"/>
      <br/>
      <label for="logo-file">
       Завантажте логотип
      </label>
      <input id="logo-width" max="500" min="50" placeholder="Ширина логотипу (px)" type="number"/>
      <br/>
      <label for="logo-width">
       Ширина логотипу (px)
      </label>
      <input id="favicon-url" placeholder="URL favicon" type="text"/>
      <br/>
      <label for="favicon-url">
       URL favicon
      </label>
      <input accept="image/*" id="favicon-file" type="file"/>
      <br/>
      <label for="favicon-file">
       Завантажте favicon
      </label>
      <button onclick="updateStoreInfo()">
       Зберегти
      </button>
     </div>
     <div class="admin-section">
      <h3>
       Контакти
      </h3>
      <textarea id="contact-phones" placeholder="Телефони"></textarea>
      <br/>
      <label for="contact-phones">
       Телефони (наприклад, +38 (067) 123-45-67)
      </label>
      <textarea id="contact-addresses" placeholder="Адреси"></textarea>
      <br/>
      <label for="contact-addresses">
       Адреси (наприклад, м. Київ, вул. Меблева, 1)
      </label>
      <textarea id="contact-schedule" placeholder="Графік роботи"></textarea>
      <br/>
      <label for="contact-schedule">
       Графік роботи (наприклад, Пн-Пт: 9:00-18:00)
      </label>
      <button onclick="updateContacts()">
       Зберегти
      </button>
     </div>
     <div class="admin-section">
      <h3>
       Соціальні мережі
      </h3>
      <input id="social-url" placeholder="Посилання" type="text"/>
      <br/>
      <label for="social-url">
       URL соцмережі
      </label>
      <select id="social-icon">
       <option value="🔗">
        Загальний (🔗)
       </option>
       <option value="📘">
        Facebook (📘)
       </option>
       <option value="📸">
        Instagram (📸)
       </option>
       <option value="🐦">
        Twitter (🐦)
       </option>
       <option value="▶️">
        YouTube (▶️)
       </option>
       <option value="✈️">
        Telegram (✈️)
       </option>
      </select>
      <br/>
      <label for="social-icon">
       Іконка соцмережі
      </label>
      <button onclick="addSocial()">
       Додати
      </button>
      <br/>
      <label>
       <input id="social-toggle" onchange="toggleSocials()" type="checkbox"/>
       Показувати соціальні мережі
      </label>
      <div id="social-list">
      </div>
     </div>
     <div class="admin-section">
      <h3>
       Про нас
      </h3>
      <div id="about-editor">
      </div>
      <input id="about-edit" type="hidden"/>
      <label for="about-edit">
       Опис "Про нас"
      </label>
      <button onclick="updateAbout()">
       Зберегти
      </button>
     </div>
     <div class="admin-section">
      <h3>
       Категорії
      </h3>
      <input id="cat-name" placeholder="Назва категорії" type="text"/>
      <br/>
      <label for="cat-name">
       Назва категорії
      </label>
      <input id="cat-slug" placeholder="Шлях категорії (наприклад, kuhni)" type="text"/>
      <br/>
      <label for="cat-slug">
       Шлях категорії
      </label>
      <input id="cat-img-url" placeholder="URL картинки (300x200)" type="text"/>
      <br/>
      <label for="cat-img-url">
       URL зображення
      </label>
      <input accept="image/*" id="cat-img-file" type="file"/>
      <br/>
      <label for="cat-img-file">
       Завантажте зображення
      </label>
      <button onclick="addCategory()">
       Додати категорію
      </button>
      <br/>
      <div id="cat-list">
      </div>
      <h4>
       Підкатегорії
      </h4>
      <input id="subcat-name" placeholder="Назва підкатегорії" type="text"/>
      <br/>
      <label for="subcat-name">
       Назва підкатегорії
      </label>
      <input id="subcat-slug" placeholder="Шлях підкатегорії (наприклад, kuhni-naborom)" type="text"/>
      <br/>
      <label for="subcat-slug">
       Шлях підкатегорії
      </label>
      <input id="subcat-img-url" placeholder="URL картинки (150x150)" type="text"/>
      <br/>
      <label for="subcat-img-url">
       URL зображення
      </label>
      <input accept="image/*" id="subcat-img-file" type="file"/>
      <br/>
      <label for="subcat-img-file">
       Завантажте зображення
      </label>
      <select id="subcat-category">
       <option value="">
        Виберіть категорію
       </option>
      </select>
      <br/>
      <label for="subcat-category">
       Категорія для підкатегорії
      </label>
      <button onclick="addSubcategory()">
       Додати підкатегорію
      </button>
     </div>
     <div class="admin-section">
      <h3>
       Налаштування категорій
      </h3>
      <input id="category-width" max="500" min="100" placeholder="Ширина категорії (px, 100-500)" type="number"/>
      <br/>
      <label for="category-width">
       Ширина категорії (px)
      </label>
      <input id="category-height" max="500" min="100" placeholder="Висота категорії (px, 100-500)" type="number"/>
      <br/>
      <label for="category-height">
       Висота категорії (px)
      </label>
      <button onclick="updateCategorySettings()">
       Зберегти налаштування
      </button>
     </div>
     <div class="admin-section">
      <h3>
       Налаштування товарів
      </h3>
      <input id="product-width" max="500" min="200" placeholder="Ширина товару (px, 200-500)" type="number"/>
      <br/>
      <label for="product-width">
       Ширина товару (px)
      </label>
      <input id="product-height" max="500" min="200" placeholder="Висота товару (px, 200-500)" type="number"/>
      <br/>
      <label for="product-height">
       Висота товару (px)
      </label>
      <button onclick="updateProductSettings()">
       Зберегти налаштування
      </button>
     </div>
     <div class="admin-section">
      <h3>
       Фільтри
      </h3>
      <input id="filter-name" placeholder="Назва (англ.)" type="text"/>
      <br/>
      <label for="filter-name">
       Назва фільтру (наприклад, brand)
      </label>
      <input id="filter-label" placeholder="Підпис" type="text"/>
      <br/>
      <label for="filter-label">
       Відображувана назва (наприклад, Виробник)
      </label>
      <input id="filter-options" placeholder="Опції (через кому)" type="text"/>
      <br/>
      <label for="filter-options">
       Опції (наприклад, Дубок, Matroluxe)
      </label>
      <button onclick="addFilter()">
       Додати фільтр
      </button>
      <br/>
      <div id="filter-list-admin">
      </div>
     </div>
     <div class="admin-section">
      <h3>
       Поля замовлення
      </h3>
      <input id="order-field-name" placeholder="Назва (англ.)" type="text"/>
      <br/>
      <label for="order-field-name">
       Назва поля (наприклад, name)
      </label>
      <input id="order-field-label" placeholder="Підпис" type="text"/>
      <br/>
      <label for="order-field-label">
       Відображувана назва (наприклад, Ім'я)
      </label>
      <select id="order-field-type">
       <option value="text">
        Текст
       </option>
       <option value="email">
        Email
       </option>
       <option value="select">
        Вибір
       </option>
      </select>
      <br/>
      <label for="order-field-type">
       Тип поля
      </label>
      <input id="order-field-options" placeholder="Опції (через кому, для select)" type="text"/>
      <br/>
      <label for="order-field-options">
       Опції для вибору (наприклад, Готівкою, Карткою)
      </label>
      <button onclick="addOrderField()">
       Додати поле
      </button>
      <br/>
      <div id="order-field-list">
      </div>
     </div>
     <div class="admin-section">
      <h3>
       Слайдшоу
      </h3>
      <input id="slide-width" max="100" min="10" placeholder="Ширина слайду (%, 10-100)" type="number"/>
      <br/>
      <label for="slide-width">
       Ширина слайду (%)
      </label>
      <input id="slide-height" max="500" min="100" placeholder="Висота слайду (px, 100-500)" type="number"/>
      <br/>
      <label for="slide-height">
       Висота слайду (px)
      </label>
      <input id="slide-interval" placeholder="Інтервал (мс)" type="number"/>
      <br/>
      <label for="slide-interval">
       Інтервал слайдів (мс)
      </label>
      <button onclick="updateSlideshowSettings()">
       Зберегти налаштування
      </button>
      <br/>
      <input id="slide-img-url" placeholder="URL картинки" type="text"/>
      <br/>
      <label for="slide-img-url">
       URL зображення слайду
      </label>
      <input accept="image/*" id="slide-img-file" type="file"/>
      <br/>
      <label for="slide-img-file">
       Завантажте зображення
      </label>
      <input id="slide-title" placeholder="Заголовок слайду" type="text"/>
      <br/>
      <label for="slide-title">
       Заголовок слайду
      </label>
      <input id="slide-text" placeholder="Текст слайду" type="text"/>
      <br/>
      <label for="slide-text">
       Текст слайду
      </label>
      <input id="slide-link" placeholder="Посилання" type="text"/>
      <br/>
      <label for="slide-link">
       Посилання слайду
      </label>
      <input id="slide-link-text" placeholder="Текст посилання" type="text"/>
      <br/>
      <label for="slide-link-text">
       Текст посилання
      </label>
      <input id="slide-order" placeholder="Порядковий номер" type="number"/>
      <br/>
      <label for="slide-order">
       Порядок слайду
      </label>
      <button onclick="addSlide()">
       Додати слайд
      </button>
      <br/>
      <label>
       <input id="slide-toggle" onchange="toggleSlideshow()" type="checkbox"/>
       Показати слайдшоу
      </label>
      <div id="slide-list">
      </div>
     </div>
     <div class="admin-section">
      <h3>
       Бекап
      </h3>
      <div class="backup-group">
       <button onclick="exportSiteBackup()">
        Експортувати (Сайт)
       </button>
       <div class="import-group">
        <input accept=".json" id="import-site-file" style="display: none;" type="file"/>
        <button class="import-btn" onclick="document.getElementById('import-site-file').click()">
         Імпортувати файл (Сайт)
        </button>
       </div>
      </div>
      <div class="backup-group">
       <button onclick="exportProductsBackup()">
        Експортувати (Товари)
       </button>
       <div class="import-group">
        <input accept=".json" id="import-products-file" style="display: none;" type="file"/>
        <button class="import-btn" onclick="document.getElementById('import-products-file').click()">
         Імпортувати файл (Товари)
        </button>
       </div>
      </div>
      <div class="backup-group">
       <button onclick="exportOrdersBackup()">
        Експортувати (Замовлення)
       </button>
       <div class="import-group">
        <input accept=".json" id="import-orders-file" style="display: none;" type="file"/>
        <button class="import-btn" onclick="document.getElementById('import-orders-file').click()">
         Імпортувати файл (Замовлення)
        </button>
       </div>
      </div>
      <div class="backup-group">
       <button onclick="downloadSitemap()">
        Завантажити Sitemap
       </button>
      </div>
     </div>
    </div>
    <div class="admin-tab" id="products">
     <div class="admin-section">
      <h3>
       Товари
      </h3>
      <div class="product-controls">
       <button onclick="openAddProductModal()">
        Додати товар
       </button>
       <div class="sort-menu">
        <button class="sort-btn">
         Сортування ▼
        </button>
        <div class="sort-dropdown">
         <button onclick="sortAdminProducts('id-asc')">
          ID (зростання)
         </button>
         <button onclick="sortAdminProducts('id-desc')">
          ID (спадання)
         </button>
         <button onclick="sortAdminProducts('name-asc')">
          Назва (А-Я)
         </button>
         <button onclick="sortAdminProducts('name-desc')">
          Назва (Я-А)
         </button>
         <button onclick="sortAdminProducts('brand-asc')">
          Виробник (А-Я)
         </button>
         <button onclick="sortAdminProducts('brand-desc')">
          Виробник (Я-А)
         </button>
         <button onclick="sortAdminProducts('price-asc')">
          Ціна (зростання)
         </button>
         <button onclick="sortAdminProducts('price-desc')">
          Ціна (спадання)
         </button>
        </div>
       </div>
       <div class="backup-group">
        <button onclick="exportPrices()">
         Експортувати ціни
        </button>
        <div class="import-group">
         <input accept=".txt,.csv" id="bulk-price-file" style="display: none;" type="file"/>
         <button class="import-btn" onclick="document.getElementById('bulk-price-file').click()">
          Оновити ціни з файлу
         </button>
        </div>
       </div>
      </div>
      <div class="product-admin-item" id="product-list-header">
       <span>
        №
       </span>
       <span>
        Тип
       </span>
       <span>
        Назва
       </span>
       <span>
        Виробник
       </span>
       <span>
        Ціна
       </span>
       <span>
        Акційна ціна
       </span>
       <span>
        Статус
       </span>
      </div>
      <div id="product-list-admin">
      </div>
      <div class="pagination" id="pagination">
      </div>
     </div>
    </div>
    <div class="admin-tab" id="orders">
     <div class="admin-section orders-section">
      <h3>
       Замовлення
      </h3>
      <div class="sort-menu">
       <button class="sort-btn">
        Сортування ▼
       </button>
       <div class="sort-dropdown">
        <button onclick="sortOrders('date-desc')">
         Дата (новіші)
        </button>
        <button onclick="sortOrders('date-asc')">
         Дата (старіші)
        </button>
        <button onclick="sortOrders('total-desc')">
         Сума (спадання)
        </button>
        <button onclick="sortOrders('total-asc')">
         Сума (зростання)
        </button>
        <button onclick="sortOrders('status-asc')">
         Статус (А-Я)
        </button>
        <button onclick="sortOrders('status-desc')">
         Статус (Я-А)
        </button>
       </div>
      </div>
      <div class="filter-options">
       <label>
        Фільтр за статусом:
       </label>
       <select id="order-status-filter" onchange="filterOrders()">
        <option value="">
         Усі статуси
        </option>
        <option value="Нове замовлення">
         Нове замовлення
        </option>
        <option value="В обробці">
         В обробці
        </option>
        <option value="Відправлено">
         Відправлено
        </option>
        <option value="Завершено">
         Завершено
        </option>
       </select>
      </div>
      <div id="order-list">
      </div>
      <div class="pagination" id="order-pagination">
      </div>
     </div>
    </div>
   </div>
   <div class="modal" id="modal">
   </div>
   <div class="resize-modal" id="resize-modal">
    <div class="resize-modal-content">
     <h4>
      Змінити розміри
     </h4>
     <label for="media-width">
      Ширина (px або %):
     </label>
     <input id="media-width" placeholder="Наприклад, 300 або 50%" type="text"/>
     <label for="media-height">
      Висота (px або %):
     </label>
     <input id="media-height" placeholder="Наприклад, 200 або 30%" type="text"/>
     <div class="resize-modal-actions">
      <button onclick="saveMediaSize()">
       Зберегти
      </button>
      <button onclick="closeResizeModal()">
       Скасувати
      </button>
     </div>
    </div>
   </div>
   <div class="notification" id="notification">
   </div>
  </div>
  <script>
let session;
let products = [];
let categories = [];
let orders = [];
let slides = [];
let filters = [{"name":"brand","label":"Виробник","type":"checkbox","options":["Дубок","Matroluxe"]},{"name":"price","label":"Ціна","type":"checkbox","options":["0-2000","2000-5000","5000+"]},{"name":"material","label":"Матеріал","type":"checkbox","options":["Дерево","Пружинний блок"]}];
let orderFields = [{"name":"name","label":"Ім'я","type":"text"},{"name":"surname","label":"Прізвище","type":"text"},{"name":"phone","label":"Телефон","type":"text"},{"name":"email","label":"Email","type":"email"},{"name":"address","label":"Адреса доставки","type":"text"},{"name":"payment","label":"Оплата","type":"select","options":["Готівкою","Безготівковий розрахунок"]}];
let settings;
let currentPage = 1;
const productsPerPage = 20;
const ordersPerPage = 20;
const sessionTimeout = 30 * 60 * 1000;
let inactivityTimer;
let materials = JSON.parse(LZString.decompressFromUTF16(localStorage.getItem('materials')) || '["Дерево", "Пружинний блок", "Метал"]');
let brands = JSON.parse(LZString.decompressFromUTF16(localStorage.getItem('brands')) || '["Гербор", "Matroluxe", "Сокме"]');
let unsavedChanges = false;
let aboutEditor; // Глобальна змінна для редактора
let productEditor; // Додаємо глобальну змінну для редактора товару
let selectedMedia = null; // Додаємо змінну для зберігання вибраного медіа

let ws; // Додаємо змінну для WebSocket

try {
    session = JSON.parse(LZString.decompressFromUTF16(localStorage.getItem('adminSession')) || '{"isActive":false,"timestamp":0}');
} catch (e) {
    console.error('Помилка парсингу session:', e);
    session = { isActive: false, timestamp: 0 };
}

function validateFile(file) {
    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp']; // Додано WebP
    const maxSize = 5 * 1024 * 1024; // 5 MB

    if (!file) {
        return { valid: false, error: 'Файл не вибрано' };
    }

    if (!allowedTypes.includes(file.type)) {
        return { valid: false, error: 'Дозволені лише файли JPEG, PNG, GIF або WebP' };
    }

    if (file.size > maxSize) {
        return { valid: false, error: 'Файл занадто великий. Максимальний розмір — 5 МБ.' };
    }

    return { valid: true };
}

async function uploadFile(file) {
    const token = localStorage.getItem('adminToken');
    if (!token) {
        showNotification('Токен відсутній, будь ласка, увійдіть знову', 'error');
        throw new Error('Токен відсутній');
    }

    const formData = new FormData();
    formData.append('file', file);
    try {
        const response = await fetch('/api/upload', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Помилка завантаження');
        }

        const data = await response.json();
        return data.url;
    } catch (err) {
        console.error('Помилка завантаження файлу:', err);
        showNotification('Не вдалося завантажити файл: ' + err.message, 'error');
        throw err;
    }
}

async function loadInitialData() {
    const token = localStorage.getItem('adminToken');
    if (!token) return;

    const headers = { 'Authorization': `Bearer ${token}` };
    try {
        products = await (await fetch('/api/products', { headers })).json();
        categories = await (await fetch('/api/categories', { headers })).json();
        orders = await (await fetch('/api/orders', { headers })).json();
        settings = await (await fetch('/api/settings', { headers })).json();
        slides = await (await fetch('/api/slides', { headers })).json();

        // Ініціалізація редакторів після завантаження settings
        initializeEditors();
        renderAdmin('products');
        showNotification('Дані завантажено успішно!');
    } catch (err) {
        console.error('Помилка завантаження даних:', err);
        showNotification('Не вдалося завантажити дані', 'error');
        settings = settings || {}; // Ініціалізуємо порожнім об’єктом у разі помилки
    }
}

async function loadProducts() {
    try {
        const token = localStorage.getItem('adminToken');
        if (!token) {
            throw new Error('Токен відсутній. Будь ласка, увійдіть знову.');
        }
        const response = await fetch('/api/products', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        if (!response.ok) {
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('adminToken');
                session = { isActive: false, timestamp: 0 };
                localStorage.setItem('adminSession', LZString.compressToUTF16(JSON.stringify(session)));
                showSection('admin-login');
                showNotification('Сесія закінчилася. Будь ласка, увійдіть знову.');
                return;
            }
            const errorData = await response.json();
            throw new Error(`Не вдалося завантажити товари: ${errorData.error || response.statusText}`);
        }
        products = await response.json();
        // Фільтруємо некоректні продукти
        products = products.filter(p => p && typeof p === 'object' && p.id && p.name);
        renderAdmin('products');
    } catch (e) {
        console.error('Помилка завантаження товарів:', e);
        showNotification(e.message);
        products = [];
        renderAdmin('products'); // Все одно рендеримо, щоб показати повідомлення про відсутність товарів
    }
}

function connectWebSocket() {
    const token = localStorage.getItem('adminToken');
    if (!token) {
        console.error('Токен відсутній, WebSocket не підключено');
        showNotification('Будь ласка, увійдіть знову', 'error');
        return;
    }

    ws = new WebSocket(`${location.protocol === 'https:' ? 'wss:' : 'ws:'}//${location.host}?token=${token}`);
    ws.onopen = () => {
        console.log('Підключено до WebSocket');
        resetInactivityTimer();
    };
    ws.onmessage = (event) => {
        try {
            const { type, data } = JSON.parse(event.data);
            if (type === 'products') {
                products = data;
                renderAdmin('products');
                showNotification('Список товарів оновлено!');
            } else if (type === 'categories') {
                categories = data;
                renderAdmin('site-editing');
                showNotification('Категорії оновлено!');
            } else if (type === 'orders') {
                orders = data;
                renderAdmin('orders');
                showNotification('Замовлення оновлено!');
            } else if (type === 'settings') {
                settings = data;
                renderAdmin('site-editing');
                showNotification('Налаштування оновлено!');
            } else if (type === 'slides') {
                slides = data;
                renderAdmin('site-editing');
                showNotification('Слайди оновлено!');
            }
        } catch (err) {
            console.error('Помилка обробки WebSocket повідомлення:', err);
        }
    };
ws.onerror = (err) => {
    console.error('Помилка WebSocket:', err);
    showNotification('Помилка підключення до WebSocket', 'error');
};
    ws.onclose = () => {
        console.log('WebSocket від’єднано. Спроба перепідключення...');
        setTimeout(connectWebSocket, 5000);
    };
}

loadProducts();

    // Функції для роботи з модальним вікном зміни розмірів
    function openResizeModal(media) {
        // Знітаємо виділення з попереднього елемента
        const previouslySelected = document.querySelector('.quill-media-selected');
        if (previouslySelected) {
            previouslySelected.classList.remove('quill-media-selected');
        }

        // Виділяємо поточний елемент
        media.classList.add('quill-media-selected');
        selectedMedia = media;

        // Отримуємо поточні розміри
        const currentWidth = media.getAttribute('width') || media.style.width || '';
        const currentHeight = media.getAttribute('height') || media.style.height || '';

        // Заповнюємо поля модального вікна
        document.getElementById('media-width').value = currentWidth;
        document.getElementById('media-height').value = currentHeight;

        // Відкриваємо модальне вікно
        const resizeModal = document.getElementById('resize-modal');
        resizeModal.classList.add('active');
        resetInactivityTimer();
    }

    function closeResizeModal() {
        const resizeModal = document.getElementById('resize-modal');
        resizeModal.classList.remove('active');

        // Знітаємо виділення
        if (selectedMedia) {
            selectedMedia.classList.remove('quill-media-selected');
            selectedMedia = null;
        }
        resetInactivityTimer();
    }

function saveMediaSize() {
    if (!selectedMedia) return;

    const width = document.getElementById('media-width').value.trim();
    const height = document.getElementById('media-height').value.trim();

    // Перевіряємо, чи введені значення коректні
    const isValidDimension = (value) => {
        return value === '' || /^\d+(\.\d+)?(%|px)?$/.test(value);
    };

    if (!isValidDimension(width) || !isValidDimension(height)) {
        alert('Введіть коректні розміри (наприклад, 300, 50%, 200px)!');
        return;
    }

    // Застосовуємо розміри
    if (width) {
        selectedMedia.setAttribute('width', width);
        selectedMedia.style.width = width;
        // Для iframe додаємо стиль max-width, щоб уникнути переповнення
        if (selectedMedia.tagName === 'IFRAME') {
            selectedMedia.style.maxWidth = '100%';
        }
    } else {
        selectedMedia.removeAttribute('width');
        selectedMedia.style.width = '';
        if (selectedMedia.tagName === 'IFRAME') {
            selectedMedia.style.maxWidth = '';
        }
    }

    if (height) {
        selectedMedia.setAttribute('height', height);
        selectedMedia.style.height = height;
    } else {
        selectedMedia.removeAttribute('height');
        selectedMedia.style.height = '';
    }

    // Оновлюємо приховане поле з вмістом редактора
    const editorId = selectedMedia.closest('#about-editor') ? 'about-edit' : 'product-description';
    const editor = selectedMedia.closest('#about-editor') ? aboutEditor : document.querySelector('#product-description-editor').__quill;
    document.getElementById(editorId).value = editor.root.innerHTML;

    // Закриваємо модальне вікно
    closeResizeModal();
    unsavedChanges = true;
    resetInactivityTimer();
}

function setDefaultVideoSizes(editor, editorId) {
    const iframes = editor.root.querySelectorAll('iframe');
    iframes.forEach(iframe => {
        if (!iframe.style.width && !iframe.style.height) {
            iframe.style.width = '50%'; // Початкова ширина 50%
            iframe.style.height = '300px'; // Початкова висота
            iframe.style.maxWidth = '100%';
        }
    });
    document.getElementById(editorId).value = editor.root.innerHTML;
    unsavedChanges = true;
}

function initializeEditors() {
    // Перевіряємо, чи елемент існує
    const aboutEditorElement = document.getElementById('about-editor');
    if (!aboutEditorElement) {
        console.error('Елемент #about-editor не знайдено в DOM');
        return;
    }

    aboutEditor = new Quill('#about-editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                ['bold', 'italic', 'underline'],
                [{ 'header': 2 }, { 'header': 3 }],
                ['link', 'image', 'video'],
                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                ['undo', 'redo'], // Додано Undo/Redo
                ['clean']
            ],
            history: {
                delay: 1000,
                maxStack: 100,
                userOnly: true
            }
        }
    });

    // Додаємо обробники для кнопок Undo/Redo
    const aboutToolbar = aboutEditor.getModule('toolbar');
    aboutToolbar.addHandler('undo', () => aboutEditor.history.undo());
    aboutToolbar.addHandler('redo', () => aboutEditor.history.redo());

    // Встановлюємо початковий вміст редактора із settings.about
    if (settings.about) {
        try {
            const delta = aboutEditor.clipboard.convert(settings.about);
            aboutEditor.setContents(delta, 'silent');
            console.log('Вміст редактора "Про нас" успішно встановлено:', settings.about);
        } catch (e) {
            console.error('Помилка при встановленні вмісту редактора "Про нас":', e);
            aboutEditor.setContents([{ insert: settings.about }], 'silent');
        }
    } else {
        aboutEditor.setContents([], 'silent');
        console.log('settings.about порожній, редактор очищено.');
    }
    document.getElementById('about-edit').value = aboutEditor.root.innerHTML;

    // Обробник для оновлення прихованого поля
    aboutEditor.on('text-change', () => {
        const newContent = aboutEditor.root.innerHTML;
        document.getElementById('about-edit').value = newContent;
        console.log('Вміст редактора змінено:', newContent);
        unsavedChanges = true;
    });

    // Обробник кліків для зображень і відео
    aboutEditor.root.addEventListener('click', (e) => {
        const target = e.target;
        if (target.tagName === 'IMG' || target.tagName === 'IFRAME') {
            openResizeModal(target);
        }
    });

    // Обробник вставки зображень через копіювання/вставку
    aboutEditor.clipboard.addMatcher(Node.ELEMENT_NODE, (node, delta) => {
        if (node.tagName === 'IMG') {
            const src = node.getAttribute('src');
            if (src) {
                return { ops: [{ insert: { image: src } }] };
            }
        }
        return delta;
    });

    // Функція для додавання обробників кнопок Undo і Redo
    function addToolbarEventListeners() {
        const toolbar = document.querySelector('#about-editor').previousElementSibling;
        if (toolbar && toolbar.classList.contains('ql-toolbar')) {
            const undoButton = toolbar.querySelector('.ql-undo');
            const redoButton = toolbar.querySelector('.ql-redo');
            if (undoButton) {
                undoButton.addEventListener('click', () => {
                    aboutEditor.history.undo();
                });
            }
            if (redoButton) {
                redoButton.addEventListener('click', () => {
                    aboutEditor.history.redo();
                });
            }
        } else {
            console.error('Панель інструментів для aboutEditor не знайдена');
        }
    }

    // Виконуємо негайно, якщо документ уже завантажений, або чекаємо події
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setTimeout(addToolbarEventListeners, 100);
    } else {
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(addToolbarEventListeners, 100);
        });
    }
}

function initializeProductEditor(description = '', descriptionDelta = null) {
    // Ініціалізуємо Quill редактор
productEditor = new Quill('#product-description-editor', {
    theme: 'snow',
    modules: {
        toolbar: [
            ['bold', 'italic', 'underline'],
            [{ 'header': 2 }, { 'header': 3 }],
            ['link', 'image', 'video'],
            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
            ['undo', 'redo'], // Додано Undo/Redo
            ['clean']
        ],
        history: {
            delay: 1000,
            maxStack: 100,
            userOnly: true
        }
    }
});

// Додаємо обробники для кнопок Undo/Redo
const productToolbar = productEditor.getModule('toolbar');
productToolbar.addHandler('undo', () => productEditor.history.undo());
productToolbar.addHandler('redo', () => productEditor.history.redo());

    // Встановлюємо вміст редактора
    if (descriptionDelta) {
        productEditor.setContents(descriptionDelta, 'silent');
    } else if (description) {
        try {
            const delta = productEditor.clipboard.convert(description);
            productEditor.setContents(delta, 'silent');
        } catch (e) {
            console.error('Помилка при встановленні вмісту редактора товару:', e);
            productEditor.setContents([{ insert: description }], 'silent');
        }
    } else {
        productEditor.setContents([], 'silent');
    }
    document.getElementById('product-description').value = productEditor.root.innerHTML;

    const toolbar = productEditor.getModule('toolbar');
    toolbar.addHandler('image', async () => {
        const input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.setAttribute('accept', 'image/jpeg,image/png,image/gif,image/webp');
        input.click();
        input.onchange = async () => {
            const file = input.files[0];
            if (file) {
                const validation = validateFile(file);
                if (!validation.valid) {
                    showNotification(validation.error);
                    return;
                }
                try {
                    const url = await uploadFile(file);
                    const range = productEditor.getSelection() || { index: 0 };
                    productEditor.insertEmbed(range.index, 'image', url);
                    setDefaultVideoSizes(productEditor, 'product-description');
                } catch (err) {
                    // Помилка вже оброблена в uploadFile
                }
            }
        };
    });

    // Додаємо обробник для вставки відео
    toolbar.addHandler('video', () => {
        let url = prompt('Введіть URL відео (наприклад, https://www.youtube.com/watch?v=VIDEO_ID або https://www.youtube.com/embed/VIDEO_ID):');
        if (url) {
            // Перетворюємо URL у формат embed
            const watchRegex = /^(https?:\/\/)?(www\.)?youtube\.com\/watch\?v=([^\s&]+)/;
            const embedRegex = /^(https?:\/\/)?(www\.)?youtube\.com\/embed\/([^\s]+)/;
            const shortRegex = /^(https?:\/\/)?youtu\.be\/([^\s]+)/;

            let videoId = null;

            // Перевіряємо формат watch?v=
            if (watchRegex.test(url)) {
                const match = url.match(watchRegex);
                videoId = match[3];
                url = `https://www.youtube.com/embed/${videoId}`;
            }
            // Перевіряємо формат embed
            else if (embedRegex.test(url)) {
                const match = url.match(embedRegex);
                videoId = match[3];
                url = `https://www.youtube.com/embed/${videoId}`;
            }
            // Перевіряємо формат youtu.be
            else if (shortRegex.test(url)) {
                const match = url.match(shortRegex);
                videoId = match[2];
                url = `https://www.youtube.com/embed/${videoId}`;
            }
            else {
                showNotification('Введіть коректний URL для YouTube відео (наприклад, https://www.youtube.com/watch?v=VIDEO_ID або https://www.youtube.com/embed/VIDEO_ID)');
                return;
            }

            const range = productEditor.getSelection() || { index: 0 };
            productEditor.insertEmbed(range.index, 'video', url);
            setDefaultVideoSizes(productEditor, 'product-description');
        }
    });

    // Обробник для оновлення прихованого поля
    productEditor.on('text-change', () => {
        document.getElementById('product-description').value = productEditor.root.innerHTML;
        unsavedChanges = true;
    });

    // Обробник кліків для зображень і відео
    productEditor.root.addEventListener('click', (e) => {
        const target = e.target;
        if (target.tagName === 'IMG' || target.tagName === 'IFRAME') {
            openResizeModal(target);
        }
    });

    // Обробник вставки зображень через копіювання/вставку
    productEditor.clipboard.addMatcher(Node.ELEMENT_NODE, (node, delta) => {
        if (node.tagName === 'IMG') {
            const src = node.getAttribute('src');
            if (src) {
                return { ops: [{ insert: { image: src } }] };
            }
        }
        return delta;
    });

    // Додаємо обробники для кнопок "Undo" і "Redo"
    setTimeout(() => {
        const toolbar = document.querySelector('#product-description-editor').previousElementSibling;
        if (toolbar && toolbar.classList.contains('ql-toolbar')) {
            const undoButton = toolbar.querySelector('.ql-undo');
            const redoButton = toolbar.querySelector('.ql-redo');
            if (undoButton) {
                undoButton.addEventListener('click', () => {
                    productEditor.history.undo();
                });
            }
            if (redoButton) {
                redoButton.addEventListener('click', () => {
                    productEditor.history.redo();
                });
            }
        } else {
            console.error('Панель інструментів для productEditor не знайдена');
        }
    }, 100);
}

    function showSection(sectionId) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        const section = document.getElementById(sectionId);
        if (section) {
            section.classList.add('active');
            if (sectionId === 'admin-panel') renderAdmin();
        }
    }

async function login() {
    const username = document.getElementById('admin-username').value;
    const password = document.getElementById('admin-password').value;

    try {
        const response = await fetch('/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });

        const data = await response.json();
        if (!response.ok || !data.success) {
            throw new Error(data.error || 'Помилка входу');
        }

        localStorage.setItem('adminToken', data.token);
        session = { isActive: true, timestamp: Date.now() };
        localStorage.setItem('adminSession', LZString.compressToUTF16(JSON.stringify(session)));
        showSection('admin-panel');
        loadInitialData();
        connectWebSocket();
        showNotification('Вхід виконано успішно!');
    } catch (err) {
        console.error('Помилка входу:', err);
        showNotification('Не вдалося увійти: ' + err.message, 'error');
    }
}

    document.getElementById('admin-password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            login();
        }
    });
    document.getElementById('admin-username').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('admin-password').focus();
        }
    });

function logout() {
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.close();
    }
    localStorage.removeItem('adminToken');
    session = { isActive: false, timestamp: 0 };
    localStorage.setItem('adminSession', LZString.compressToUTF16(JSON.stringify(session)));
    showSection('admin-login');
    clearTimeout(inactivityTimer);
    showNotification('Ви вийшли з системи!');
}

    function showNotification(message) {
        const notification = document.getElementById('notification');
        if (notification) {
            notification.textContent = message;
            notification.classList.add('active');
            setTimeout(() => notification.classList.remove('active'), 5000);
        }
    }

    function resetInactivityTimer() {
        clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(() => {
            logout();
            showNotification('Сесію завершено через 30 хвилин бездіяльності');
        }, sessionTimeout);
    }

    function showAdminTab(tabId) {
        document.querySelectorAll('.admin-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        const tab = document.getElementById(tabId);
        const button = Array.from(document.querySelectorAll('.tab-btn')).find(btn => btn.getAttribute('onclick') === `showAdminTab('${tabId}')`);
        if (tab && button) {
            tab.classList.add('active');
            button.classList.add('active');
            currentPage = 1;
            renderAdmin(tabId);
            resetInactivityTimer();
        }
    }

async function updateStoreInfo() {
    const name = document.getElement }ById('store-name').value;
    const baseUrl = document.getElementById('base-url').value;
    const logoUrl = document.getElementById('logo-url').value;
    const logoWidth = parseInt(document.getElementById('logo-width').value) || (settings?.logo?.width ?? 100); // Дефолтне значення 100
    const faviconUrl = document.getElementById('favicon-url').value;

    const token = localStorage.getItem('adminToken');
    if (!token) {
        showNotification('Токен відсутній. Будь ласка, увійдіть знову.');
        return;
    }

    const logoFile = document.getElementById('logo-file').files[0];
    const faviconFile = document.getElementById('favicon-file').files[0];
    let finalLogoUrl = logoUrl;
    let finalFaviconUrl = faviconUrl;

    try {
        if (logoFile) {
            const validation = validateFile(logoFile);
            if (!validation.valid) {
                showNotification(validation.error);
                return;
            }
            finalLogoUrl = await uploadFile(logoFile);
        }
        if (faviconFile) {
            const validation = validateFile(faviconFile);
            if (!validation.valid) {
                showNotification(validation.error);
                return;
            }
            finalFaviconUrl = await uploadFile(faviconFile);
        }

        const updatedSettings = {
            ...settings,
            name: name || settings?.name || '',
            baseUrl: baseUrl || settings?.baseUrl || '',
            logo: { url: finalLogoUrl || settings?.logo?.url || '', width: logoWidth },
            favicon: finalFaviconUrl || settings?.favicon || ''
        };

        const response = await fetch('/api/settings', {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updatedSettings)
        });

        if (!response.ok) throw new Error('Не вдалося оновити налаштування');
        settings = await response.json();
        showNotification('Налаштування збережено!');
        resetInactivityTimer();
    } catch (err) {
        console.error('Помилка оновлення налаштувань:', err);
        showNotification('Не вдалося зберегти налаштування');
    }
}

    function updateContacts() {
        const phones = document.getElementById('contact-phones').value;
        const addresses = document.getElementById('contact-addresses').value;
        const schedule = document.getElementById('contact-schedule').value;

        settings.contacts.phones = phones;
        settings.contacts.addresses = addresses;
        settings.contacts.schedule = schedule;

        localStorage.setItem('settings', LZString.compressToUTF16(JSON.stringify(settings)));
        renderAdmin();
        showNotification('Контакти збережено!');
        unsavedChanges = false;
        resetInactivityTimer();
    }

    function addSocial() {
        const url = document.getElementById('social-url').value;
        const icon = document.getElementById('social-icon').value;

        if (url) {
            settings.socials.push({ url, icon });
            localStorage.setItem('settings', LZString.compressToUTF16(JSON.stringify(settings)));
            document.getElementById('social-url').value = '';
            renderAdmin();
            showNotification('Соцмережу додано!');
            unsavedChanges = false;
            resetInactivityTimer();
        } else {
            alert('Введіть URL соцмережі!');
        }
    }

    function editSocial(index) {
        const url = prompt('Введіть новий URL соцмережі:', settings.socials[index].url);
        if (url) {
            settings.socials[index].url = url;
            localStorage.setItem('settings', LZString.compressToUTF16(JSON.stringify(settings)));
            renderAdmin();
            showNotification('Соцмережу відредаговано!');
            unsavedChanges = false;
            resetInactivityTimer();
        }
    }

    function deleteSocial(index) {
        if (confirm('Ви впевнені, що хочете видалити цю соцмережу?')) {
            settings.socials.splice(index, 1);
            localStorage.setItem('settings', LZString.compressToUTF16(JSON.stringify(settings)));
            renderAdmin();
            showNotification('Соцмережу видалено!');
            unsavedChanges = false;
            resetInactivityTimer();
        }
    }

    function toggleSocials() {
        settings.showSocials = document.getElementById('social-toggle').checked;
        localStorage.setItem('settings', LZString.compressToUTF16(JSON.stringify(settings)));
        renderAdmin();
        showNotification('Налаштування соцмереж збережено!');
        unsavedChanges = false;
        resetInactivityTimer();
    }

    function formatText(command) {
        const textarea = document.getElementById('about-edit');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selectedText = textarea.value.substring(start, end);
        let newText = '';

        if (command === 'bold') {
            newText = `<b>${selectedText}</b>`;
        } else if (command === 'italic') {
            newText = `<i>${selectedText}</i>`;
        } else if (command === 'underline') {
            newText = `<u>${selectedText}</u>`;
        } else if (command === 'h2') {
            newText = `<h2>${selectedText}</h2>`;
        } else if (command === 'p') {
            newText = `<p>${selectedText}</p>`;
        }

        textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
        unsavedChanges = true;
        resetInactivityTimer();
    }

function updateAbout() {
    const aboutDelta = aboutEditor.getContents(); // Отримуємо Delta-формат
    const aboutHTML = aboutEditor.root.innerHTML; // Отримуємо HTML для сумісності
    settings.about = aboutHTML; // Зберігаємо HTML
    settings.aboutDelta = aboutDelta; // Зберігаємо Delta (опціонально)
    try {
        localStorage.setItem('settings', LZString.compressToUTF16(JSON.stringify(settings)));
        console.log('settings.about успішно збережено в localStorage:', settings.about);
    } catch (e) {
        console.error('Помилка при збереженні settings в localStorage:', e);
    }
    renderAdmin();
    showNotification('Опис "Про нас" збережено!');
    unsavedChanges = false;
    resetInactivityTimer();
}

function renderAdmin(activeTab = 'site-editing') {
    // Додаємо управління вкладками
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.admin-tab').forEach(tab => tab.classList.remove('active'));
    const tabBtn = document.querySelector(`.tab-btn[onclick="showAdminTab('${activeTab}')"]`);
    if (tabBtn) tabBtn.classList.add('active');
    const activeTabElement = document.getElementById(activeTab);
    if (activeTabElement) activeTabElement.classList.add('active');

    const storeName = document.getElementById('store-name');
    if (storeName) storeName.value = settings.name || '';
    const baseUrl = document.getElementById('base-url');
    if (baseUrl) baseUrl.value = settings.baseUrl || '';
    const logoUrl = document.getElementById('logo-url');
    if (logoUrl) logoUrl.value = settings.logo || '';
    const logoWidth = document.getElementById('logo-width');
    if (logoWidth) logoWidth.value = settings.logoWidth || 150;
    const faviconUrl = document.getElementById('favicon-url');
    if (faviconUrl) faviconUrl.value = settings.favicon || '';
    const contactPhones = document.getElementById('contact-phones');
    if (contactPhones) contactPhones.value = settings.contacts.phones || '';
    const contactAddresses = document.getElementById('contact-addresses');
    if (contactAddresses) contactAddresses.value = settings.contacts.addresses || '';
    const contactSchedule = document.getElementById('contact-schedule');
    if (contactSchedule) contactSchedule.value = settings.contacts.schedule || '';

    // Оновлення редактора "Про нас"
    if (document.getElementById('about-editor')) {
        if (!aboutEditor) {
            initializeEditors();
        }
        // Використовуємо setContents для коректного оновлення вмісту
        if (settings.aboutDelta) {
            aboutEditor.setContents(settings.aboutDelta, 'silent');
        } else if (settings.about) {
            try {
                const delta = aboutEditor.clipboard.convert(settings.about);
                aboutEditor.setContents(delta, 'silent');
            } catch (e) {
                aboutEditor.setContents([{ insert: settings.about }], 'silent');
            }
        } else {
            aboutEditor.setContents([], 'silent');
        }
        document.getElementById('about-edit').value = aboutEditor.root.innerHTML;
    } else if (document.getElementById('about-edit')) {
        document.getElementById('about-edit').value = settings.about || '';
    }

    const socialToggle = document.getElementById('social-toggle');
    if (socialToggle) socialToggle.checked = settings.showSocials || false;
    const slideToggle = document.getElementById('slide-toggle');
    if (slideToggle) slideToggle.checked = settings.showSlides || false;
    const slideWidth = document.getElementById('slide-width');
    if (slideWidth) slideWidth.value = settings.slideWidth || 75;
    const slideHeight = document.getElementById('slide-height');
    if (slideHeight) slideHeight.value = settings.slideHeight || 200;
    const slideInterval = document.getElementById('slide-interval');
    if (slideInterval) slideInterval.value = settings.slideInterval || 3000;
    const categoryWidth = document.getElementById('category-width');
    if (categoryWidth) categoryWidth.value = settings.categoryWidth || 200;
    const categoryHeight = document.getElementById('category-height');
    if (categoryHeight) categoryHeight.value = settings.categoryHeight || 150;
    const productWidth = document.getElementById('product-width');
    if (productWidth) productWidth.value = settings.productWidth || 300;
    const productHeight = document.getElementById('product-height');
    if (productHeight) productHeight.value = settings.productHeight || 280;

    const socialList = document.getElementById('social-list');
    if (socialList) {
        socialList.innerHTML = settings.socials.map((social, index) => `
            <div class="social-item">
                <span class="social-icon">${social.icon || '🔗'}</span> ${social.url}
                <button class="edit-btn" onclick="editSocial(${index})">Редагувати</button>
                <button class="delete-btn" onclick="deleteSocial(${index})">Видалити</button>
            </div>
        `).join('');
    }

    const catList = document.getElementById('cat-list');
    if (catList) {
        catList.innerHTML = categories.map((c, index) => `
            <div class="category-item">
                <button class="move-btn" onclick="moveCategoryUp(${index})" ${index === 0 ? 'disabled' : ''}>↑</button>
                <button class="move-btn" onclick="moveCategoryDown(${index})" ${index === categories.length - 1 ? 'disabled' : ''}>↓</button>
                ${c.name} (${c.slug}) 
                <button class="edit-btn" onclick="editCategory('${c.name}')">Редагувати</button> 
                <button class="delete-btn" onclick="deleteCategory('${c.name}')">Видалити</button>
            </div>
            <div class="subcat-list">
                ${(c.subcategories || []).map((sub, subIndex) => `
                    <p>
                        <button class="move-btn" onclick="moveSubcategoryUp('${c.name}', ${subIndex})" ${subIndex === 0 ? 'disabled' : ''}>↑</button>
                        <button class="move-btn" onclick="moveSubcategoryDown('${c.name}', ${subIndex})" ${subIndex === (c.subcategories.length - 1) ? 'disabled' : ''}>↓</button>
                        ${sub.name} (${sub.slug}) 
                        <button class="edit-btn" onclick="editSubcategory('${c.name}', '${sub.name}')">Редагувати</button> 
                        <button class="delete-btn" onclick="deleteSubcategory('${c.name}', '${sub.name}')">Видалити</button>
                    </p>
                `).join('')}
            </div>
        `).join('');
    }

    const filterList = document.getElementById('filter-list-admin');
    if (filterList) {
        filterList.innerHTML = filters.map((f, index) => `
            <p>
                <button class="move-btn" onclick="moveFilterUp(${index})" ${index === 0 ? 'disabled' : ''}>↑</button>
                <button class="move-btn" onclick="moveFilterDown(${index})" ${index === filters.length - 1 ? 'disabled' : ''}>↓</button>
                ${f.label} (${f.options.sort().join(', ')}) 
                <button class="edit-btn" onclick="editFilter('${f.name}')">Редагувати</button> 
                <button class="delete-btn" onclick="deleteFilter('${f.name}')">Видалити</button>
            </p>
        `).join('');
    }

    const orderFieldList = document.getElementById('order-field-list');
    if (orderFieldList) {
        orderFieldList.innerHTML = orderFields.map(f => `
            <p>${f.label} (${f.type}${f.options ? `: ${f.options.join(', ')}` : ''}) 
                <button class="edit-btn" onclick="editOrderField('${f.name}')">Редагувати</button> 
                <button class="delete-btn" onclick="deleteOrderField('${f.name}')">Видалити</button>
            </p>
        `).join('');
    }

    const slideList = document.getElementById('slide-list');
    if (slideList) {
        slideList.innerHTML = slides.map(s => `
            <p>Слайд #${s.order} 
                <button class="edit-btn" onclick="editSlide(${s.order})">Редагувати</button>
                <button class="delete-btn" onclick="deleteSlide(${s.order})">Видалити</button>
            </p>
        `).join('');
    }

    const subcatSelect = document.getElementById('subcat-category');
    if (subcatSelect) {
        subcatSelect.innerHTML = '<option value="">Виберіть категорію</option>' + 
            categories.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
    }

    if (activeTab === 'products') {
        const productList = document.getElementById('product-list-admin');
        if (productList) {
            // Фільтруємо продукти, щоб уникнути undefined або некоректних об’єктів
            const validProducts = products.filter(p => p && typeof p === 'object' && p.id && p.name);
            if (validProducts.length > 0) {
                const start = (currentPage - 1) * productsPerPage;
                const end = start + productsPerPage;
                const paginatedProducts = validProducts.slice(start, end);
                productList.innerHTML = paginatedProducts.map(p => {
                    const saleInfo = p.salePrice ? `<s>${p.price || ''} грн</s> ${p.salePrice} грн ${renderCountdown(p)}` : `${p.price || ''} грн`;
                    const type = p.type || 'simple';
                    let priceDisplay;
                    if (type === 'mattresses') {
                        priceDisplay = p.sizes && Array.isArray(p.sizes) && p.sizes.length > 0 ? Math.min(...p.sizes.map(s => s.price || Infinity)) + ' грн' : 'Н/Д';
                    } else if (type === 'group') {
                        priceDisplay = p.groupProducts && Array.isArray(p.groupProducts) && p.groupProducts.length > 0 ? Math.min(...p.groupProducts.map(pid => {
                            const prod = validProducts.find(pr => pr.id === pid); // Змінено products на validProducts
                            return prod ? (prod.price || Infinity) : Infinity;
                        })) + ' грн' : 'Н/Д';
                    } else {
                        priceDisplay = p.price ? p.price + ' грн' : 'Н/Д';
                    }
                    const salePriceDisplay = p.salePrice ? `${p.salePrice} грн` : '';
                    const visibilityStatus = p.visible ? 'Видимість: Так' : 'Видимість: Ні';
                    return `
                        <div class="product-admin-item">
                            <span>#${p.id}</span>
                            <span>${type}</span>
                            <span>${p.name} (${p.slug || 'без шляху'})</span>
                            <span>${p.brand || 'Без бренду'}</span>
                            <span>${priceDisplay}</span>
                            <span>${salePriceDisplay}</span>
                            <div class="status-column" title="${visibilityStatus}">
                                <div class="buttons">
                                    <button class="edit-btn" onclick="openEditProductModal(${p.id})">Редагувати</button>
                                    <button class="delete-btn" onclick="deleteProduct(${p.id})">Видалити</button>
                                    <button class="toggle-btn" onclick="toggleProductActive(${p.id})">${p.active ? 'Деактивувати' : 'Активувати'}</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                renderPagination(validProducts.length, productsPerPage, 'pagination', currentPage);
            } else {
                productList.innerHTML = '<p>Немає товарів для відображення.</p>';
            }
        }
    }

    if (activeTab === 'orders') {
        const statusFilter = document.getElementById('order-status-filter')?.value || '';
        let filteredOrders = [...orders];
        if (statusFilter) {
            filteredOrders = filteredOrders.filter(o => o.status === statusFilter);
        }
        const start = (currentPage - 1) * ordersPerPage;
        const end = start + ordersPerPage;
        const paginatedOrders = filteredOrders.slice(start, end);
        const orderList = document.getElementById('order-list');
        orderList.innerHTML = paginatedOrders.map((o, index) => {
            const orderDate = new Date(o.date);
            const formattedDate = orderDate.toLocaleString('uk-UA', {
                timeZone: settings.timezone || 'Europe/Kyiv',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            return `
                <div class="order-item">
                    <span>#${start + index + 1} ${formattedDate} - ${o.total} грн (${o.status})</span>
                    <div>
                        <button class="edit-btn" onclick="viewOrder(${orders.indexOf(o)})">Переглянути</button>
                        <button class="toggle-btn" onclick="changeOrderStatus(${orders.indexOf(o)})">Змінити статус</button>
                        <button class="delete-btn" onclick="deleteOrder(${orders.indexOf(o)})">Видалити</button>
                    </div>
                </div>
            `;
        }).join('');
        renderPagination(filteredOrders.length, ordersPerPage, 'order-pagination', currentPage);
    }
}

    function renderPagination(totalItems, itemsPerPage, containerId, currentPage) {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        if (totalPages <= 1) return;

        if (currentPage > 1) {
            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'Попередня';
            prevBtn.onclick = () => { currentPage--; renderAdmin(containerId === 'pagination' ? 'products' : 'orders'); };
            container.appendChild(prevBtn);
        }

        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement('button');
            btn.textContent = i;
            btn.className = i === currentPage ? 'active' : '';
            btn.onclick = () => { currentPage = i; renderAdmin(containerId === 'pagination' ? 'products' : 'orders'); };
            container.appendChild(btn);
        }

        if (currentPage < totalPages) {
            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Наступна';
            nextBtn.onclick = () => { currentPage++; renderAdmin(containerId === 'pagination' ? 'products' : 'orders'); };
            container.appendChild(nextBtn);
        }
    }

function closeModal() {
    const modal = document.getElementById('modal');
    modal.classList.remove('active');
    modal.innerHTML = '';

    // Закриваємо модальне вікно зміни розмірів, якщо воно відкрите
    closeResizeModal();
    resetInactivityTimer();
}

    function slugify(text) {
    return text
        .toLowerCase()
        .replace(/[^a-z0-9-]/g, '-') // Замінюємо небажані символи на дефіс
        .replace(/-+/g, '-') // Замінюємо кілька дефісів на один
        .replace(/^-|-$/g, ''); // Видаляємо дефіси на початку і в кінці
}

async function addCategory() {
    const name = document.getElementById('cat-name').value;
    let slug = document.getElementById('cat-slug').value;
    const img = document.getElementById('cat-img-url').value || 'https://via.placeholder.com/300x200';

    if (!name || !slug) {
        alert('Введіть назву та шлях категорії!');
        return;
    }

    // Очищаємо slug
    slug = slugify(slug);

    // Перевіряємо унікальність slug
    const token = localStorage.getItem('adminToken');
    try {
        const response = await fetch(`/api/categories?slug=${slug}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const existingCategories = await response.json();
        if (existingCategories.some(c => c.slug === slug)) {
            alert('Шлях категорії має бути унікальним!');
            return;
        }
    } catch (err) {
        showNotification('Помилка перевірки унікальності шляху: ' + err.message);
        return;
    }

    const category = { name, slug, img, subcategories: [] };
    try {
        const response = await fetch('/api/categories', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(category)
        });
        if (!response.ok) throw new Error('Не вдалося додати категорію');
        categories.push(category);
        renderCategoriesAdmin();
        document.getElementById('cat-name').value = '';
        document.getElementById('cat-slug').value = '';
        document.getElementById('cat-img-url').value = '';
        document.getElementById('cat-img-file').value = '';
        showNotification('Категорію додано!');
    } catch (err) {
        showNotification('Не вдалося додати категорію: ' + err.message);
    }
}

    function editCategory(name) {
        const category = categories.find(c => c.name === name);
        if (category) {
            const modal = document.getElementById('modal');
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>Редагувати категорію</h3>
                    <input type="text" id="edit-cat-name" value="${category.name}"><br/>
                    <label for="edit-cat-name">Назва категорії</label>
                    <input type="text" id="edit-cat-slug" value="${category.slug}"><br/>
                    <label for="edit-cat-slug">Шлях категорії</label>
                    <input type="text" id="edit-cat-img-url" value="${category.img || ''}"><br/>
                    <label for="edit-cat-img-url">URL зображення</label>
                    <input type="file" id="edit-cat-img-file" accept="image/*"><br/>
                    <label for="edit-cat-img-file">Завантажте зображення</label>
                    ${category.img ? `<img src="${category.img}" style="max-width: 100px;">` : ''}
                    <div class="modal-actions">
                        <button id="save-cat-btn">Зберегти</button>
                        <button id="cancel-cat-btn">Скасувати</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
            document.getElementById('save-cat-btn').addEventListener('click', () => saveCategoryEdit(name));
            document.getElementById('cancel-cat-btn').addEventListener('click', closeModal);
            resetInactivityTimer();
        }
    }

    function saveCategoryEdit(oldName) {
        const category = categories.find(c => c.name === oldName);
        if (category) {
            const newName = document.getElementById('edit-cat-name').value;
            const newSlug = document.getElementById('edit-cat-slug').value;
            const newImgUrl = document.getElementById('edit-cat-img-url').value;
            const newImgFile = document.getElementById('edit-cat-img-file').files[0];

            if (newName && newSlug) {
                if (categories.some(c => c.slug === newSlug && c.name !== oldName)) {
                    alert('Шлях категорії має бути унікальним!');
                    return;
                }
                category.name = newName;
                category.slug = newSlug;
                if (newImgUrl) category.img = newImgUrl;

                if (newImgFile) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        category.img = e.target.result;
                        updateProductsCategory(oldName, newName);
                        localStorage.setItem('categories', LZString.compressToUTF16(JSON.stringify(categories)));
                        localStorage.setItem('products', LZString.compressToUTF16(JSON.stringify(products)));
                        closeModal();
                        renderAdmin();
                        showNotification('Категорію відредаговано!');
                        unsavedChanges = false;
                        resetInactivityTimer();
                    };
                    reader.readAsDataURL(newImgFile);
                } else {
                    updateProductsCategory(oldName, newName);
                    localStorage.setItem('categories', LZString.compressToUTF16(JSON.stringify(categories)));
                    localStorage.setItem('products', LZString.compressToUTF16(JSON.stringify(products)));
                    closeModal();
                    renderAdmin();
                    showNotification('Категорію відредаговано!');
                    unsavedChanges = false;
                    resetInactivityTimer();
                }
            } else {
                alert('Введіть назву та шлях!');
            }
        }
    }

    function updateProductsCategory(oldName, newName) {
        products.forEach(p => {
            if (p.category === oldName) p.category = newName;
        });
    }

    function deleteCategory(name) {
        if (confirm('Ви впевнені, що хочете видалити цю категорію?')) {
            categories = categories.filter(c => c.name !== name);
            products.forEach(p => {
                if (p.category === name) {
                    p.category = '';
                    p.subcategory = '';
                }
            });
            localStorage.setItem('categories', LZString.compressToUTF16(JSON.stringify(categories)));
            localStorage.setItem('products', LZString.compressToUTF16(JSON.stringify(products)));
            renderAdmin();
            showNotification('Категорію видалено!');
            unsavedChanges = false;
            resetInactivityTimer();
        }
    }

    function moveCategoryUp(index) {
        if (index > 0) {
            [categories[index - 1], categories[index]] = [categories[index], categories[index - 1]];
            localStorage.setItem('categories', LZString.compressToUTF16(JSON.stringify(categories)));
            renderAdmin();
            resetInactivityTimer();
        }
    }

    function moveCategoryDown(index) {
        if (index < categories.length - 1) {
            [categories[index], categories[index + 1]] = [categories[index + 1], categories[index]];
            localStorage.setItem('categories', LZString.compressToUTF16(JSON.stringify(categories)));
            renderAdmin();
            resetInactivityTimer();
        }
    }

async function addSubcategory() {
    const name = document.getElementById('subcat-name').value;
    let slug = document.getElementById('subcat-slug').value;
    const img = document.getElementById('subcat-img-url').value || 'https://via.placeholder.com/150x150';
    const categoryName = document.getElementById('subcat-category').value;

    if (!name || !slug || !categoryName) {
        alert('Введіть назву, шлях підкатегорії та виберіть категорію!');
        return;
    }

    // Очищаємо slug
    slug = slugify(slug);

    const category = categories.find(c => c.name === categoryName);
    if (!category) {
        alert('Категорію не знайдено!');
        return;
    }

    // Перевіряємо унікальність slug у межах категорії
    if (category.subcategories.some(s => s.slug === slug)) {
        alert('Шлях підкатегорії має бути унікальним у межах цієї категорії!');
        return;
    }

    const subcategory = { name, slug, img };
    category.subcategories.push(subcategory);

    const token = localStorage.getItem('adminToken');
    try {
        const response = await fetch(`/api/categories/${category.slug}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(category)
        });
        if (!response.ok) throw new Error('Не вдалося додати підкатегорію');
        renderCategoriesAdmin();
        document.getElementById('subcat-name').value = '';
        document.getElementById('subcat-slug').value = '';
        document.getElementById('subcat-img-url').value = '';
        document.getElementById('subcat-img-file').value = '';
        showNotification('Підкатегорію додано!');
    } catch (err) {
        showNotification('Не вдалося додати підкатегорію: ' + err.message);
    }
}

    function editSubcategory(categoryName, subcatName) {
        const category = categories.find(c => c.name === categoryName);
        if (category) {
            const subcategory = category.subcategories.find(s => s.name === subcatName);
            if (subcategory) {
                const modal = document.getElementById('modal');
                modal.innerHTML = `
                    <div class="modal-content">
                        <h3>Редагувати підкатегорію</h3>
                        <input type="text" id="edit-subcat-name" value="${subcategory.name}"><br/>
                        <label for="edit-subcat-name">Назва підкатегорії</label>
                        <input type="text" id="edit-subcat-slug" value="${subcategory.slug}"><br/>
                        <label for="edit-subcat-slug">Шлях підкатегорії</label>
                        <input type="text" id="edit-subcat-img-url" value="${subcategory.img || ''}"><br/>
                        <label for="edit-subcat-img-url">URL зображення</label>
                        <input type="file" id="edit-subcat-img-file" accept="image/*"><br/>
                        <label for="edit-subcat-img-file">Завантажте зображення</label>
                        ${subcategory.img ? `<img src="${subcategory.img}" style="max-width: 100px;">` : ''}
                        <div class="modal-actions">
                            <button id="save-subcat-btn">Зберегти</button>
                            <button id="cancel-subcat-btn">Скасувати</button>
                        </div>
                    </div>
                `;
                modal.classList.add('active');
                document.getElementById('save-subcat-btn').addEventListener('click', () => saveSubcategoryEdit(categoryName, subcatName));
                document.getElementById('cancel-subcat-btn').addEventListener('click', closeModal);
                resetInactivityTimer();
            }
        }
    }

    function saveSubcategoryEdit(categoryName, oldName) {
        const category = categories.find(c => c.name === categoryName);
        if (category) {
            const subcategory = category.subcategories.find(s => s.name === oldName);
            if (subcategory) {
                const newName = document.getElementById('edit-subcat-name').value;
                const newSlug = document.getElementById('edit-subcat-slug').value;
                const newImgUrl = document.getElementById('edit-subcat-img-url').value;
                const newImgFile = document.getElementById('edit-subcat-img-file').files[0];

                if (newName && newSlug) {
                    if (category.subcategories.some(s => s.slug === newSlug && s.name !== oldName)) {
                        alert('Шлях підкатегорії має бути унікальним у межах категорії!');
                        return;
                    }
                    subcategory.name = newName;
                    subcategory.slug = newSlug;
                    if (newImgUrl) subcategory.img = newImgUrl;

                    if (newImgFile) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            subcategory.img = e.target.result;
                            updateProductsSubcategory(categoryName, oldName, newName);
                            localStorage.setItem('categories', LZString.compressToUTF16(JSON.stringify(categories)));
                            localStorage.setItem('products', LZString.compressToUTF16(JSON.stringify(products)));
                            closeModal();
                            renderAdmin();
                            showNotification('Підкатегорію відредаговано!');
                            unsavedChanges = false;
                            resetInactivityTimer();
                        };
                        reader.readAsDataURL(newImgFile);
                    } else {
                        updateProductsSubcategory(categoryName, oldName, newName);
                        localStorage.setItem('categories', LZString.compressToUTF16(JSON.stringify(categories)));
                        localStorage.setItem('products', LZString.compressToUTF16(JSON.stringify(products)));
                        closeModal();
                        renderAdmin();
                        showNotification('Підкатегорію відредаговано!');
                        unsavedChanges = false;
                        resetInactivityTimer();
                    }
                } else {
                    alert('Введіть назву та шлях!');
                }
            }
        }
    }

    function updateProductsSubcategory(categoryName, oldSubcatName, newSubcatName) {
        products.forEach(p => {
            if (p.category === categoryName && p.subcategory === oldSubcatName) {
                p.subcategory = newSubcatName;
            }
        });
    }

    function deleteSubcategory(categoryName, subcatName) {
        if (confirm('Ви впевнені, що хочете видалити цю підкатегорію?')) {
            const category = categories.find(c => c.name === categoryName);
            if (category) {
                category.subcategories = category.subcategories.filter(s => s.name !== subcatName);
                products.forEach(p => {
                    if (p.category === categoryName && p.subcategory === subcatName) {
                        p.subcategory = '';
                    }
                });
                localStorage.setItem('categories', LZString.compressToUTF16(JSON.stringify(categories)));
                localStorage.setItem('products', LZString.compressToUTF16(JSON.stringify(products)));
                renderAdmin();
                showNotification('Підкатегорію видалено!');
                unsavedChanges = false;
                resetInactivityTimer();
            }
        }
    }

    function moveSubcategoryUp(categoryName, index) {
        const category = categories.find(c => c.name === categoryName);
        if (category && index > 0) {
            [category.subcategories[index - 1], category.subcategories[index]] = [category.subcategories[index], category.subcategories[index - 1]];
            localStorage.setItem('categories', LZString.compressToUTF16(JSON.stringify(categories)));
            renderAdmin();
            resetInactivityTimer();
        }
    }

    function moveSubcategoryDown(categoryName, index) {
        const category = categories.find(c => c.name === categoryName);
        if (category && index < category.subcategories.length - 1) {
            [category.subcategories[index], category.subcategories[index + 1]] = [category.subcategories[index + 1], category.subcategories[index]];
            localStorage.setItem('categories', LZString.compressToUTF16(JSON.stringify(categories)));
            renderAdmin();
            resetInactivityTimer();
        }
    }

    function updateCategorySettings() {
        const width = parseInt(document.getElementById('category-width').value);
        const height = parseInt(document.getElementById('category-height').value);

        if (width >= 100 && width <= 500) settings.categoryWidth = width;
        if (height >= 100 && height <= 500) settings.categoryHeight = height;

        localStorage.setItem('settings', LZString.compressToUTF16(JSON.stringify(settings)));
        renderAdmin();
        showNotification('Налаштування категорій збережено!');
        unsavedChanges = false;
        resetInactivityTimer();
    }

    function updateProductSettings() {
        const width = parseInt(document.getElementById('product-width').value);
        const height = parseInt(document.getElementById('product-height').value);

        if (width >= 200 && width <= 500) settings.productWidth = width;
        if (height >= 200 && height <= 500) settings.productHeight = height;

        localStorage.setItem('settings', LZString.compressToUTF16(JSON.stringify(settings)));
        renderAdmin();
        showNotification('Налаштування товарів збережено!');
        unsavedChanges = false;
        resetInactivityTimer();
    }

    function addFilter() {
        const name = document.getElementById('filter-name').value;
        const label = document.getElementById('filter-label').value;
        const options = document.getElementById('filter-options').value.split(',').map(o => o.trim()).filter(o => o);

        if (name && label && options.length > 0) {
            if (filters.some(f => f.name === name)) {
                alert('Назва фільтру має бути унікальною!');
                return;
            }
            filters.push({ name, label, type: 'checkbox', options });
            localStorage.setItem('filters', LZString.compressToUTF16(JSON.stringify(filters)));
            document.getElementById('filter-name').value = '';
            document.getElementById('filter-label').value = '';
            document.getElementById('filter-options').value = '';
            renderAdmin();
            showNotification('Фільтр додано!');
            unsavedChanges = false;
            resetInactivityTimer();
        } else {
            alert('Введіть назву, підпис та опції фільтру!');
        }
    }

    function editFilter(name) {
        const filter = filters.find(f => f.name === name);
        if (filter) {
            const modal = document.getElementById('modal');
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>Редагувати фільтр</h3>
                    <input type="text" id="edit-filter-name" value="${filter.name}" readonly><br/>
                    <label for="edit-filter-name">Назва фільтру</label>
                    <input type="text" id="edit-filter-label" value="${filter.label}"><br/>
                    <label for="edit-filter-label">Відображувана назва</label>
                    <input type="text" id="edit-filter-options" value="${filter.options.join(', ')}"><br/>
                    <label for="edit-filter-options">Опції (через кому)</label>
                    <div class="modal-actions">
                        <button id="save-filter-btn">Зберегти</button>
                        <button id="cancel-filter-btn">Скасувати</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
            document.getElementById('save-filter-btn').addEventListener('click', () => saveFilterEdit(name));
            document.getElementById('cancel-filter-btn').addEventListener('click', closeModal);
            resetInactivityTimer();
        }
    }

    function saveFilterEdit(name) {
        const filter = filters.find(f => f.name === name);
        if (filter) {
            const newLabel = document.getElementById('edit-filter-label').value;
            const newOptions = document.getElementById('edit-filter-options').value.split(',').map(o => o.trim()).filter(o => o);

            if (newLabel && newOptions.length > 0) {
                filter.label = newLabel;
                filter.options = newOptions;
                localStorage.setItem('filters', LZString.compressToUTF16(JSON.stringify(filters)));
                closeModal();
                renderAdmin();
                showNotification('Фільтр відредаговано!');
                unsavedChanges = false;
                resetInactivityTimer();
            } else {
                alert('Введіть підпис та опції!');
            }
        }
    }

    function deleteFilter(name) {
        if (confirm('Ви впевнені, що хочете видалити цей фільтр?')) {
            filters = filters.filter(f => f.name !== name);
            localStorage.setItem('filters', LZString.compressToUTF16(JSON.stringify(filters)));
            renderAdmin();
            showNotification('Фільтр видалено!');
            unsavedChanges = false;
            resetInactivityTimer();
        }
    }

    function moveFilterUp(index) {
        if (index > 0) {
            [filters[index - 1], filters[index]] = [filters[index], filters[index - 1]];
            localStorage.setItem('filters', LZString.compressToUTF16(JSON.stringify(filters)));
            renderAdmin();
            resetInactivityTimer();
        }
    }

    function moveFilterDown(index) {
        if (index < filters.length - 1) {
            [filters[index], filters[index + 1]] = [filters[index + 1], filters[index]];
            localStorage.setItem('filters', LZString.compressToUTF16(JSON.stringify(filters)));
            renderAdmin();
            resetInactivityTimer();
        }
    }

    function addOrderField() {
        const name = document.getElementById('order-field-name').value;
        const label = document.getElementById('order-field-label').value;
        const type = document.getElementById('order-field-type').value;
        const options = document.getElementById('order-field-options').value.split(',').map(o => o.trim()).filter(o => o);

        if (name && label) {
            if (orderFields.some(f => f.name === name)) {
                alert('Назва поля має бути унікальною!');
                return;
            }
            const field = { name, label, type };
            if (type === 'select' && options.length > 0) field.options = options;
            orderFields.push(field);
            localStorage.setItem('orderFields', LZString.compressToUTF16(JSON.stringify(orderFields)));
            document.getElementById('order-field-name').value = '';
            document.getElementById('order-field-label').value = '';
            document.getElementById('order-field-options').value = '';
            renderAdmin();
            showNotification('Поле замовлення додано!');
            unsavedChanges = false;
            resetInactivityTimer();
        } else {
            alert('Введіть назву та підпис поля!');
        }
    }

    function editOrderField(name) {
        const field = orderFields.find(f => f.name === name);
        if (field) {
            const modal = document.getElementById('modal');
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>Редагувати поле замовлення</h3>
                    <input type="text" id="edit-order-field-name" value="${field.name}" readonly><br/>
                    <label for="edit-order-field-name">Назва поля</label>
                    <input type="text" id="edit-order-field-label" value="${field.label}"><br/>
                    <label for="edit-order-field-label">Відображувана назва</label>
                    <select id="edit-order-field-type">
                        <option value="text" ${field.type === 'text' ? 'selected' : ''}>Текст</option>
                        <option value="email" ${field.type === 'email' ? 'selected' : ''}>Email</option>
                        <option value="select" ${field.type === 'select' ? 'selected' : ''}>Вибір</option>
                    </select><br/>
                    <label for="edit-order-field-type">Тип поля</label>
                    <input type="text" id="edit-order-field-options" value="${field.options ? field.options.join(', ') : ''}" ${field.type !== 'select' ? 'disabled' : ''}><br/>
                    <label for="edit-order-field-options">Опції (через кому, для select)</label>
                    <div class="modal-actions">
                        <button id="save-order-field-btn">Зберегти</button>
                        <button id="cancel-order-field-btn">Скасувати</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
            document.getElementById('edit-order-field-type').addEventListener('change', (e) => {
                document.getElementById('edit-order-field-options').disabled = e.target.value !== 'select';
            });
            document.getElementById('save-order-field-btn').addEventListener('click', () => saveOrderFieldEdit(name));
            document.getElementById('cancel-order-field-btn').addEventListener('click', closeModal);
            resetInactivityTimer();
        }
    }

    function saveOrderFieldEdit(name) {
        const field = orderFields.find(f => f.name === name);
        if (field) {
            const newLabel = document.getElementById('edit-order-field-label').value;
            const newType = document.getElementById('edit-order-field-type').value;
            const newOptions = document.getElementById('edit-order-field-options').value.split(',').map(o => o.trim()).filter(o => o);

            if (newLabel) {
                field.label = newLabel;
                field.type = newType;
                if (newType === 'select') {
                    if (newOptions.length > 0) {
                        field.options = newOptions;
                    } else {
                        alert('Введіть опції для типу "Вибір"!');
                        return;
                    }
                } else {
                    delete field.options;
                }
                localStorage.setItem('orderFields', LZString.compressToUTF16(JSON.stringify(orderFields)));
                closeModal();
                renderAdmin();
                showNotification('Поле замовлення відредаговано!');
                unsavedChanges = false;
                resetInactivityTimer();
            } else {
                alert('Введіть відображувану назву!');
            }
        }
    }

    function deleteOrderField(name) {
        if (confirm('Ви впевнені, що хочете видалити це поле?')) {
            orderFields = orderFields.filter(f => f.name !== name);
            localStorage.setItem('orderFields', LZString.compressToUTF16(JSON.stringify(orderFields)));
            renderAdmin();
            showNotification('Поле замовлення видалено!');
            unsavedChanges = false;
            resetInactivityTimer();
        }
    }

    function updateSlideshowSettings() {
        const width = parseInt(document.getElementById('slide-width').value);
        const height = parseInt(document.getElementById('slide-height').value);
        const interval = parseInt(document.getElementById('slide-interval').value);

        if (width >= 10 && width <= 100) settings.slideWidth = width;
        if (height >= 100 && height <= 500) settings.slideHeight = height;
        if (interval >= 1000) settings.slideInterval = interval;

        localStorage.setItem('settings', LZString.compressToUTF16(JSON.stringify(settings)));
        renderAdmin();
        showNotification('Налаштування слайдшоу збережено!');
        unsavedChanges = false;
        resetInactivityTimer();
    }

function addSlide() {
    const imgUrl = document.getElementById('slide-img-url').value;
    const imgFile = document.getElementById('slide-img-file').files[0];
    const title = document.getElementById('slide-title').value;
    const text = document.getElementById('slide-text').value;
    const link = document.getElementById('slide-link').value;
    const linkText = document.getElementById('slide-link-text').value;
    const order = parseInt(document.getElementById('slide-order').value) || (slides.length ? Math.max(...slides.map(s => s.order)) + 1 : 1);

    if (slides.some(s => s.order === order)) {
        alert('Слайд з таким порядковим номером уже існує!');
        return;
    }

    if (!imgUrl && !imgFile) {
        alert('Введіть URL або завантажте файл зображення!');
        return;
    }

    const slide = {
        url: imgUrl, // URL зображення
        title: title || 'Без заголовка',
        text: text || '',
        link: link || '#',
        linkText: linkText || 'Дізнатися більше',
        order
    };

    if (imgFile) {
        const reader = new FileReader();
        reader.onload = (e) => {
            slide.url = e.target.result; // Зберігаємо Data URL зображення
            slides.push(slide);
            localStorage.setItem('slides', LZString.compressToUTF16(JSON.stringify(slides)));
            document.getElementById('slide-img-url').value = '';
            document.getElementById('slide-img-file').value = '';
            document.getElementById('slide-title').value = '';
            document.getElementById('slide-text').value = '';
            document.getElementById('slide-link').value = '';
            document.getElementById('slide-link-text').value = '';
            document.getElementById('slide-order').value = '';
            renderAdmin();
            showNotification('Слайд додано!');
            unsavedChanges = false;
            resetInactivityTimer();
        };
        reader.readAsDataURL(imgFile);
    } else {
        slides.push(slide);
        localStorage.setItem('slides', LZString.compressToUTF16(JSON.stringify(slides)));
        document.getElementById('slide-img-url').value = '';
        document.getElementById('slide-img-file').value = '';
        document.getElementById('slide-title').value = '';
        document.getElementById('slide-text').value = '';
        document.getElementById('slide-link').value = '';
        document.getElementById('slide-link-text').value = '';
        document.getElementById('slide-order').value = '';
        renderAdmin();
        showNotification('Слайд додано!');
        unsavedChanges = false;
        resetInactivityTimer();
    }
}

    function editSlide(order) {
        const slide = slides.find(s => s.order === order);
        if (slide) {
            const modal = document.getElementById('modal');
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>Редагувати слайд</h3>
                    <input type="number" id="edit-slide-order" value="${slide.order}"><br/>
                    <label for="edit-slide-order">Порядковий номер</label>
                    <input type="text" id="edit-slide-img-url" value="${slide.img || ''}"><br/>
                    <label for="edit-slide-img-url">URL зображення</label>
                    <input type="file" id="edit-slide-img-file" accept="image/*"><br/>
                    <label for="edit-slide-img-file">Завантажте зображення</label>
                    ${slide.img ? `<img src="${slide.img}" style="max-width: 100px;">` : ''}
                    <input type="text" id="edit-slide-url" value="${slide.url}"><br/>
                    <label for="edit-slide-url">Посилання</label>
                    <div class="modal-actions">
                        <button id="save-slide-btn">Зберегти</button>
                        <button id="cancel-slide-btn">Скасувати</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
            document.getElementById('save-slide-btn').addEventListener('click', () => saveSlideEdit(order));
            document.getElementById('cancel-slide-btn').addEventListener('click', closeModal);
            resetInactivityTimer();
        }
    }

    function saveSlideEdit(oldOrder) {
        const newOrder = parseInt(document.getElementById('edit-slide-order').value);
        const newImgUrl = document.getElementById('edit-slide-img-url').value;
        const newImgFile = document.getElementById('edit-slide-img-file').files[0];
        const newUrl = document.getElementById('edit-slide-url').value;

        if (isNaN(newOrder)) {
            alert('Введіть порядковий номер слайду!');
            return;
        }

        const slide = slides.find(s => s.order === oldOrder);
        if (slide) {
            slide.order = newOrder;
            slide.url = newUrl || '#';
            if (newImgUrl) slide.img = newImgUrl;

            if (newImgFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    slide.img = e.target.result;
                    slides = slides.filter(s => s.order !== oldOrder);
                    slides.push(slide);
                    slides.sort((a, b) => a.order - b.order);
                    localStorage.setItem('slides', LZString.compressToUTF16(JSON.stringify(slides)));
                    closeModal();
                    renderAdmin();
                    showNotification('Слайд відредаговано!');
                    unsavedChanges = false;
                    resetInactivityTimer();
                };
                reader.readAsDataURL(newImgFile);
            } else {
                slides = slides.filter(s => s.order !== oldOrder);
                slides.push(slide);
                slides.sort((a, b) => a.order - b.order);
                localStorage.setItem('slides', LZString.compressToUTF16(JSON.stringify(slides)));
                closeModal();
                renderAdmin();
                showNotification('Слайд відредаговано!');
                unsavedChanges = false;
                resetInactivityTimer();
            }
        }
    }

    function deleteSlide(order) {
        if (confirm('Ви впевнені, що хочете видалити цей слайд?')) {
            slides = slides.filter(s => s.order !== order);
            localStorage.setItem('slides', LZString.compressToUTF16(JSON.stringify(slides)));
            renderAdmin();
            showNotification('Слайд видалено!');
            unsavedChanges = false;
            resetInactivityTimer();
        }
    }

    function toggleSlideshow() {
        settings.showSlides = document.getElementById('slide-toggle').checked;
        localStorage.setItem('settings', LZString.compressToUTF16(JSON.stringify(settings)));
        renderAdmin();
        showNotification('Налаштування слайдшоу збережено!');
        unsavedChanges = false;
        resetInactivityTimer();
    }

    function exportSiteBackup() {
        const data = {
            settings,
            categories,
            filters,
            orderFields,
            slides
        };
        const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'site-backup.json';
        a.click();
        URL.revokeObjectURL(url);
        showNotification('Бекап сайту експортовано!');
        resetInactivityTimer();
    }

    function exportProductsBackup() {
        const blob = new Blob([JSON.stringify(products)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'products-backup.json';
        a.click();
        URL.revokeObjectURL(url);
        showNotification('Бекап товарів експортовано!');
        resetInactivityTimer();
    }

    function exportOrdersBackup() {
        const blob = new Blob([JSON.stringify(orders)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'orders-backup.json';
        a.click();
        URL.revokeObjectURL(url);
        showNotification('Бекап замовлень експортовано!');
        resetInactivityTimer();
    }

    function importSiteBackup() {
        const file = document.getElementById('import-site-file').files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    settings = data.settings || settings;
                    categories = data.categories || categories;
                    filters = data.filters || filters;
                    orderFields = data.orderFields || orderFields;
                    slides = data.slides || slides;
                    localStorage.setItem('settings', LZString.compressToUTF16(JSON.stringify(settings)));
                    localStorage.setItem('categories', LZString.compressToUTF16(JSON.stringify(categories)));
                    localStorage.setItem('filters', LZString.compressToUTF16(JSON.stringify(filters)));
                    localStorage.setItem('orderFields', LZString.compressToUTF16(JSON.stringify(orderFields)));
                    localStorage.setItem('slides', LZString.compressToUTF16(JSON.stringify(slides)));
                    renderAdmin();
                    showNotification('Бекап сайту імпортовано!');
                    unsavedChanges = false;
                    resetInactivityTimer();
                } catch (err) {
                    alert('Помилка імпорту: ' + err.message);
                }
            };
            reader.readAsText(file);
        } else {
            alert('Виберіть файл для імпорту!');
        }
    }

    function importProductsBackup() {
        const file = document.getElementById('import-products-file').files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    products = JSON.parse(e.target.result);
                    localStorage.setItem('products', LZString.compressToUTF16(JSON.stringify(products)));
                    renderAdmin();
                    showNotification('Бекап товарів імпортовано!');
                    unsavedChanges = false;
                    resetInactivityTimer();
                } catch (err) {
                    alert('Помилка імпорту: ' + err.message);
                }
            };
            reader.readAsText(file);
        } else {
            alert('Виберіть файл для імпорту!');
        }
    }

    function importOrdersBackup() {
        const file = document.getElementById('import-orders-file').files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    orders = JSON.parse(e.target.result);
                    localStorage.setItem('orders', LZString.compressToUTF16(JSON.stringify(orders)));
                    renderAdmin();
                    showNotification('Бекап замовлень імпортовано!');
                    unsavedChanges = false;
                    resetInactivityTimer();
                } catch (err) {
                    alert('Помилка імпорту: ' + err.message);
                }
            };
            reader.readAsText(file);
        } else {
            alert('Виберіть файл для імпорту!');
        }
    }

    function generateSitemap() {
        const baseUrl = settings.baseUrl || 'https://www.example.com';
        let sitemap = `<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
    <url>
        <loc>${baseUrl}/</loc>
        <lastmod>${new Date().toISOString().split('T')[0]}</lastmod>
        <changefreq>daily</changefreq>
        <priority>1.0</priority>
    </url>`;

        categories.forEach(cat => {
            sitemap += `
    <url>
        <loc>${baseUrl}/catalog/${cat.slug}</loc>
        <lastmod>${new Date().toISOString().split('T')[0]}</lastmod>
        <changefreq>weekly</changefreq>
        <priority>0.8</priority>
    </url>`;
            (cat.subcategories || []).forEach(sub => {
                sitemap += `
    <url>
        <loc>${baseUrl}/catalog/${cat.slug}/${sub.slug}</loc>
        <lastmod>${new Date().toISOString().split('T')[0]}</lastmod>
        <changefreq>weekly</changefreq>
        <priority>0.7</priority>
    </url>`;
            });
        });

        products.forEach(product => {
            if (product.visible) {
                sitemap += `
    <url>
        <loc>${baseUrl}/product/${product.slug}</loc>
        <lastmod>${new Date().toISOString().split('T')[0]}</lastmod>
        <changefreq>weekly</changefreq>
        <priority>0.6</priority>
    </url>`;
            }
        });

        sitemap += `
</urlset>`;
        return sitemap;
    }

function downloadSitemap() {
    let sitemap = `<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
    <url>
        <loc>${settings.baseUrl}/</loc>
        <lastmod>${new Date().toISOString().split('T')[0]}</lastmod>
        <priority>1.0</priority>
    </url>
    ${categories.map(c => `
        <url>
            <loc>${settings.baseUrl}/category/${c.slug}</loc>
            <lastmod>${new Date().toISOString().split('T')[0]}</lastmod>
            <priority>0.8</priority>
        </url>
        ${c.subcategories.map(s => `
            <url>
                <loc>${settings.baseUrl}/category/${c.slug}/${s.slug}</loc>
                <lastmod>${new Date().toISOString().split('T')[0]}</lastmod>
                <priority>0.7</priority>
            </url>
        `).join('')}
    `).join('')}
    ${products.filter(p => p.active && p.visible).map(p => `
        <url>
            <loc>${settings.baseUrl}/product/${p.slug}</loc>
            <lastmod>${new Date().toISOString().split('T')[0]}</lastmod>
            <priority>0.6</priority>
        </url>
    `).join('')}
</urlset>`;
    const blob = new Blob([sitemap], { type: 'application/xml' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'sitemap.xml';
    a.click();
    URL.revokeObjectURL(url);
    showNotification('Sitemap завантажено!');
    resetInactivityTimer();
}

    let newProduct = {
        type: 'simple',
        colors: [],
        photos: [],
        sizes: [],
        groupProducts: [],
        active: true,
        visible: true
    };

// Додаємо обробники подій для автоматичного імпорту після вибору файлу
document.getElementById('import-site-file').addEventListener('change', function() {
    importSiteBackup();
});

document.getElementById('import-products-file').addEventListener('change', function() {
    importProductsBackup();
});

document.getElementById('import-orders-file').addEventListener('change', function() {
    importOrdersBackup();
});

document.getElementById('bulk-price-file').addEventListener('change', function() {
    uploadBulkPrices();
});

function openAddProductModal() {
    newProduct = {
        type: 'simple',
        photos: [],
        colors: [],
        sizes: [],
        groupProducts: []
    };
    const modal = document.getElementById('modal');
    modal.innerHTML = `
        <div class="modal-content">
            <h3>Додати товар</h3>
            <select id="product-type" onchange="updateProductType()">
                <option value="simple">Простий товар</option>
                <option value="mattresses">Матраци</option>
                <option value="group">Груповий товар</option>
            </select><br/>
            <label for="product-type">Тип товару</label>
            <input type="text" id="product-name" placeholder="Назва товару"><br/>
            <label for="product-name">Назва товару</label>
            <input type="text" id="product-slug" placeholder="Шлях товару"><br/>
            <label for="product-slug">Шлях товару</label>
            <input type="text" id="product-brand" placeholder="Виробник"><br/>
            <label for="product-brand">Виробник</label>
            <select id="product-category">
                <option value="">Без категорії</option>
                ${categories.map(c => `<option value="${c.name}">${c.name}</option>`).join('')}
            </select><br/>
            <label for="product-category">Категорія</label>
            <select id="product-subcategory">
                <option value="">Без підкатегорії</option>
            </select><br/>
            <label for="product-subcategory">Підкатегорія</label>
            <input type="text" id="product-material" placeholder="Матеріал"><br/>
            <label for="product-material">Матеріал</label>
            <div id="price-fields"></div>
            <input type="datetime-local" id="product-sale-end" placeholder="Дата закінчення акції"><br/>
            <label for="product-sale-end">Дата закінчення акції</label>
            <select id="product-visible">
                <option value="true">Показувати на сайті</option>
                <option value="false">Не показувати</option>
            </select><br/>
            <label for="product-visible">Видимість</label>
            <div id="product-description-editor"></div>
            <input type="hidden" id="product-description">
            <label for="product-description">Опис товару</label>
            <h4>Розміри</h4>
            <input type="number" id="product-width-cm" placeholder="Ширина (см)" min="0" step="0.1"><br/>
            <label for="product-width-cm">Ширина (см)</label>
            <input type="number" id="product-depth-cm" placeholder="Глибина (см)" min="0" step="0.1"><br/>
            <label for="product-depth-cm">Глибина (см)</label>
            <input type="number" id="product-height-cm" placeholder="Висота (см)" min="0" step="0.1"><br/>
            <label for="product-height-cm">Висота (см)</label>
            <input type="number" id="product-length-cm" placeholder="Довжина (см)" min="0" step="0.1"><br/>
            <label for="product-length-cm">Довжина (см)</label>
            <h4>Фотографії</h4>
            <input type="text" id="product-photo-url" placeholder="URL фотографії"><br/>
            <label for="product-photo-url">URL фотографії</label>
            <input type="file" id="product-photo-file" accept="image/jpeg,image/png,image/gif,image/webp" multiple><br/>
            <label for="product-photo-file">Завантажте фотографію</label>
            <button onclick="addProductPhoto()">Додати фото</button>
            <div id="product-photo-list" class="photo-list"></div>
            <h4>Кольори</h4>
            <input type="text" id="product-color-name" placeholder="Назва кольору"><br/>
            <label for="product-color-name">Назва кольору</label>
            <input type="color" id="product-color-value" value="#000000"><br/>
            <label for="product-color-value">Значення кольору</label>
            <input type="number" id="product-color-price-change" placeholder="Зміна ціни (грн)" step="0.01"><br/>
            <label for="product-color-price-change">Зміна ціни для кольору (грн)</label>
            <input type="text" id="product-color-photo-url" placeholder="URL фото кольору"><br/>
            <label for="product-color-photo-url">URL фото кольору</label>
            <input type="file" id="product-color-photo-file" accept="image/jpeg,image/png,image/gif,image/webp"><br/>
            <label for="product-color-photo-file">Завантажте фото кольору</label>
            <button onclick="addProductColor()">Додати колір</button>
            <div id="product-color-list" class="color-photo-list"></div>
            <div id="mattress-sizes" class="type-specific">
                <h4>Розміри матраців</h4>
                <input type="text" id="mattress-size-name" placeholder="Розмір (наприклад, 90x190)"><br/>
                <label for="mattress-size-name">Розмір</label>
                <input type="number" id="mattress-size-price" placeholder="Ціна (грн)" min="0"><br/>
                <label for="mattress-size-price">Ціна (грн)</label>
                <button onclick="addMattressSize()">Додати розмір</button>
                <div id="mattress-size-list"></div>
            </div>
            <div id="group-products" class="type-specific">
                <h4>Групові товари</h4>
                <div class="group-product-search">
                    <input type="text" id="group-product-search" placeholder="Пошук товарів" oninput="searchGroupProducts()">
                    <div id="group-product-results"></div>
                </div>
                <div id="group-product-list"></div>
            </div>
            <div class="modal-actions">
                <button onclick="saveNewProduct()">Зберегти</button>
                <button onclick="closeModal()">Скасувати</button>
            </div>
        </div>
    `;
    modal.classList.add('active');
    updateProductType();
    initializeProductEditor();

    // Додаємо обробники подій після ініціалізації DOM
    setTimeout(() => {
        const categorySelect = document.getElementById('product-category');
        if (categorySelect) {
            categorySelect.addEventListener('change', updateSubcategories);
            updateSubcategories();
        }

        const photoInput = document.getElementById('product-photo-file');
        if (photoInput) {
            photoInput.addEventListener('change', () => {
                const files = photoInput.files;
                Array.from(files).forEach(file => {
                    if (!newProduct.photos.includes(file)) {
                        newProduct.photos.push(file);
                    }
                });
                renderPhotoList();
                resetInactivityTimer();
            });
        }

        const colorPhotoInput = document.getElementById('product-color-photo-file');
        if (colorPhotoInput) {
            colorPhotoInput.addEventListener('change', () => {
                const file = colorPhotoInput.files[0];
                if (file) {
                    const name = document.getElementById('product-color-name').value;
                    const value = document.getElementById('product-color-value').value;
                    const priceChange = parseFloat(document.getElementById('product-color-price-change').value) || 0;
                    if (name && value) {
                        const color = { name, value, priceChange, photo: file };
                        newProduct.colors.push(color);
                        document.getElementById('product-color-name').value = '';
                        document.getElementById('product-color-value').value = '#000000';
                        document.getElementById('product-color-price-change').value = '';
                        document.getElementById('product-color-photo-url').value = '';
                        document.getElementById('product-color-photo-file').value = '';
                        renderColorsList();
                        resetInactivityTimer();
                    }
                }
            });
        }
    }, 0);

    resetInactivityTimer();
}

async function addProduct(productData) {
    const token = localStorage.getItem('adminToken');
    const response = await fetch('/api/products', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(productData)
    });
    if (!response.ok) throw new Error((await response.json()).error);
    return await response.json();
}

async function updateProduct(id, productData) {
    const token = localStorage.getItem('adminToken');
    const response = await fetch(`/api/products/${id}`, {
        method: 'PUT',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(productData)
    });
    if (!response.ok) throw new Error((await response.json()).error);
    return await response.json();
}

async function deleteProduct(id) {
    const token = localStorage.getItem('adminToken');
    const response = await fetch(`/api/products/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
    });
    if (!response.ok) throw new Error((await response.json()).error);
    return await response.json();
}

function updateProductType() {
    newProduct.type = document.getElementById('product-type').value;
    document.querySelectorAll('.type-specific').forEach(el => el.classList.remove('active'));
    if (newProduct.type === 'mattresses') {
        document.getElementById('mattress-sizes').classList.add('active');
    } else if (newProduct.type === 'group') {
        document.getElementById('group-products').classList.add('active');
    }
    renderPriceFields(); // Оновлюємо поля ціни
    resetInactivityTimer();
}

function renderPriceFields() {
    const priceFields = document.getElementById('price-fields');
    if (!priceFields) return; // Захист від помилки, якщо контейнер не знайдено

    if (newProduct.type === 'simple') {
        priceFields.innerHTML = `
            <input type="number" id="product-price" value="${newProduct.price || ''}" placeholder="Ціна (грн)" min="0"><br/>
            <label for="product-price">Ціна (грн)</label>
            <input type="number" id="product-sale-price" value="${newProduct.salePrice || ''}" placeholder="Акційна ціна (грн)" min="0"><br/>
            <label for="product-sale-price">Акційна ціна (грн)</label>
        `;
    } else {
        priceFields.innerHTML = ''; // Очищаємо поля для матраців і групових товарів
    }
}

    function updateSubcategories() {
        const category = document.getElementById('product-category').value;
        const subcatSelect = document.getElementById('product-subcategory');
        const cat = categories.find(c => c.name === category);
        subcatSelect.innerHTML = '<option value="">Без підкатегорії</option>' + 
            (cat ? cat.subcategories.map(s => `<option value="${s.name}">${s.name}</option>`).join('') : '');
        resetInactivityTimer();
    }

function addProductPhoto() {
    const url = document.getElementById('product-photo-url').value;
    const fileInput = document.getElementById('product-photo-file');
    const files = fileInput.files;

    if (files.length > 0) {
        let allValid = true;
        Array.from(files).forEach(file => {
            const validation = validateFile(file);
            if (!validation.valid) {
                alert(validation.error);
                allValid = false;
                return;
            }
            newProduct.photos.push(file);
        });
        if (allValid) {
            fileInput.value = '';
            document.getElementById('product-photo-url').value = '';
            renderPhotoList();
            resetInactivityTimer();
        }
    } else if (url) {
        newProduct.photos.push(url);
        document.getElementById('product-photo-url').value = '';
        document.getElementById('product-photo-file').value = '';
        renderPhotoList();
        resetInactivityTimer();
    } else {
        alert('Введіть URL або завантажте файл!');
    }
}

function renderPhotoList() {
    const photoList = document.getElementById('product-photo-list');
    photoList.innerHTML = newProduct.photos.map((photo, index) => {
        let photoSrc = '';
        if (typeof photo === 'string') {
            photoSrc = photo;
        } else if (photo instanceof File) {
            photoSrc = URL.createObjectURL(photo);
        }
        return `
            <div class="photo-item draggable" draggable="true" ondragstart="dragPhoto(event, ${index})" ondragover="allowDropPhoto(event)" ondrop="dropPhoto(event, ${index})">
                <img src="${photoSrc}" style="max-width: 50px;">
                <button class="delete-btn" onclick="deleteProductPhoto(${index})">Видалити</button>
            </div>
        `;
    }).join('');
}

    function dragPhoto(event, index) {
        event.dataTransfer.setData('text/plain', index);
        event.target.classList.add('dragging');
    }

    function allowDropPhoto(event) {
        event.preventDefault();
    }

    function dropPhoto(event, targetIndex) {
        event.preventDefault();
        const sourceIndex = parseInt(event.dataTransfer.getData('text/plain'));
        if (sourceIndex !== targetIndex) {
            const [movedPhoto] = newProduct.photos.splice(sourceIndex, 1);
            newProduct.photos.splice(targetIndex, 0, movedPhoto);
            renderPhotoList();
            resetInactivityTimer();
        }
        document.querySelectorAll('.photo-item').forEach(item => item.classList.remove('dragging'));
    }

    function deleteProductPhoto(index) {
        newProduct.photos.splice(index, 1);
        renderPhotoList();
        resetInactivityTimer();
    }

function addProductColor() {
    const name = document.getElementById('product-color-name').value;
    const value = document.getElementById('product-color-value').value;
    const priceChange = parseFloat(document.getElementById('product-color-price-change').value) || 0;
    const url = document.getElementById('product-color-photo-url').value;
    const colorPhotoInput = document.getElementById('product-color-photo-file');
    const file = colorPhotoInput ? colorPhotoInput.files[0] : null;

    if (name && value) {
        const color = { name, value, priceChange };
        if (file) {
            const validation = validateFile(file);
            if (!validation.valid) {
                alert(validation.error);
                return;
            }
            color.photo = file; // Зберігаємо файл, а не Base64
            newProduct.colors.push(color);
            document.getElementById('product-color-name').value = '';
            document.getElementById('product-color-value').value = '#000000';
            document.getElementById('product-color-price-change').value = '';
            document.getElementById('product-color-photo-url').value = '';
            if (colorPhotoInput) colorPhotoInput.value = '';
            renderColorsList();
            resetInactivityTimer();
        } else if (url) {
            color.photo = url;
            newProduct.colors.push(color);
            document.getElementById('product-color-name').value = '';
            document.getElementById('product-color-value').value = '#000000';
            document.getElementById('product-color-price-change').value = '';
            document.getElementById('product-color-photo-url').value = '';
            if (colorPhotoInput) colorPhotoInput.value = '';
            renderColorsList();
            resetInactivityTimer();
        } else {
            newProduct.colors.push(color);
            document.getElementById('product-color-name').value = '';
            document.getElementById('product-color-value').value = '#000000';
            document.getElementById('product-color-price-change').value = '';
            document.getElementById('product-color-photo-url').value = '';
            if (colorPhotoInput) colorPhotoInput.value = '';
            renderColorsList();
            resetInactivityTimer();
        }
    } else {
        alert('Введіть назву та виберіть колір!');
    }
}

function renderColorsList() {
    const colorList = document.getElementById('product-color-list');
    colorList.innerHTML = newProduct.colors.map((color, index) => {
        let photoSrc = '';
        if (color.photo) {
            if (typeof color.photo === 'string') {
                photoSrc = color.photo;
            } else if (color.photo instanceof File) {
                photoSrc = URL.createObjectURL(color.photo);
            }
        }
        return `
            <div class="color-item">
                <span class="color-preview" style="background-color: ${color.value};"></span>
                ${color.name} (Зміна ціни: ${color.priceChange} грн)
                ${photoSrc ? `<img src="${photoSrc}" alt="Фото кольору ${color.name}" style="max-width: 30px;">` : ''}
                <button class="delete-btn" onclick="deleteProductColor(${index})">Видалити</button>
            </div>
        `;
    }).join('');
}

    function deleteProductColor(index) {
        newProduct.colors.splice(index, 1);
        renderColorsList();
        resetInactivityTimer();
    }

    function addMattressSize() {
        const name = document.getElementById('mattress-size-name').value;
        const price = parseFloat(document.getElementById('mattress-size-price').value);

        if (name && !isNaN(price) && price >= 0) {
            newProduct.sizes.push({ name, price });
            document.getElementById('mattress-size-name').value = '';
            document.getElementById('mattress-size-price').value = '';
            renderMattressSizes();
            resetInactivityTimer();
        } else {
            alert('Введіть розмір та ціну!');
        }
    }

    function renderMattressSizes() {
        const sizeList = document.getElementById('mattress-size-list');
        sizeList.innerHTML = newProduct.sizes.map((size, index) => `
            <div class="mattress-size">
                ${size.name}: ${size.price} грн
                <button class="delete-btn" onclick="deleteMattressSize(${index})">Видалити</button>
            </div>
        `).join('');
    }

    function deleteMattressSize(index) {
        newProduct.sizes.splice(index, 1);
        renderMattressSizes();
        resetInactivityTimer();
    }

function searchGroupProducts() {
    const query = document.getElementById('group-product-search').value.toLowerCase();
    const results = document.getElementById('group-product-results');
    const filteredProducts = products.filter(p => 
        p.active && 
        p.type === 'simple' &&  // Змінено з p.type !== 'group' на p.type === 'simple'
        (p.name.toLowerCase().includes(query) || p.id.toString().includes(query))
    );
    results.innerHTML = filteredProducts.slice(0, 5).map(p => `
        <div>
            #${p.id} ${p.name}
            <button onclick="addGroupProduct(${p.id})">Додати</button>
        </div>
    `).join('');
    resetInactivityTimer();
}

    function addGroupProduct(productId) {
        if (!newProduct.groupProducts.includes(productId)) {
            newProduct.groupProducts.push(productId);
            renderGroupProducts();
            document.getElementById('group-product-search').value = '';
            document.getElementById('group-product-results').innerHTML = '';
            resetInactivityTimer();
        }
    }

    function renderGroupProducts() {
        const groupList = document.getElementById('group-product-list');
        if (groupList) {
            groupList.innerHTML = newProduct.groupProducts.map((pid, index) => {
                const p = products.find(pr => pr.id === pid);
                return p ? `
                    <div class="group-product draggable" draggable="true" ondragstart="dragGroupProduct(event, ${index})" ondragover="allowDropGroupProduct(event)" ondrop="dropGroupProduct(event, ${index})">
                        #${p.id} ${p.name}
                        <button class="delete-btn" onclick="deleteGroupProduct(${pid})">Видалити</button>
                    </div>
                ` : '';
            }).join('');
        }
    }

    function dragGroupProduct(event, index) {
        event.dataTransfer.setData('text/plain', index);
        event.target.classList.add('dragging');
    }

    function allowDropGroupProduct(event) {
        event.preventDefault();
    }

    function dropGroupProduct(event, targetIndex) {
        event.preventDefault();
        const sourceIndex = parseInt(event.dataTransfer.getData('text/plain'));
        if (sourceIndex !== targetIndex) {
            const [movedProduct] = newProduct.groupProducts.splice(sourceIndex, 1);
            newProduct.groupProducts.splice(targetIndex, 0, movedProduct);
            renderGroupProducts();
            unsavedChanges = true;
            resetInactivityTimer();
        }
        document.querySelectorAll('.group-product').forEach(item => item.classList.remove('dragging'));
    }

    function deleteGroupProduct(productId) {
        newProduct.groupProducts = newProduct.groupProducts.filter(pid => pid !== productId);
        renderGroupProducts();
        resetInactivityTimer();
    }

async function saveNewProduct() {
    try {
        const name = document.getElementById('product-name').value;
        const slug = document.getElementById('product-slug').value;
        const brand = document.getElementById('product-brand').value;
        const category = document.getElementById('product-category').value;
        const subcategory = document.getElementById('product-subcategory').value;
        const material = document.getElementById('product-material').value;
        let price = null;
        let salePrice = null;
        if (newProduct.type === 'simple') {
            price = parseFloat(document.getElementById('product-price')?.value);
            salePrice = parseFloat(document.getElementById('product-sale-price')?.value) || null;
        }
        const saleEnd = document.getElementById('product-sale-end').value;
        const visible = document.getElementById('product-visible').value === 'true';
        const description = document.getElementById('product-description').value;
        const descriptionDelta = productEditor.getContents();
        const widthCm = parseFloat(document.getElementById('product-width-cm').value) || null;
        const depthCm = parseFloat(document.getElementById('product-depth-cm').value) || null;
        const heightCm = parseFloat(document.getElementById('product-height-cm').value) || null;
        const lengthCm = parseFloat(document.getElementById('product-length-cm').value) || null;

        if (!name || !slug) {
            showNotification('Введіть назву та шлях товару!');
            return;
        }

        const token = localStorage.getItem('adminToken');
        if (!token) {
            showNotification('Токен відсутній. Будь ласка, увійдіть знову.');
            showSection('admin-login');
            return;
        }

        // Перевірка унікальності slug
        const slugCheck = await fetch(`/api/products?slug=${slug}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        if (!slugCheck.ok) {
            if (slugCheck.status === 401 || slugCheck.status === 403) {
                localStorage.removeItem('adminToken');
                session = { isActive: false, timestamp: 0 };
                localStorage.setItem('adminSession', LZString.compressToUTF16(JSON.stringify(session)));
                showSection('admin-login');
                showNotification('Сесія закінчилася. Будь ласка, увійдіть знову.');
                return;
            }
            const errorData = await slugCheck.json();
            throw new Error(`Помилка перевірки унікальності шляху: ${errorData.error || slugCheck.statusText}`);
        }
        const existingProducts = await slugCheck.json();
        if (existingProducts.some(p => p.slug === slug)) {
            showNotification('Шлях товару має бути унікальним!');
            return;
        }

        if (newProduct.type === 'simple' && (isNaN(price) || price < 0)) {
            showNotification('Введіть коректну ціну для простого товару!');
            return;
        }

        if (newProduct.type === 'mattresses' && newProduct.sizes.length === 0) {
            showNotification('Додайте хоча б один розмір для матрацу!');
            return;
        }

        if (newProduct.type === 'group' && newProduct.groupProducts.length === 0) {
            showNotification('Додайте хоча б один товар до групового товару!');
            return;
        }

        if (brand && !brands.includes(brand)) {
            brands.push(brand);
            localStorage.setItem('brands', LZString.compressToUTF16(JSON.stringify(brands)));
        }

        let product = {
            type: newProduct.type,
            name,
            slug,
            brand: brand || '',
            category: category || '',
            subcategory: subcategory || '',
            material: material || '',
            price: newProduct.type === 'simple' ? price : null,
            salePrice: salePrice,
            saleEnd: saleEnd || null,
            description: description || '',
            descriptionDelta: descriptionDelta || null,
            widthCm,
            depthCm,
            heightCm,
            lengthCm,
            photos: [],
            colors: newProduct.colors.map(color => ({
                name: color.name,
                value: color.value,
                priceChange: color.priceChange,
                photo: null
            })),
            sizes: newProduct.sizes,
            groupProducts: newProduct.groupProducts,
            active: true,
            visible: visible
        };

        const mediaUrls = [];
        const parser = new DOMParser();
        const doc = parser.parseFromString(description, 'text/html');
        const images = doc.querySelectorAll('img');
        const videos = doc.querySelectorAll('iframe');

        for (let img of images) {
            const src = img.getAttribute('src');
            if (src && src.startsWith('blob:')) {
                const response = await fetch(src);
                const blob = await response.blob();
                const formData = new FormData();
                formData.append('file', blob, `description-image-${Date.now()}.png`);
                const uploadResponse = await fetch('/api/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                if (!uploadResponse.ok) {
                    const errorData = await uploadResponse.json();
                    throw new Error(`Помилка завантаження зображення: ${errorData.error || uploadResponse.statusText}`);
                }
                const uploadData = await uploadResponse.json();
                if (uploadData.url) {
                    mediaUrls.push({ oldUrl: src, newUrl: uploadData.url });
                } else {
                    throw new Error('Не вдалося завантажити зображення');
                }
            }
        }

        let updatedDescription = description;
        mediaUrls.forEach(({ oldUrl, newUrl }) => {
            updatedDescription = updatedDescription.replace(oldUrl, newUrl);
        });

        let updatedDelta = descriptionDelta;
        if (mediaUrls.length > 0) {
            updatedDelta = { ops: [] };
            descriptionDelta.ops.forEach(op => {
                if (op.insert && typeof op.insert === 'object' && op.insert.image) {
                    const newUrl = mediaUrls.find(m => m.oldUrl === op.insert.image)?.newUrl || op.insert.image;
                    updatedDelta.ops.push({ insert: { image: newUrl }, attributes: op.attributes });
                } else {
                    updatedDelta.ops.push(op);
                }
            });
        }

        product.description = updatedDescription;
        product.descriptionDelta = updatedDelta;

        const photoFiles = newProduct.photos.filter(photo => photo instanceof File);
        for (let file of photoFiles) {
            const validation = validateFile(file);
            if (!validation.valid) {
                showNotification(validation.error);
                return;
            }
            const formData = new FormData();
            formData.append('file', file);
            const response = await fetch('/api/upload', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Помилка завантаження фото: ${errorData.error || response.statusText}`);
            }
            const data = await response.json();
            product.photos.push(data.url);
        }

        product.photos.push(...newProduct.photos.filter(photo => typeof photo === 'string'));

        for (let i = 0; i < newProduct.colors.length; i++) {
            const color = newProduct.colors[i];
            if (color.photo instanceof File) {
                const validation = validateFile(color.photo);
                if (!validation.valid) {
                    showNotification(validation.error);
                    return;
                }
                const formData = new FormData();
                formData.append('file', color.photo);
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Помилка завантаження фото кольору: ${errorData.error || response.statusText}`);
                }
                const data = await response.json();
                product.colors[i].photo = data.url;
            } else if (typeof color.photo === 'string') {
                product.colors[i].photo = color.photo;
            }
        }

        const response = await fetch('/api/products', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(product)
        });

        if (!response.ok) {
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('adminToken');
                session = { isActive: false, timestamp: 0 };
                localStorage.setItem('adminSession', LZString.compressToUTF16(JSON.stringify(session)));
                showSection('admin-login');
                showNotification('Сесія закінчилася. Будь ласка, увійдіть знову.');
                return;
            }
            const errorData = await response.json();
            throw new Error(`Помилка при додаванні товару: ${errorData.error || response.statusText}`);
        }

        const newProductData = await response.json();
        products.push(newProductData);
        closeModal();
        renderAdmin('products');
        showNotification('Товар додано!');
        await loadProducts();
        unsavedChanges = false;
        resetInactivityTimer();
    } catch (err) {
        console.error('Помилка при додаванні товару:', err);
        showNotification('Не вдалося додати товар: ' + err.message);
    }
}

function openEditProductModal(productId) {
    const product = products.find(p => p.id === productId);
    if (product) {
        newProduct = { ...product, colors: [...product.colors], photos: [...product.photos], sizes: [...product.sizes], groupProducts: [...product.groupProducts] };
        // Екрануємо лапки для HTML, замінюючи " на &quot;
        const escapedName = product.name.replace(/"/g, '&quot;');
        const modal = document.getElementById('modal');
        modal.innerHTML = `
            <div class="modal-content">
                <h3>Редагувати товар #${product.id}</h3>
                <select id="product-type" onchange="updateProductType()">
                    <option value="simple" ${product.type === 'simple' ? 'selected' : ''}>Простий товар</option>
                    <option value="mattresses" ${product.type === 'mattresses' ? 'selected' : ''}>Матраци</option>
                    <option value="group" ${product.type === 'group' ? 'selected' : ''}>Груповий товар</option>
                </select><br/>
                <label for="product-type">Тип товару</label>
                <input type="text" id="product-name" value="${escapedName}"><br/>
                <label for="product-name">Назва товару</label>
                <input type="text" id="product-slug" value="${product.slug || ''}"><br/>
                <label for="product-slug">Шлях товару</label>
                <input type="text" id="product-brand" value="${product.brand || ''}"><br/>
                <label for="product-brand">Виробник</label>
                <select id="product-category">
                    <option value="">Без категорії</option>
                    ${categories.map(c => `<option value="${c.name}" ${c.name === product.category ? 'selected' : ''}>${c.name}</option>`).join('')}
                </select><br/>
                <label for="product-category">Категорія</label>
                <select id="product-subcategory">
                    <option value="">Без підкатегорії</option>
                </select><br/>
                <label for="product-subcategory">Підкатегорія</label>
                <input type="text" id="product-material" value="${product.material || ''}" placeholder="Матеріал"><br/>
                <label for="product-material">Матеріал</label>
                <div id="price-fields"></div>
                <input type="datetime-local" id="product-sale-end" value="${product.saleEnd || ''}"><br/>
                <label for="product-sale-end">Дата закінчення акції</label>
                <select id="product-visible">
                    <option value="true" ${product.visible ? 'selected' : ''}>Показувати на сайті</option>
                    <option value="false" ${!product.visible ? 'selected' : ''}>Не показувати</option>
                </select><br/>
                <label for="product-visible">Видимість</label>
                <div id="product-description-editor"></div>
                <input type="hidden" id="product-description">
                <label for="product-description">Опис товару</label>
                <h4>Розміри</h4>
                <input type="number" id="product-width-cm" value="${product.widthCm || ''}" placeholder="Ширина (см)" min="0" step="0.1"><br/>
                <label for="product-width-cm">Ширина (см)</label>
                <input type="number" id="product-depth-cm" value="${product.depthCm || ''}" placeholder="Глибина (см)" min="0" step="0.1"><br/>
                <label for="product-depth-cm">Глибина (см)</label>
                <input type="number" id="product-height-cm" value="${product.heightCm || ''}" placeholder="Висота (см)" min="0" step="0.1"><br/>
                <label for="product-height-cm">Висота (см)</label>
                <input type="number" id="product-length-cm" value="${product.lengthCm || ''}" placeholder="Довжина (см)" min="0" step="0.1"><br/>
                <label for="product-length-cm">Довжина (см)</label>
                <h4>Фотографії</h4>
                <input type="text" id="product-photo-url" placeholder="URL фотографії"><br/>
                <label for="product-photo-url">URL фотографії</label>
                <input type="file" id="product-photo-file" accept="image/jpeg,image/png,image/gif,image/webp" multiple><br/>
                <label for="product-photo-file">Завантажте фотографію</label>
                <button onclick="addProductPhoto()">Додати фото</button>
                <div id="product-photo-list" class="photo-list"></div>
                <h4>Кольори</h4>
                <input type="text" id="product-color-name" placeholder="Назва кольору"><br/>
                <label for="product-color-name">Назва кольору</label>
                <input type="color" id="product-color-value"><br/>
                <label for="product-color-value">Значення кольору</label>
                <input type="number" id="product-color-price-change" placeholder="Зміна ціни (грн)" step="0.01"><br/>
                <label for="product-color-price-change">Зміна ціни для кольору (грн)</label>
                <input type="text" id="product-color-photo-url" placeholder="URL фото кольору"><br/>
                <label for="product-color-photo-url">URL фото кольору</label>
                <input type="file" id="product-color-photo-file" accept="image/jpeg,image/png,image/gif,image/webp"><br/>
                <label for="product-color-photo-file">Завантажте фото кольору</label>
                <button onclick="addProductColor()">Додати колір</button>
                <div id="product-color-list" class="color-photo-list"></div>
                <div id="mattress-sizes" class="type-specific">
                    <h4>Розміри матраців</h4>
                    <input type="text" id="mattress-size-name" placeholder="Розмір (наприклад, 90x190)"><br/>
                    <label for="mattress-size-name">Розмір</label>
                    <input type="number" id="mattress-size-price" placeholder="Ціна (грн)" min="0"><br/>
                    <label for="mattress-size-price">Ціна (грн)</label>
                    <button onclick="addMattressSize()">Додати розмір</button>
                    <div id="mattress-size-list"></div>
                </div>
                <div id="group-products" class="type-specific">
                    <h4>Групові товари</h4>
                    <div class="group-product-search">
                        <input type="text" id="group-product-search" placeholder="Пошук товарів" oninput="searchGroupProducts()">
                        <div id="group-product-results"></div>
                    </div>
                    <div id="group-product-list"></div>
                </div>
                <div class="modal-actions">
                    <button onclick="saveEditedProduct(${product.id})">Зберегти</button>
                    <button onclick="closeModal()">Скасувати</button>
                </div>
            </div>
        `;
        modal.classList.add('active');
        updateProductType();
        // Передаємо description і descriptionDelta для редагування товару
        initializeProductEditor(product.description || '', product.descriptionDelta || null);
        document.getElementById('product-category').addEventListener('change', updateSubcategories);
        updateSubcategories();
        const subcatSelect = document.getElementById('product-subcategory');
        if (product.subcategory) {
            subcatSelect.value = product.subcategory;
        }
        renderColorsList();
        renderPhotoList();
        renderMattressSizes();
        renderGroupProducts();

        // Обробник для відображення прев’ю основних фото
        const photoInput = document.getElementById('product-photo-file');
        photoInput.addEventListener('change', () => {
            const files = photoInput.files;
            Array.from(files).forEach(file => {
                if (!newProduct.photos.includes(file)) {
                    newProduct.photos.push(file);
                }
            });
            renderPhotoList();
            resetInactivityTimer();
        });

        // Обробник для відображення прев’ю фото кольорів
        const colorPhotoInput = document.getElementById('product-color-photo-file');
        colorPhotoInput.addEventListener('change', () => {
            const file = colorPhotoInput.files[0];
            if (file) {
                const name = document.getElementById('product-color-name').value;
                const value = document.getElementById('product-color-value').value;
                const priceChange = parseFloat(document.getElementById('product-color-price-change').value) || 0;
                if (name && value) {
                    const color = { name, value, priceChange, photo: file };
                    newProduct.colors.push(color);
                    document.getElementById('product-color-name').value = '';
                    document.getElementById('product-color-value').value = '#000000';
                    document.getElementById('product-color-price-change').value = '';
                    document.getElementById('product-color-photo-url').value = '';
                    document.getElementById('product-color-photo-file').value = '';
                    renderColorsList();
                    resetInactivityTimer();
                }
            }
        });

        resetInactivityTimer();
    }
}

async function saveEditedProduct(productId) {
    const name = document.getElementById('product-name').value;
    const slug = document.getElementById('product-slug').value;
    const brand = document.getElementById('product-brand').value;
    const category = document.getElementById('product-category').value;
    const subcategory = document.getElementById('product-subcategory').value;
    const material = document.getElementById('product-material').value;
    let price = null;
    let salePrice = null;
    if (newProduct.type === 'simple') {
        price = parseFloat(document.getElementById('product-price')?.value);
        salePrice = parseFloat(document.getElementById('product-sale-price')?.value) || null;
    }
    const saleEnd = document.getElementById('product-sale-end').value;
    const visible = document.getElementById('product-visible').value === 'true';
    const description = document.getElementById('product-description').value;
    const descriptionDelta = productEditor.getContents();
    const widthCm = parseFloat(document.getElementById('product-width-cm').value) || null;
    const depthCm = parseFloat(document.getElementById('product-depth-cm').value) || null;
    const heightCm = parseFloat(document.getElementById('product-height-cm').value) || null;
    const lengthCm = parseFloat(document.getElementById('product-length-cm').value) || null;

    if (!name || !slug) {
        alert('Введіть назву та шлях товару!');
        return;
    }

    const token = localStorage.getItem('adminToken');
    if (!token) {
        showNotification('Токен відсутній. Будь ласка, увійдіть знову.');
        showSection('admin-login');
        return;
    }

    // Перевірка унікальності slug на сервері (крім поточного товару)
    try {
        const slugCheck = await fetch(`/api/products?slug=${slug}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        if (!slugCheck.ok) {
            if (slugCheck.status === 401 || slugCheck.status === 403) {
                localStorage.removeItem('adminToken');
                session = { isActive: false, timestamp: 0 };
                localStorage.setItem('adminSession', LZString.compressToUTF16(JSON.stringify(session)));
                showSection('admin-login');
                showNotification('Сесія закінчилася. Будь ласка, увійдіть знову.');
                return;
            }
            throw new Error('Помилка перевірки унікальності шляху: ' + slugCheck.statusText);
        }
        const existingProducts = await slugCheck.json();
        if (existingProducts.some(p => p.slug === slug && p.id !== productId)) {
            alert('Шлях товару має бути унікальним!');
            return;
        }
    } catch (err) {
        console.error('Помилка перевірки унікальності шляху:', err);
        showNotification(err.message);
        return;
    }

    if (newProduct.type === 'simple' && (isNaN(price) || price < 0)) {
        alert('Введіть коректну ціну для простого товару!');
        return;
    }

    if (newProduct.type === 'mattresses' && newProduct.sizes.length === 0) {
        alert('Додайте хоча б один розмір для матрацу!');
        return;
    }

    if (newProduct.type === 'group' && newProduct.groupProducts.length === 0) {
        alert('Додайте хоча б один товар до групового товару!');
        return;
    }

    if (brand && !brands.includes(brand)) {
        brands.push(brand);
        localStorage.setItem('brands', LZString.compressToUTF16(JSON.stringify(brands)));
    }

    // Створюємо об’єкт продукту
    let product = {
        id: productId,
        type: newProduct.type,
        name,
        slug,
        brand: brand || '',
        category: category || '',
        subcategory: subcategory || '',
        material: material || '',
        price: newProduct.type === 'simple' ? price : null,
        salePrice: salePrice,
        saleEnd: saleEnd || null,
        description: description || '',
        descriptionDelta: descriptionDelta || null,
        widthCm,
        depthCm,
        heightCm,
        lengthCm,
        photos: [],
        colors: newProduct.colors.map(color => ({
            name: color.name,
            value: color.value,
            priceChange: color.priceChange,
            photo: null
        })),
        sizes: newProduct.sizes,
        groupProducts: newProduct.groupProducts,
        active: newProduct.active,
        visible: visible
    };

    // Перевірка медіа в описі (зображення та відео з blob: URL)
    const mediaUrls = [];
    const parser = new DOMParser();
    const doc = parser.parseFromString(description, 'text/html');
    const images = doc.querySelectorAll('img');
    const videos = doc.querySelectorAll('iframe');

    // Обробка зображень
    for (let img of images) {
        const src = img.getAttribute('src');
        if (src && src.startsWith('blob:')) {
            try {
                const response = await fetch(src);
                const blob = await response.blob();
                const formData = new FormData();
                formData.append('file', blob, `description-image-${Date.now()}.png`);
                const uploadResponse = await fetch('/api/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                const uploadData = await uploadResponse.json();
                if (uploadData.url) {
                    mediaUrls.push({ oldUrl: src, newUrl: uploadData.url });
                } else {
                    throw new Error('Не вдалося завантажити зображення');
                }
            } catch (err) {
                console.error('Помилка завантаження зображення з опису:', err);
                alert('Не вдалося завантажити зображення з опису: ' + err.message);
                return;
            }
        }
    }

    // Оновлюємо description, замінюючи blob: URL на нові URL
    let updatedDescription = description;
    mediaUrls.forEach(({ oldUrl, newUrl }) => {
        updatedDescription = updatedDescription.replace(oldUrl, newUrl);
    });

    // Оновлюємо descriptionDelta
    let updatedDelta = descriptionDelta;
    if (mediaUrls.length > 0) {
        updatedDelta = { ops: [] };
        descriptionDelta.ops.forEach(op => {
            if (op.insert && typeof op.insert === 'object' && op.insert.image) {
                const newUrl = mediaUrls.find(m => m.oldUrl === op.insert.image)?.newUrl || op.insert.image;
                updatedDelta.ops.push({ insert: { image: newUrl }, attributes: op.attributes });
            } else {
                updatedDelta.ops.push(op);
            }
        });
    }

    // Оновлюємо об’єкт продукту з новими description і descriptionDelta
    product.description = updatedDescription;
    product.descriptionDelta = updatedDelta;

    // Завантажуємо основні фотографії
    const photoFiles = newProduct.photos.filter(photo => photo instanceof File);
    for (let file of photoFiles) {
        const validation = validateFile(file);
        if (!validation.valid) {
            alert(validation.error);
            return;
        }
        try {
            const formData = new FormData();
            formData.append('file', file);
            const response = await fetch('/api/upload', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            });
            if (!response.ok) {
                throw new Error(`Помилка завантаження фото: ${response.statusText}`);
            }
            const data = await response.json();
            product.photos.push(data.url);
        } catch (err) {
            console.error('Помилка завантаження фото:', err);
            showNotification('Не вдалося завантажити фото: ' + err.message);
            return;
        }
    }

    // Додаємо URL фотографій, які вже є
    product.photos.push(...newProduct.photos.filter(photo => typeof photo === 'string'));

    // Завантажуємо фотографії кольорів
    for (let i = 0; i < newProduct.colors.length; i++) {
        const color = newProduct.colors[i];
        if (color.photo instanceof File) {
            const validation = validateFile(color.photo);
            if (!validation.valid) {
                alert(validation.error);
                return;
            }
            try {
                const formData = new FormData();
                formData.append('file', color.photo);
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                if (!response.ok) {
                    throw new Error(`Помилка завантаження фото кольору: ${response.statusText}`);
                }
                const data = await response.json();
                product.colors[i].photo = data.url;
            } catch (err) {
                console.error('Помилка завантаження фото кольору:', err);
                showNotification('Не вдалося завантажити фото кольору: ' + err.message);
                return;
            }
        } else if (typeof color.photo === 'string') {
            product.colors[i].photo = color.photo;
        }
    }

    // Відправляємо запит на сервер
    try {
        const response = await fetch(`/api/products/${productId}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(product)
        });

        if (!response.ok) {
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('adminToken');
                session = { isActive: false, timestamp: 0 };
                localStorage.setItem('adminSession', LZString.compressToUTF16(JSON.stringify(session)));
                showSection('admin-login');
                showNotification('Сесія закінчилася. Будь ласка, увійдіть знову.');
                return;
            }
            const errorData = await response.json();
            throw new Error(`Помилка при оновленні товару: ${response.statusText}. Деталі: ${JSON.stringify(errorData)}`);
        }

        const updatedProduct = await response.json();
        const index = products.findIndex(p => p.id === productId);
        products[index] = updatedProduct;
        closeModal();
        renderAdmin('products');
        showNotification('Товар оновлено!');
        await loadProducts(); // Оновлюємо список товарів
        unsavedChanges = false;
        resetInactivityTimer();
    } catch (err) {
        console.error('Помилка при оновленні товару:', err);
        showNotification('Не вдалося оновити товар: ' + err.message);
    }
}

async function deleteProduct(productId) {
    if (confirm('Ви впевнені, що хочете видалити цей товар?')) {
        const token = localStorage.getItem('adminToken');
        if (!token) {
            showNotification('Токен відсутній. Будь ласка, увійдіть знову.');
            showSection('admin-login');
            return;
        }

        try {
            const response = await fetch(`/api/products/${productId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    localStorage.removeItem('adminToken');
                    session = { isActive: false, timestamp: 0 };
                    localStorage.setItem('adminSession', LZString.compressToUTF16(JSON.stringify(session)));
                    showSection('admin-login');
                    showNotification('Сесія закінчилася. Будь ласка, увійдіть знову.');
                    return;
                }
                throw new Error('Помилка при видаленні товару: ' + response.statusText);
            }

            products = products.filter(p => p.id !== productId);
            products.forEach(p => {
                if (p.type === 'group') {
                    p.groupProducts = p.groupProducts.filter(pid => pid !== productId);
                }
            });
            renderAdmin('products');
            showNotification('Товар видалено!');
            unsavedChanges = false;
            resetInactivityTimer();
        } catch (err) {
            console.error('Помилка при видаленні товару:', err);
            showNotification('Не вдалося видалити товар: ' + err.message);
        }
    }
}

async function toggleProductActive(productId) {
    const product = products.find(p => p.id === productId);
    if (product) {
        const token = localStorage.getItem('adminToken');
        if (!token) {
            showNotification('Токен відсутній. Будь ласка, увійдіть знову.');
            showSection('admin-login');
            return;
        }

        const newActiveStatus = !product.active;
        try {
            const response = await fetch(`/api/products/${productId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ ...product, active: newActiveStatus })
            });

            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    localStorage.removeItem('adminToken');
                    session = { isActive: false, timestamp: 0 };
                    localStorage.setItem('adminSession', LZString.compressToUTF16(JSON.stringify(session)));
                    showSection('admin-login');
                    showNotification('Сесія закінчилася. Будь ласка, увійдіть знову.');
                    return;
                }
                const errorText = await response.text();
                throw new Error(`Помилка при оновленні статусу товару: ${response.status} ${response.statusText}. Сервер повернув: ${errorText}`);
            }

            product.active = newActiveStatus; // Оновлюємо статус лише після успішного запиту
            renderAdmin('products');
            showNotification(`Товар ${product.active ? 'активовано' : 'деактивовано'}!`);
            resetInactivityTimer();
        } catch (err) {
            console.error('Помилка при оновленні статусу товару:', err);
            showNotification('Не вдалося оновити статус товару: ' + err.message);
        }
    }
}

    function sortAdminProducts(sortType) {
        const [key, order] = sortType.split('-');
        products.sort((a, b) => {
            let valA, valB;
            if (key === 'id') {
                valA = a.id;
                valB = b.id;
            } else if (key === 'name') {
                valA = a.name.toLowerCase();
                valB = b.name.toLowerCase();
            } else if (key === 'brand') {
                valA = (a.brand || '').toLowerCase();
                valB = (b.brand || '').toLowerCase();
            } else if (key === 'price') {
                valA = a.price || (a.sizes ? Math.min(...a.sizes.map(s => s.price)) : Infinity);
                valB = b.price || (b.sizes ? Math.min(...b.sizes.map(s => s.price)) : Infinity);
            }
            if (valA < valB) return order === 'asc' ? -1 : 1;
            if (valA > valB) return order === 'asc' ? 1 : -1;
            return 0;
        });
        renderAdmin('products');
        resetInactivityTimer();
    }

function sortOrders(sortType) {
    const [key, order] = sortType.split('-');
    orders.sort((a, b) => {
        let valA, valB;
        if (key === 'date') {
            valA = new Date(a.date);
            valB = new Date(b.date);
        } else if (key === 'total') {
            valA = a.total || 0;
            valB = b.total || 0;
        } else if (key === 'status') {
            valA = (a.status || '').toLowerCase();
            valB = (b.status || '').toLowerCase();
        }
        if (valA < valB) return order === 'asc' ? -1 : 1;
        if (valA > valB) return order === 'asc' ? 1 : -1;
        return 0;
    });
    currentPage = 1;
    renderAdmin('orders');
    resetInactivityTimer();
}

function uploadBulkPrices() {
    const file = document.getElementById('bulk-price-file').files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const lines = e.target.result.split('\n').map(line => line.trim()).filter(line => line);
            let updated = 0;
            lines.forEach(line => {
                // Розділяємо рядок, враховуючи, що останні два елементи - це розмір (якщо є) і ціна
                const parts = line.split(',');
                if (parts.length < 4) return; // Пропускаємо некоректні рядки

                const id = parseInt(parts[0].trim());
                const product = products.find(p => p.id === id);
                if (!product) return; // Пропускаємо, якщо товар не знайдено

                if (product.type === 'simple') {
                    // Для простих товарів ціна - це останній елемент
                    const price = parseFloat(parts[parts.length - 1].trim());
                    if (!isNaN(price) && price >= 0) {
                        product.price = price;
                        updated++;
                    }
                } else if (product.type === 'mattresses') {
                    // Для матраців шукаємо "Розмір: розмір" і ціну
                    const sizePart = parts[parts.length - 2].trim();
                    const price = parseFloat(parts[parts.length - 1].trim());
                    if (sizePart.startsWith('Розмір: ')) {
                        const size = sizePart.replace('Розмір: ', '').trim();
                        const sizeObj = product.sizes.find(s => s.name === size);
                        if (sizeObj && !isNaN(price) && price >= 0) {
                            sizeObj.price = price;
                            updated++;
                        }
                    }
                }
            });
            localStorage.setItem('products', LZString.compressToUTF16(JSON.stringify(products)));
            renderAdmin('products');
            showNotification(`Оновлено цін для ${updated} товарів!`);
            resetInactivityTimer();
        };
        reader.readAsText(file);
    } else {
        alert('Виберіть файл для завантаження!');
    }
}

    function exportPrices() {
        const exportData = products
            .filter(p => p.active && p.type !== 'group')
            .map(p => {
                if (p.type === 'simple') {
                    return `${p.id},${p.name},${p.brand || 'Без бренду'},${p.price || '0'}`;
                } else if (p.type === 'mattresses') {
                    return p.sizes.map(s => `${p.id},${p.name},${p.brand || 'Без бренду'},Розмір: ${s.name},${s.price || '0'}`).join('\n');
                }
                return '';
            })
            .filter(line => line)
            .join('\n');
        const blob = new Blob([exportData], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'prices-export.txt';
        a.click();
        URL.revokeObjectURL(url);
        showNotification('Ціни експортовано!');
        resetInactivityTimer();
    }

    function renderCountdown(product) {
        if (product.saleEnd) {
            const endDate = new Date(product.saleEnd).getTime();
            const now = new Date().getTime();
            const timeLeft = endDate - now;
            if (timeLeft > 0) {
                const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                return `<span class="sale-countdown">Залишилось: ${days}д ${hours}г ${minutes}хв</span>`;
            }
        }
        return '';
    }

function viewOrder(index) {
    const order = orders[index];
    if (order) {
        // Форматуємо дату в локальний часовий пояс
        const orderDate = new Date(order.date);
        const formattedDate = orderDate.toLocaleString('uk-UA', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });

        const modal = document.getElementById('modal');
        modal.innerHTML = `
            <div class="modal-content">
                <h3>Замовлення #${index + 1}</h3>
                <p>Дата: ${formattedDate}</p>
                <p>Статус: ${order.status || 'Н/Д'}</p>
                <p>Сума: ${order.total ? order.total + ' грн' : 'Н/Д'}</p>
                <h4>Дані клієнта:</h4>
                ${
                    order.customer && typeof order.customer === 'object'
                        ? Object.entries(order.customer).map(([key, value]) => {
                              const field = orderFields.find(f => f.name === key);
                              return `<p>${field ? field.label : key}: ${value}</p>`;
                          }).join('')
                        : '<p>Дані клієнта відсутні.</p>'
                }
                <h4>Товари:</h4>
                ${
                    order.items && Array.isArray(order.items) && order.items.length > 0
                        ? order.items.map(item => {
                              const product = products.find(p => p.id === item.id);
                              const colorInfo = item.color && item.color.trim() !== '' ? `, Колір: ${item.color}` : '';
                              return product
                                  ? `<p>${product.name}${colorInfo} - ${item.quantity} шт. - ${item.price} грн</p>`
                                  : `<p>Товар #${item.id} (видалений)${colorInfo} - ${item.quantity} шт. - ${item.price} грн</p>`;
                          }).join('')
                        : '<p>Товари відсутні.</p>'
                }
                <div class="modal-actions">
                    <button onclick="closeModal()">Закрити</button>
                </div>
            </div>
        `;
        modal.classList.add('active');
        resetInactivityTimer();
    } else {
        showNotification('Замовлення не знайдено!');
    }
}

function changeOrderStatus(index) {
    const order = orders[index];
    if (order) {
        const modal = document.getElementById('modal');
        modal.innerHTML = `
            <div class="modal-content">
                <h3>Змінити статус замовлення #${index + 1}</h3>
                <p>Поточний статус: ${order.status || 'Н/Д'}</p>
                <select id="new-order-status">
                    <option value="Нове замовлення" ${order.status === 'Нове замовлення' ? 'selected' : ''}>Нове замовлення</option>
                    <option value="В обробці" ${order.status === 'В обробці' ? 'selected' : ''}>В обробці</option>
                    <option value="Відправлено" ${order.status === 'Відправлено' ? 'selected' : ''}>Відправлено</option>
                    <option value="Завершено" ${order.status === 'Завершено' ? 'selected' : ''}>Завершено</option>
                </select><br/>
                <label for="new-order-status">Новий статус</label>
                <div class="modal-actions">
                    <button onclick="saveOrderStatus(${index})">Зберегти</button>
                    <button onclick="closeModal()">Скасувати</button>
                </div>
            </div>
        `;
        modal.classList.add('active');
        resetInactivityTimer();
    }
}

function saveOrderStatus(index) {
    const order = orders[index];
    const newStatus = document.getElementById('new-order-status').value;
    if (newStatus) {
        order.status = newStatus;
        localStorage.setItem('orders', LZString.compressToUTF16(JSON.stringify(orders)));
        closeModal();
        renderAdmin('orders');
        showNotification('Статус замовлення змінено!');
        resetInactivityTimer();
    }
}

    function deleteOrder(index) {
        if (confirm('Ви впевнені, що хочете видалити це замовлення?')) {
            orders.splice(index, 1);
            localStorage.setItem('orders', LZString.compressToUTF16(JSON.stringify(orders)));
            renderAdmin('orders');
            showNotification('Замовлення видалено!');
            unsavedChanges = false;
            resetInactivityTimer();
        }
    }

    function sortOrders(criteria) {
        const [key, direction] = criteria.split('-');
        orders.sort((a, b) => {
            let valA = key === 'date' ? new Date(a[key]) : a[key];
            let valB = key === 'date' ? new Date(b[key]) : b[key];
            if (direction === 'asc') {
                return typeof valA === 'string' ? valA.localeCompare(valB) : valA - valB;
            } else {
                return typeof valA === 'string' ? valB.localeCompare(valA) : valB - valA;
            }
        });
        currentPage = 1;
        renderAdmin('orders');
        resetInactivityTimer();
    }

    function filterOrders() {
        currentPage = 1;
        renderAdmin('orders');
        resetInactivityTimer();
    }

if (session.isActive && (Date.now() - session.timestamp) < sessionTimeout && localStorage.getItem('adminToken')) {
    showSection('admin-panel');
    loadInitialData(); // Додано раніше для завантаження даних з сервера
    connectWebSocket(); // Додаємо виклик WebSocket
    resetInactivityTimer();
} else {
    localStorage.removeItem('adminToken');
    session = { isActive: false, timestamp: 0 };
    localStorage.setItem('adminSession', LZString.compressToUTF16(JSON.stringify(session)));
    showSection('admin-login');
}

    document.addEventListener('mousemove', resetInactivityTimer);
    document.addEventListener('keypress', resetInactivityTimer);
document.addEventListener('DOMContentLoaded', () => {
    const loginBtn = document.getElementById('login-btn');
    if (loginBtn) loginBtn.addEventListener('click', login);

    // Ініціалізуємо редактор одразу, якщо панель активна
    if (session.isActive && localStorage.getItem('adminToken')) {
        showSection('admin-panel');
        initializeEditors(); // Ініціалізуємо редактор одразу
        loadInitialData().then(() => {
            connectWebSocket();
        });
    } else {
        showSection('admin-login');
    }
});
  </script>
 </body>
</html>