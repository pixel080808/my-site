<!DOCTYPE html>
<html lang="uk">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>
   –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å
  </title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js">
  </script>
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js">
  </script>
  <style>
   body {
            font-family: 'Roboto', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }
        .content {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            display: none;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .section.active {
            display: block;
        }
        h2, h3, h4 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        input, textarea, select {
            margin: 8px 0 2px 0;
            padding: 10px;
            width: 100%;
            max-width: 350px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }
        label {
            display: block;
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 2px;
            margin-bottom: 8px;
        }
        button {
            padding: 10px 20px;
            background: #3498db;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
            font-size: 14px;
        }
        button:hover {
            background: #2980b9;
        }
        .edit-btn {
            background: #27ae60;
        }
        .edit-btn:hover {
            background: #219653;
        }
        .delete-btn {
            background: #e74c3c;
        }
        .delete-btn:hover {
            background: #c0392b;
        }
        .toggle-btn {
            background: #f1c40f;
            color: #333;
        }
        .toggle-btn:hover {
            background: #d4ac0d;
        }
        .move-btn {
            background: #95a5a6;
            padding: 5px 10px;
            font-size: 12px;
        }
        .move-btn:hover {
            background: #7f8c8d;
        }
        .admin-tabs {
            margin: 20px 0;
            display: flex;
            gap: 5px;
        }
        .tab-btn {
            background: #ecf0f1;
            color: #7f8c8d;
            padding: 10px 20px;
            border-radius: 4px 4px 0 0;
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            background: #3498db;
            color: #fff;
        }
        .admin-tab {
            display: none;
        }
        .admin-tab.active {
            display: block;
        }
        .admin-section {
            margin-bottom: 25px;
            padding: 15px;
            background: #fafafa;
            border-radius: 6px;
        }
        .product-admin-item, #product-list-header {
            display: grid;
            grid-template-columns: 5% 15% 25% 15% 10% 10% 20%; /* –ó–±—ñ–ª—å—à—É—î–º–æ –∫–æ–ª–æ–Ω–∫—É "–°—Ç–∞—Ç—É—Å" –¥–æ 20% */
            align-items: center;
            padding: 10px;
            background: #fff;
            margin: 5px 0;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        #product-list-header {
            font-weight: bold;
            background: #ecf0f1;
        }
        .product-admin-item > span, #product-list-header > span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 0 5px;
            text-align: center; /* –¶–µ–Ω—Ç—Ä—É—î–º–æ —Ç–µ–∫—Å—Ç —É –≤—Å—ñ—Ö –∫–æ–ª–æ–Ω–∫–∞—Ö */
        }
        .product-admin-item .status-column {
            display: flex;
            flex-wrap: wrap; /* –î–æ–∑–≤–æ–ª—è—î–º–æ –∫–Ω–æ–ø–∫–∞–º –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç–∏—Å—è –Ω–∞ –Ω–æ–≤–∏–π —Ä—è–¥–æ–∫, —è–∫—â–æ –Ω–µ –≤–º—ñ—â–∞—é—Ç—å—Å—è */
            gap: 5px;
            justify-content: center; /* –¶–µ–Ω—Ç—Ä—É—î–º–æ –∫–Ω–æ–ø–∫–∏ –≤ –∫–æ–ª–æ–Ω—Ü—ñ */
            padding: 5px;
        }
        .product-admin-item .status-column button {
            padding: 6px 10px;
            font-size: 14px;
        }
        .pagination {
            text-align: center;
            margin-top: 20px;
        }
        .pagination button {
            margin: 0 5px;
            padding: 8px 12px;
            background: #ecf0f1;
            color: #333;
        }
        .pagination button.active {
            background: #3498db;
            color: #fff;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
        }
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }
.modal-content {
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    max-width: 500px;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    position: relative;
    /* –î–æ–¥–∞—î–º–æ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π –≤—ñ–¥—Å—Ç—É–ø –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
    padding-bottom: 40px;
}
        .modal-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #2ecc71;
            color: #fff;
            padding: 10px 20px;
            border-radius: 4px;
            display: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .notification.active {
            display: block;
        }
        .sort-menu {
            position: relative;
            display: inline-block;
        }
        .sort-btn {
            background: #ecf0f1;
            color: #333;
        }
        .sort-dropdown {
            display: none;
            position: absolute;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .sort-menu:hover .sort-dropdown {
            display: block;
        }
        .sort-dropdown button {
            display: block;
            width: 100%;
            text-align: left;
            background: none;
            color: #333;
            border: none;
            padding: 8px 12px;
        }
        .sort-dropdown button:hover {
            background: #f5f5f5;
        }
        .color-item, .photo-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            gap: 10px;
        }
        .color-item img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
        }
        #cat-list {
            margin-top: 10px;
        }
        #cat-list .category-item {
            margin: 10px 0;
            font-weight: bold;
            padding-left: 5px;
            background-color: #e0f7fa;
            border-left: 4px solid #3498db;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #cat-list .subcat-list {
            margin-left: 40px;
        }
        #cat-list .subcat-list p {
            font-weight: normal;
            margin: 5px 0;
            background-color: #f0f0f0;
            border-left: 4px solid #27ae60;
            padding-left: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .type-specific {
            display: none;
        }
        .type-specific.active {
            display: block;
        }
        .color-preview {
            width: 20px;
            height: 20px;
            border: 1px solid #ddd;
            display: inline-block;
            vertical-align: middle;
        }
        .editor-toolbar {
            margin-bottom: 10px;
        }
        .editor-toolbar button {
            padding: 5px 10px;
            font-size: 12px;
            margin-right: 5px;
        }
        .photo-list, .color-photo-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 5px;
            margin-top: 10px;
        }
        .photo-item.draggable {
            cursor: move;
            padding: 5px;
            border: 1px dashed #ddd;
            margin: 5px 0;
        }
        .photo-item.dragging {
            opacity: 0.5;
        }
        .filter-options {
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .filter-options label {
            font-size: 14px;
            color: #7f8c8d;
        }
        .filter-options select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            max-width: 200px;
        }
        .sale-info {
            color: #e74c3c;
            font-weight: bold;
        }
        .sale-countdown {
            color: #e74c3c;
            font-size: 12px;
        }
        .group-product-search {
            margin-bottom: 10px;
        }
        .group-product-search input {
            width: 100%;
            max-width: 300px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .custom-select-wrapper {
            position: relative;
            width: 100%;
            max-width: 300px;
        }
        .custom-select {
            position: relative;
        }
        .custom-select select {
            display: none;
        }
        .custom-select-trigger {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .custom-options {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
        }
        .custom-options.active {
            display: block;
        }
        .custom-option {
            padding: 8px 12px;
            cursor: pointer;
        }
        .custom-option:hover {
            background: #f5f5f5;
        }
        .custom-option.selected {
            background: #3498db;
            color: #fff;
        }
        .custom-select-search {
            width: 100%;
            padding: 8px;
            border: none;
            border-bottom: 1px solid #ddd;
            box-sizing: border-box;
        }
        .mattress-size, .group-product {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
        }
        .social-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
        }
        .social-icon {
            font-size: 16px;
        }
        .orders-section {
            padding: 20px;
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #fff;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        .order-item:hover {
            transform: translateY(-2px);
        }
        .order-item span {
            font-size: 14px;
            color: #2c3e50;
        }
        .order-item button {
            margin-left: 10px;
        }
.backup-group {
    margin-bottom: 15px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
}
.product-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    margin-bottom: 15px; /* –î–æ–¥–∞—î–º–æ –≤—ñ–¥—Å—Ç—É–ø –∑–Ω–∏–∑—É */
}

.import-group {
    display: flex;
    align-items: center;
    gap: 10px;
}

.import-group input[type="file"] {
    display: none; /* –ü—Ä–∏—Ö–æ–≤—É—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π input */
}

.import-btn {
    background: #2ecc71;
    padding: 10px 20px;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.3s ease;
    font-size: 14px;
}

.import-btn:hover {
    background: #27ae60;
}

/* –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –∑–º—ñ–Ω–∏ —Ä–æ–∑–º—ñ—Ä—ñ–≤ */
.resize-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 1001; /* –í–∏—â–µ, –Ω—ñ–∂ –æ—Å–Ω–æ–≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ */
    justify-content: center;
    align-items: center;
}

.resize-modal.active {
    display: flex;
}

.resize-modal-content {
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    max-width: 400px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    position: relative;
}

.resize-modal-content h4 {
    margin-top: 0;
    color: #2c3e50;
}

.resize-modal-content input {
    width: 100%;
    margin: 5px 0;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.resize-modal-actions {
    margin-top: 15px;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

/* –°—Ç–∏–ª—å –¥–ª—è –≤–∏–¥—ñ–ª–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è/–≤—ñ–¥–µ–æ –ø—Ä–∏ –∫–ª—ñ–∫—É */
.quill-media-selected {
    border: 2px solid #3498db;
    box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
}

/* –ó–∞–º—ñ–Ω–∏—Ç–∏ –ø–æ—Ç–æ—á–Ω—ñ —Å—Ç–∏–ª—ñ –¥–ª—è undo/redo */
.ql-toolbar .ql-undo,
.ql-toolbar .ql-redo {
    background: none;
    border: none;
    padding: 8px;
    cursor: pointer;
    color: #333;
    font-size: 16px;
    line-height: 1;
    transition: background 0.3s ease;
}

.ql-toolbar .ql-undo::before,
.ql-toolbar .ql-redo::before {
    font-family: 'Arial', sans-serif;
    display: inline-block;
    width: 16px;
    height: 16px;
}

.ql-toolbar .ql-undo::before {
    content: '‚Ü∂';
}

.ql-toolbar .ql-redo::before {
    content: '‚Ü∑';
}

.ql-toolbar .ql-undo:hover,
.ql-toolbar .ql-redo:hover {
    background: #e0e0e0;
}

.ql-toolbar .ql-undo[disabled],
.ql-toolbar .ql-redo[disabled] {
    color: #ccc;
    cursor: not-allowed;
}

@media (max-width: 768px) {
    .product-admin-item, #product-list-header {
        grid-template-columns: 1fr; /* –ü–µ—Ä–µ–∫–ª—é—á–∞—î–º–æ –Ω–∞ –æ–¥–Ω—É –∫–æ–ª–æ–Ω–∫—É */
        text-align: left; /* –í–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è —Ç–µ–∫—Å—Ç—É –∑–ª—ñ–≤–∞ –¥–ª—è –∫—Ä–∞—â–æ—ó —á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—ñ */
    }
    .product-admin-item > span, #product-list-header > span {
        padding: 5px;
        text-align: left;
    }
    .product-admin-item .status-column {
        flex-direction: column; /* –ö–Ω–æ–ø–∫–∏ –≤ –∫–æ–ª–æ–Ω–∫—É */
        align-items: flex-start;
    }
}
  </style>
 </head>
 <body>
  <div class="content">
<div class="section active" id="admin-login">
    <h2>–í—Ö—ñ–¥ –≤ –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</h2>
    <input id="admin-username" placeholder="–õ–æ–≥—ñ–Ω" type="text"/><br/>
    <label for="admin-username">–í–≤–µ–¥—ñ—Ç—å –ª–æ–≥—ñ–Ω</label>
    <input id="admin-password" placeholder="–ü–∞—Ä–æ–ª—å" type="password"/><br/>
    <label for="admin-password">–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å</label>
    <button id="login-btn">–£–≤—ñ–π—Ç–∏</button>
</div>
<div class="section" id="admin-panel">
    <h2>–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</h2>
    <button onclick="logout()" style="position: absolute; top: 20px; right: 20px;">–í–∏–π—Ç–∏</button>
    <div class="admin-tabs">
        <button class="tab-btn active" onclick="showAdminTab('site-editing')">–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Å–∞–π—Ç—É</button>
        <button class="tab-btn" onclick="showAdminTab('products')">–¢–æ–≤–∞—Ä–∏</button>
        <button class="tab-btn" onclick="showAdminTab('orders')">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
    </div>
    <div class="admin-tab active" id="site-editing">
        <!-- –õ–æ–≥–æ—Ç–∏–ø —Ç–∞ –Ω–∞–∑–≤–∞ -->
        <div class="admin-section">
            <h3>–õ–æ–≥–æ—Ç–∏–ø —Ç–∞ –Ω–∞–∑–≤–∞</h3>
            <form id="store-info-form" onsubmit="event.preventDefault(); updateStoreInfo();">
                <input id="store-name" placeholder="–ù–∞–∑–≤–∞ –º–∞–≥–∞–∑–∏–Ω—É" type="text"/><br/>
                <label for="store-name">–ù–∞–∑–≤–∞ –º–∞–≥–∞–∑–∏–Ω—É</label>
                <input id="base-url" placeholder="–ë–∞–∑–æ–≤–∏–π URL (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, https://www.yourdomain.com)" type="text"/><br/>
                <label for="base-url">–ë–∞–∑–æ–≤–∏–π URL —Å–∞–π—Ç—É</label>
                <input class="logo-input" id="logo-url" placeholder="URL –ª–æ–≥–æ—Ç–∏–ø—É" type="text"/><br/>
                <label for="logo-url">URL –ª–æ–≥–æ—Ç–∏–ø—É</label>
                <input accept="image/*" id="logo-file" type="file"/><br/>
                <label for="logo-file">–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –ª–æ–≥–æ—Ç–∏–ø</label>
                <input id="logo-width" max="500" min="50" placeholder="–®–∏—Ä–∏–Ω–∞ –ª–æ–≥–æ—Ç–∏–ø—É (px)" type="number"/><br/>
                <label for="logo-width">–®–∏—Ä–∏–Ω–∞ –ª–æ–≥–æ—Ç–∏–ø—É (px)</label>
                <input id="favicon-url" placeholder="URL favicon" type="text"/><br/>
                <label for="favicon-url">URL favicon</label>
                <input accept="image/*" id="favicon-file" type="file"/><br/>
                <label for="favicon-file">–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ favicon</label>
                <button type="submit">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            </form>
        </div>
        <!-- –ö–æ–Ω—Ç–∞–∫—Ç–∏ -->
        <div class="admin-section">
            <h3>–ö–æ–Ω—Ç–∞–∫—Ç–∏</h3>
            <form id="contacts-form" onsubmit="event.preventDefault(); updateContacts();">
                <textarea id="contact-phones" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω–∏"></textarea><br/>
                <label for="contact-phones">–¢–µ–ª–µ—Ñ–æ–Ω–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, +38 (067) 123-45-67)</label>
                <textarea id="contact-addresses" placeholder="–ê–¥—Ä–µ—Å–∏"></textarea><br/>
                <label for="contact-addresses">–ê–¥—Ä–µ—Å–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –º. –ö–∏—ó–≤, –≤—É–ª. –ú–µ–±–ª–µ–≤–∞, 1)</label>
                <textarea id="contact-schedule" placeholder="–ì—Ä–∞—Ñ—ñ–∫ —Ä–æ–±–æ—Ç–∏"></textarea><br/>
                <label for="contact-schedule">–ì—Ä–∞—Ñ—ñ–∫ —Ä–æ–±–æ—Ç–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ü–Ω-–ü—Ç: 9:00-18:00)</label>
                <button type="submit">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            </form>
        </div>
        <!-- –°–æ—Ü—ñ–∞–ª—å–Ω—ñ –º–µ—Ä–µ–∂—ñ -->
        <div class="admin-section">
            <h3>–°–æ—Ü—ñ–∞–ª—å–Ω—ñ –º–µ—Ä–µ–∂—ñ</h3>
            <form id="social-form" onsubmit="event.preventDefault(); addSocial();">
                <input id="social-url" placeholder="–ü–æ—Å–∏–ª–∞–Ω–Ω—è" type="text"/><br/>
                <label for="social-url">URL —Å–æ—Ü–º–µ—Ä–µ–∂—ñ</label>
                <select id="social-icon">
                    <option value="üîó">–ó–∞–≥–∞–ª—å–Ω–∏–π (üîó)</option>
                    <option value="üìò">Facebook (üìò)</option>
                    <option value="üì∏">Instagram (üì∏)</option>
                    <option value="üê¶">Twitter (üê¶)</option>
                    <option value="‚ñ∂Ô∏è">YouTube (‚ñ∂Ô∏è)</option>
                    <option value="‚úàÔ∏è">Telegram (‚úàÔ∏è)</option>
                </select><br/>
                <label for="social-icon">–Ü–∫–æ–Ω–∫–∞ —Å–æ—Ü–º–µ—Ä–µ–∂—ñ</label>
                <button type="submit">–î–æ–¥–∞—Ç–∏</button>
            </form>
            <label>
                <input id="social-toggle" onchange="toggleSocials()" type="checkbox"/>
                –ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ —Å–æ—Ü—ñ–∞–ª—å–Ω—ñ –º–µ—Ä–µ–∂—ñ
            </label>
            <div id="social-list"></div>
        </div>
        <!-- –ü—Ä–æ –Ω–∞—Å -->
        <div class="admin-section">
            <h3>–ü—Ä–æ –Ω–∞—Å</h3>
            <form id="about-form" onsubmit="event.preventDefault(); updateAbout();">
                <div id="about-editor"></div>
                <input id="about-edit" type="hidden"/>
                <label for="about-edit">–û–ø–∏—Å "–ü—Ä–æ –Ω–∞—Å"</label>
                <button type="submit">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            </form>
        </div>
        <!-- –ö–∞—Ç–µ–≥–æ—Ä—ñ—ó -->
        <div class="admin-section">
            <h3>–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó</h3>
            <form id="category-form" onsubmit="event.preventDefault(); addCategory();">
                <input id="cat-name" placeholder="–ù–∞–∑–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó" type="text"/><br/>
                <label for="cat-name">–ù–∞–∑–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</label>
                <input id="cat-slug" placeholder="–®–ª—è—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, kuhni)" type="text"/><br/>
                <label for="cat-slug">–®–ª—è—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</label>
                <input id="cat-img-url" placeholder="URL –∫–∞—Ä—Ç–∏–Ω–∫–∏ (300x200)" type="text"/><br/>
                <label for="cat-img-url">URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</label>
                <input accept="image/*" id="cat-img-file" type="file"/><br/>
                <label for="cat-img-file">–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</label>
                <button type="submit">–î–æ–¥–∞—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</button>
            </form>
            <div id="cat-list"></div>
            <h4>–ü—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</h4>
            <form id="subcategory-form" onsubmit="event.preventDefault(); addSubcategory();">
                <input id="subcat-name" placeholder="–ù–∞–∑–≤–∞ –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó" type="text"/><br/>
                <label for="subcat-name">–ù–∞–∑–≤–∞ –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</label>
                <input id="subcat-slug" placeholder="–®–ª—è—Ö –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, kuhni-naborom)" type="text"/><br/>
                <label for="subcat-slug">–®–ª—è—Ö –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</label>
                <input id="subcat-img-url" placeholder="URL –∫–∞—Ä—Ç–∏–Ω–∫–∏ (150x150)" type="text"/><br/>
                <label for="subcat-img-url">URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</label>
                <input accept="image/*" id="subcat-img-file" type="file"/><br/>
                <label for="subcat-img-file">–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</label>
                <select id="subcat-category">
                    <option value="">–í–∏–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</option>
                </select><br/>
                <label for="subcat-category">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è –¥–ª—è –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</label>
                <button type="submit">–î–æ–¥–∞—Ç–∏ –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—é</button>
            </form>
        </div>
        <!-- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π -->
        <div class="admin-section">
            <h3>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π</h3>
            <form id="category-settings-form" onsubmit="event.preventDefault(); updateCategorySettings();">
                <input id="category-width" max="500" min="100" placeholder="–®–∏—Ä–∏–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó (px, 100-500)" type="number"/><br/>
                <label for="category-width">–®–∏—Ä–∏–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó (px)</label>
                <input id="category-height" max="500" min="100" placeholder="–í–∏—Å–æ—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó (px, 100-500)" type="number"/><br/>
                <label for="category-height">–í–∏—Å–æ—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó (px)</label>
                <button type="submit">–ó–±–µ—Ä–µ–≥—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
            </form>
        </div>
        <!-- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤ -->
        <div class="admin-section">
            <h3>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤</h3>
            <form id="product-settings-form" onsubmit="event.preventDefault(); updateProductSettings();">
                <input id="product-width" max="500" min="200" placeholder="–®–∏—Ä–∏–Ω–∞ —Ç–æ–≤–∞—Ä—É (px, 200-500)" type="number"/><br/>
                <label for="product-width">–®–∏—Ä–∏–Ω–∞ —Ç–æ–≤–∞—Ä—É (px)</label>
                <input id="product-height" max="500" min="200" placeholder="–í–∏—Å–æ—Ç–∞ —Ç–æ–≤–∞—Ä—É (px, 200-500)" type="number"/><br/>
                <label for="product-height">–í–∏—Å–æ—Ç–∞ —Ç–æ–≤–∞—Ä—É (px)</label>
                <button type="submit">–ó–±–µ—Ä–µ–≥—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
            </form>
        </div>
        <!-- –§—ñ–ª—å—Ç—Ä–∏ -->
        <div class="admin-section">
            <h3>–§—ñ–ª—å—Ç—Ä–∏</h3>
            <form id="filter-form" onsubmit="event.preventDefault(); addFilter();">
                <input id="filter-name" placeholder="–ù–∞–∑–≤–∞ (–∞–Ω–≥–ª.)" type="text"/><br/>
                <label for="filter-name">–ù–∞–∑–≤–∞ —Ñ—ñ–ª—å—Ç—Ä—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, brand)</label>
                <input id="filter-label" placeholder="–ü—ñ–¥–ø–∏—Å" type="text"/><br/>
                <label for="filter-label">–í—ñ–¥–æ–±—Ä–∞–∂—É–≤–∞–Ω–∞ –Ω–∞–∑–≤–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –í–∏—Ä–æ–±–Ω–∏–∫)</label>
                <input id="filter-options" placeholder="–û–ø—Ü—ñ—ó (—á–µ—Ä–µ–∑ –∫–æ–º—É)" type="text"/><br/>
                <label for="filter-options">–û–ø—Ü—ñ—ó (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ì–µ—Ä–±–æ—Ä, Matroluxe)</label>
                <button type="submit">–î–æ–¥–∞—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä</button>
            </form>
            <div id="filter-list-admin"></div>
        </div>
        <!-- –ü–æ–ª—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è -->
        <div class="admin-section">
            <h3>–ü–æ–ª—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h3>
            <form id="order-field-form" onsubmit="event.preventDefault(); addOrderField();">
                <input id="order-field-name" placeholder="–ù–∞–∑–≤–∞ (–∞–Ω–≥–ª.)" type="text"/><br/>
                <label for="order-field-name">–ù–∞–∑–≤–∞ –ø–æ–ª—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, name)</label>
                <input id="order-field-label" placeholder="–ü—ñ–¥–ø–∏—Å" type="text"/><br/>
                <label for="order-field-label">–í—ñ–¥–æ–±—Ä–∞–∂—É–≤–∞–Ω–∞ –Ω–∞–∑–≤–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –Ü–º'—è)</label>
                <select id="order-field-type">
                    <option value="text">–¢–µ–∫—Å—Ç</option>
                    <option value="email">Email</option>
                    <option value="select">–í–∏–±—ñ—Ä</option>
                </select><br/>
                <label for="order-field-type">–¢–∏–ø –ø–æ–ª—è</label>
                <input id="order-field-options" placeholder="–û–ø—Ü—ñ—ó (—á–µ—Ä–µ–∑ –∫–æ–º—É, –¥–ª—è select)" type="text"/><br/>
                <label for="order-field-options">–û–ø—Ü—ñ—ó –¥–ª—è –≤–∏–±–æ—Ä—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ì–æ—Ç—ñ–≤–∫–æ—é, –ö–∞—Ä—Ç–∫–æ—é)</label>
                <button type="submit">–î–æ–¥–∞—Ç–∏ –ø–æ–ª–µ</button>
            </form>
            <div id="order-field-list"></div>
        </div>
        <!-- –°–ª–∞–π–¥—à–æ—É -->
        <div class="admin-section">
            <h3>–°–ª–∞–π–¥—à–æ—É</h3>
            <form id="slideshow-settings-form" onsubmit="event.preventDefault(); updateSlideshowSettings();">
                <input id="slide-width" max="100" min="10" placeholder="–®–∏—Ä–∏–Ω–∞ —Å–ª–∞–π–¥—É (%, 10-100)" type="number"/><br/>
                <label for="slide-width">–®–∏—Ä–∏–Ω–∞ —Å–ª–∞–π–¥—É (%)</label>
                <input id="slide-height" max="500" min="100" placeholder="–í–∏—Å–æ—Ç–∞ —Å–ª–∞–π–¥—É (px, 100-500)" type="number"/><br/>
                <label for="slide-height">–í–∏—Å–æ—Ç–∞ —Å–ª–∞–π–¥—É (px)</label>
                <input id="slide-interval" placeholder="–Ü–Ω—Ç–µ—Ä–≤–∞–ª (–º—Å)" type="number"/><br/>
                <label for="slide-interval">–Ü–Ω—Ç–µ—Ä–≤–∞–ª —Å–ª–∞–π–¥—ñ–≤ (–º—Å)</label>
                <button type="submit">–ó–±–µ—Ä–µ–≥—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
            </form>
            <form id="slide-form" onsubmit="event.preventDefault(); addSlide();">
                <input id="slide-img-url" placeholder="URL –∫–∞—Ä—Ç–∏–Ω–∫–∏" type="text"/><br/>
                <label for="slide-img-url">URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å–ª–∞–π–¥—É</label>
                <input accept="image/*" id="slide-img-file" type="file"/><br/>
                <label for="slide-img-file">–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</label>
                <input id="slide-title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–ª–∞–π–¥—É" type="text"/><br/>
                <label for="slide-title">–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–ª–∞–π–¥—É</label>
                <input id="slide-text" placeholder="–¢–µ–∫—Å—Ç —Å–ª–∞–π–¥—É" type="text"/><br/>
                <label for="slide-text">–¢–µ–∫—Å—Ç —Å–ª–∞–π–¥—É</label>
                <input id="slide-link" placeholder="–ü–æ—Å–∏–ª–∞–Ω–Ω—è" type="text"/><br/>
                <label for="slide-link">–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–ª–∞–π–¥—É</label>
                <input id="slide-link-text" placeholder="–¢–µ–∫—Å—Ç –ø–æ—Å–∏–ª–∞–Ω–Ω—è" type="text"/><br/>
                <label for="slide-link-text">–¢–µ–∫—Å—Ç –ø–æ—Å–∏–ª–∞–Ω–Ω—è</label>
                <input id="slide-order" placeholder="–ü–æ—Ä—è–¥–∫–æ–≤–∏–π –Ω–æ–º–µ—Ä" type="number"/><br/>
                <label for="slide-order">–ü–æ—Ä—è–¥–æ–∫ —Å–ª–∞–π–¥—É</label>
                <button type="submit">–î–æ–¥–∞—Ç–∏ —Å–ª–∞–π–¥</button>
            </form>
            <label>
                <input id="slide-toggle" onchange="toggleSlideshow()" type="checkbox"/>
                –ü–æ–∫–∞–∑–∞—Ç–∏ —Å–ª–∞–π–¥—à–æ—É
            </label>
            <div id="slide-list"></div>
        </div>
        <!-- –ë–µ–∫–∞–ø -->
        <div class="admin-section">
            <h3>–ë–µ–∫–∞–ø</h3>
            <div class="backup-group">
                <button onclick="exportSiteBackup()">–ï–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ (–°–∞–π—Ç)</button>
                <div class="import-group">
                    <input accept=".json" id="import-site-file" style="display: none;" type="file"/>
                    <button class="import-btn" onclick="document.getElementById('import-site-file').click()">–Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ —Ñ–∞–π–ª (–°–∞–π—Ç)</button>
                </div>
            </div>
            <div class="backup-group">
                <button onclick="exportProductsBackup()">–ï–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ (–¢–æ–≤–∞—Ä–∏)</button>
                <div class="import-group">
                    <input accept=".json" id="import-products-file" style="display: none;" type="file"/>
                    <button class="import-btn" onclick="document.getElementById('import-products-file').click()">–Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ —Ñ–∞–π–ª (–¢–æ–≤–∞—Ä–∏)</button>
                </div>
            </div>
            <div class="backup-group">
                <button onclick="exportOrdersBackup()">–ï–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ (–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è)</button>
                <div class="import-group">
                    <input accept=".json" id="import-orders-file" style="display: none;" type="file"/>
                    <button class="import-btn" onclick="document.getElementById('import-orders-file').click()">–Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ —Ñ–∞–π–ª (–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è)</button>
                </div>
            </div>
            <div class="backup-group">
                <button onclick="downloadSitemap()">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ Sitemap</button>
            </div>
        </div>
    </div>
    <!-- –¢–æ–≤–∞—Ä–∏ —Ç–∞ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω -->
    <div class="admin-tab" id="products">
        <div class="admin-section">
            <h3>–¢–æ–≤–∞—Ä–∏</h3>
            <div class="product-controls">
                <button onclick="openAddProductModal()">–î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä</button>
                <div class="sort-menu">
                    <button class="sort-btn">–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è ‚ñº</button>
                    <div class="sort-dropdown">
                        <button onclick="sortAdminProducts('id-asc')">ID (–∑—Ä–æ—Å—Ç–∞–Ω–Ω—è)</button>
                        <button onclick="sortAdminProducts('id-desc')">ID (—Å–ø–∞–¥–∞–Ω–Ω—è)</button>
                        <button onclick="sortAdminProducts('name-asc')">–ù–∞–∑–≤–∞ (–ê-–Ø)</button>
                        <button onclick="sortAdminProducts('name-desc')">–ù–∞–∑–≤–∞ (–Ø-–ê)</button>
                        <button onclick="sortAdminProducts('brand-asc')">–í–∏—Ä–æ–±–Ω–∏–∫ (–ê-–Ø)</button>
                        <button onclick="sortAdminProducts('brand-desc')">–í–∏—Ä–æ–±–Ω–∏–∫ (–Ø-–ê)</button>
                        <button onclick="sortAdminProducts('price-asc')">–¶—ñ–Ω–∞ (–∑—Ä–æ—Å—Ç–∞–Ω–Ω—è)</button>
                        <button onclick="sortAdminProducts('price-desc')">–¶—ñ–Ω–∞ (—Å–ø–∞–¥–∞–Ω–Ω—è)</button>
                    </div>
                </div>
                <div class="backup-group">
                    <button onclick="exportPrices()">–ï–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ —Ü—ñ–Ω–∏</button>
                    <div class="import-group">
                        <input accept=".txt,.csv" id="bulk-price-file" style="display: none;" type="file"/>
                        <button class="import-btn" onclick="document.getElementById('bulk-price-file').click()">–û–Ω–æ–≤–∏—Ç–∏ —Ü—ñ–Ω–∏ –∑ —Ñ–∞–π–ª—É</button>
                    </div>
                </div>
            </div>
            <div class="product-admin-item" id="product-list-header">
                <span>‚Ññ</span>
                <span>–¢–∏–ø</span>
                <span>–ù–∞–∑–≤–∞</span>
                <span>–í–∏—Ä–æ–±–Ω–∏–∫</span>
                <span>–¶—ñ–Ω–∞</span>
                <span>–ê–∫—Ü—ñ–π–Ω–∞ —Ü—ñ–Ω–∞</span>
                <span>–°—Ç–∞—Ç—É—Å</span>
            </div>
            <div id="product-list-admin"></div>
            <div class="pagination" id="pagination"></div>
        </div>
    </div>
    <div class="admin-tab" id="orders">
        <div class="admin-section orders-section">
            <h3>–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</h3>
            <div class="sort-menu">
                <button class="sort-btn">–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è ‚ñº</button>
                <div class="sort-dropdown">
                    <button onclick="sortOrders('date-desc')">–î–∞—Ç–∞ (–Ω–æ–≤—ñ—à—ñ)</button>
                    <button onclick="sortOrders('date-asc')">–î–∞—Ç–∞ (—Å—Ç–∞—Ä—ñ—à—ñ)</button>
                    <button onclick="sortOrders('total-desc')">–°—É–º–∞ (—Å–ø–∞–¥–∞–Ω–Ω—è)</button>
                    <button onclick="sortOrders('total-asc')">–°—É–º–∞ (–∑—Ä–æ—Å—Ç–∞–Ω–Ω—è)</button>
                    <button onclick="sortOrders('status-asc')">–°—Ç–∞—Ç—É—Å (–ê-–Ø)</button>
                    <button onclick="sortOrders('status-desc')">–°—Ç–∞—Ç—É—Å (–Ø-–ê)</button>
                </div>
            </div>
            <div class="filter-options">
                <label>–§—ñ–ª—å—Ç—Ä –∑–∞ —Å—Ç–∞—Ç—É—Å–æ–º:</label>
                <select id="order-status-filter" onchange="filterOrders()">
                    <option value="">–£—Å—ñ —Å—Ç–∞—Ç—É—Å–∏</option>
                    <option value="–ù–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è">–ù–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</option>
                    <option value="–í –æ–±—Ä–æ–±—Ü—ñ">–í –æ–±—Ä–æ–±—Ü—ñ</option>
                    <option value="–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ">–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ</option>
                    <option value="–ó–∞–≤–µ—Ä—à–µ–Ω–æ">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                </select>
            </div>
            <div id="order-list"></div>
            <div class="pagination" id="order-pagination"></div>
        </div>
    </div>
</div>
   </div>
   <div class="modal" id="modal">
   </div>
   <div class="resize-modal" id="resize-modal">
    <div class="resize-modal-content">
     <h4>
      –ó–º—ñ–Ω–∏—Ç–∏ —Ä–æ–∑–º—ñ—Ä–∏
     </h4>
     <label for="media-width">
      –®–∏—Ä–∏–Ω–∞ (px –∞–±–æ %):
     </label>
     <input id="media-width" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, 300 –∞–±–æ 50%" type="text"/>
     <label for="media-height">
      –í–∏—Å–æ—Ç–∞ (px –∞–±–æ %):
     </label>
     <input id="media-height" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, 200 –∞–±–æ 30%" type="text"/>
     <div class="resize-modal-actions">
      <button onclick="saveMediaSize()">
       –ó–±–µ—Ä–µ–≥—Ç–∏
      </button>
      <button onclick="closeResizeModal()">
       –°–∫–∞—Å—É–≤–∞—Ç–∏
      </button>
     </div>
    </div>
   </div>
   <div class="notification" id="notification">
   </div>
  </div>
  <script>
let session;
let products = [];
let categories = [];
let orders = [];
let slides = [];
let filters = [];
let orderFields = [{"name":"name","label":"–Ü–º'—è","type":"text"},{"name":"surname","label":"–ü—Ä—ñ–∑–≤–∏—â–µ","type":"text"},{"name":"phone","label":"–¢–µ–ª–µ—Ñ–æ–Ω","type":"text"},{"name":"email","label":"Email","type":"email"},{"name":"address","label":"–ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏","type":"text"},{"name":"payment","label":"–û–ø–ª–∞—Ç–∞","type":"select","options":["–ì–æ—Ç—ñ–≤–∫–æ—é","–ë–µ–∑–≥–æ—Ç—ñ–≤–∫–æ–≤–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫"]}];
let settings = {
    name: '',
    baseUrl: '', // –î–æ–¥–∞–Ω–æ –¥–ª—è –±–∞–∑–æ–≤–æ–≥–æ URL
    logo: '',
    logoWidth: '',
    favicon: '',
    contacts: { phones: '', addresses: '', schedule: '' },
    socials: [],
    showSocials: true,
    about: '',
    showSlides: true,
    slideWidth: '',
    slideHeight: '',
    slideInterval: '',
    categoryWidth: '',
    categoryHeight: '',
    productWidth: '',
    productHeight: ''
};
let currentPage = 1;
const productsPerPage = 20;
const ordersPerPage = 20;
const sessionTimeout = 30 * 60 * 1000;
let inactivityTimer;
let materials = [];
let brands = [];
let unsavedChanges = false;
let aboutEditor; // –ì–ª–æ–±–∞–ª—å–Ω–∞ –∑–º—ñ–Ω–Ω–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
let productEditor; // –î–æ–¥–∞—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—É –∑–º—ñ–Ω–Ω—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —Ç–æ–≤–∞—Ä—É
let selectedMedia = null; // –î–æ–¥–∞—î–º–æ –∑–º—ñ–Ω–Ω—É –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –≤–∏–±—Ä–∞–Ω–æ–≥–æ –º–µ–¥—ñ–∞
let socket;

function validateFile(file) {
    const maxSize = 5 * 1024 * 1024; // 5MB
    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];

    if (!allowedTypes.includes(file.type)) {
        return { valid: false, error: '–î–æ–∑–≤–æ–ª–µ–Ω—ñ –ª–∏—à–µ —Ñ–æ—Ä–º–∞—Ç–∏ JPEG, PNG, GIF, WebP!' };
    }

    if (file.size > maxSize) {
        return { valid: false, error: '–†–æ–∑–º—ñ—Ä —Ñ–∞–π–ª—É –Ω–µ –ø–æ–≤–∏–Ω–µ–Ω –ø–µ—Ä–µ–≤–∏—â—É–≤–∞—Ç–∏ 5MB!' };
    }

    return { valid: true };
}

async function getCsrfToken() {
    try {
        const response = await fetch('/api/csrf-token', {
            method: 'GET',
            credentials: 'include'
        });
        if (!response.ok) {
            throw new Error(`–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ CSRF-—Ç–æ–∫–µ–Ω: ${response.statusText}`);
        }
        const data = await response.json();
        return data.csrfToken;
    } catch (e) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è CSRF-—Ç–æ–∫–µ–Ω–∞:', e);
        showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ CSRF-—Ç–æ–∫–µ–Ω: ' + e.message);
        return null;
    }
}

async function loadProducts() {
    try {
        const tokenRefreshed = await refreshToken();
        if (!tokenRefreshed) {
            showNotification('–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∞–±–æ –Ω–µ–¥—ñ–π—Å–Ω–∏–π. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
            showSection('admin-login');
            return;
        }

        const token = localStorage.getItem('adminToken');
        const response = await fetch('/api/products', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!response.ok) {
            const text = await response.text();
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('adminToken');
                session = { isActive: false, timestamp: 0 };
                localStorage.setItem('adminSession', LZString.compressToUTF16(JSON.stringify(session)));
                showSection('admin-login');
                showNotification('–°–µ—Å—ñ—è –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—è. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
                return;
            }
            throw new Error(`–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ç–æ–≤–∞—Ä–∏: ${text}`);
        }

        products = await response.json();
        console.log('–¢–æ–≤–∞—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ:', products);
        renderAdmin('products');
    } catch (e) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤:', e);
        showNotification(e.message);
        products = [];
        renderAdmin('products');
    }
}

async function loadCategories() {
    try {
        const tokenRefreshed = await refreshToken();
        if (!tokenRefreshed) {
            showNotification('–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∞–±–æ –Ω–µ–¥—ñ–π—Å–Ω–∏–π. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
            showSection('admin-login');
            return;
        }

        const token = localStorage.getItem('adminToken');
        const response = await fetch('/api/categories', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!response.ok) {
            const text = await response.text();
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('adminToken');
                session = { isActive: false, timestamp: 0 };
                localStorage.setItem('adminSession', LZString.compressToUTF16(JSON.stringify(session)));
                showSection('admin-login');
                showNotification('–°–µ—Å—ñ—è –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—è. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
                return;
            }
            try {
                const errorData = JSON.parse(text);
                throw new Error(`–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó: ${errorData.error || response.statusText}`);
            } catch {
                throw new Error(`–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó: ${response.status} ${text}`);
            }
        }

        categories = await response.json();
        console.log('–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ:', categories);
        renderCategoriesAdmin();
    } catch (e) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π:', e);
        showNotification('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π: ' + e.message);
        categories = [];
        renderCategoriesAdmin();
    }
}

async function loadSettings() {
    try {
        const tokenRefreshed = await refreshToken();
        if (!tokenRefreshed) {
            showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ —Ç–æ–∫–µ–Ω. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
            showSection('admin-login');
            return;
        }

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Ä–µ–¥–∞–∫—Ç–æ—Ä—ñ–≤ –ø–µ—Ä–µ–¥ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–º –¥–∞–Ω–∏—Ö
        initializeEditors();

        const token = localStorage.getItem('adminToken');
        if (!token) {
            console.warn('–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è.');
            renderSettingsAdmin();
            return;
        }

        const response = await fetch('/api/settings', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!response.ok) {
            throw new Error(`–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è: ${response.statusText}`);
        }

        const serverSettings = await response.json();
        settings = { ...settings, ...serverSettings, filters: serverSettings.filters || filters || [] };

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤–º—ñ—Å—Ç—É –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ initializeEditors)
        renderSettingsAdmin();
        renderFilters();
    } catch (e) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å:', e);
        showNotification('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å: ' + e.message);
        renderSettingsAdmin();
    }
}

async function fetchWithAuth(url, options = {}) {
    try {
        const tokenRefreshed = await refreshToken();
        if (!tokenRefreshed) {
            throw new Error('–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∞–±–æ –Ω–µ–¥—ñ–π—Å–Ω–∏–π. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
        }

        const token = localStorage.getItem('adminToken');
        const csrfToken = await getCsrfToken();
        if (!csrfToken) {
            throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ CSRF-—Ç–æ–∫–µ–Ω.');
        }

        // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤
        const headers = new Headers({
            ...options.headers,
            'Authorization': `Bearer ${token}`,
            'X-CSRF-Token': csrfToken
        });

        // –Ø–∫—â–æ —Ü–µ FormData, –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ Content-Type (–±—Ä–∞—É–∑–µ—Ä –∑—Ä–æ–±–∏—Ç—å —Ü–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ)
        if (!(options.body instanceof FormData)) {
            headers.set('Content-Type', 'application/json');
        }

        const response = await fetch(url, {
            ...options,
            headers,
            credentials: 'include'
        });

        if (!response.ok) {
            const text = await response.text();
            if (response.status === 401 || response.status === 403) {
                const refreshed = await refreshToken();
                if (refreshed) {
                    const newToken = localStorage.getItem('adminToken');
                    const newCsrfToken = await getCsrfToken();
                    if (!newCsrfToken) {
                        throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ CSRF-—Ç–æ–∫–µ–Ω –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É.');
                    }
                    const retryHeaders = new Headers({
                        ...options.headers,
                        'Authorization': `Bearer ${newToken}`,
                        'X-CSRF-Token': newCsrfToken
                    });
                    if (!(options.body instanceof FormData)) {
                        retryHeaders.set('Content-Type', 'application/json');
                    }
                    const retryResponse = await fetch(url, {
                        ...options,
                        headers: retryHeaders,
                        credentials: 'include'
                    });
                    if (!retryResponse.ok) {
                        throw new Error(`–ü–æ–≤—Ç–æ—Ä–Ω–∏–π –∑–∞–ø–∏—Ç –Ω–µ –≤–¥–∞–≤—Å—è: ${retryResponse.statusText}`);
                    }
                    return retryResponse;
                } else {
                    localStorage.removeItem('adminToken');
                    session = { isActive: false, timestamp: 0 };
                    localStorage.setItem('adminSession', LZString.compressToUTF16(JSON.stringify(session)));
                    showSection('admin-login');
                    throw new Error('–°–µ—Å—ñ—è –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—è. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
                }
            }
            try {
                const errorData = JSON.parse(text);
                throw new Error(`–ü–æ–º–∏–ª–∫–∞: ${errorData.error || response.statusText}`);
            } catch {
                throw new Error(`–ü–æ–º–∏–ª–∫–∞: ${response.status} ${text}`);
            }
        }

        return response;
    } catch (err) {
        console.error('–ü–æ–º–∏–ª–∫–∞ fetchWithAuth:', err);
        showNotification(err.message);
        throw err;
    }
}

async function loadOrders() {
    try {
        const tokenRefreshed = await refreshToken();
        if (!tokenRefreshed) {
            console.warn('–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ª–æ–∫–∞–ª—å–Ω–∏—Ö –¥–∞–Ω–∏—Ö –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è.');
            orders = [];
            sortOrders('date-desc');
            renderAdmin('orders');
            return;
        }

        const token = localStorage.getItem('adminToken');
        const response = await fetch('/api/orders', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!response.ok) {
            const text = await response.text();
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('adminToken');
                session = { isActive: false, timestamp: 0 };
                localStorage.setItem('adminSession', LZString.compressToUTF16(JSON.stringify(session)));
                showSection('admin-login');
                showNotification('–°–µ—Å—ñ—è –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—è. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
                return;
            }
            throw new Error(`–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è: ${text}`);
        }

        orders = await response.json();
        sortOrders('date-desc');
        renderAdmin('orders');
    } catch (e) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω—å:', e);
        showNotification(e.message);
        orders = [];
        renderAdmin('orders');
    }
}

async function loadSlides() {
    try {
        const tokenRefreshed = await refreshToken();
        if (!tokenRefreshed) {
            showNotification('–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∞–±–æ –Ω–µ–¥—ñ–π—Å–Ω–∏–π. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
            showSection('admin-login');
            return;
        }

        const token = localStorage.getItem('adminToken');
        const response = await fetch('/api/slides', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!response.ok) {
            const text = await response.text();
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('adminToken');
                session = { isActive: false, timestamp: 0 };
                localStorage.setItem('adminSession', LZString.compressToUTF16(JSON.stringify(session)));
                showSection('admin-login');
                showNotification('–°–µ—Å—ñ—è –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—è. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
                return;
            }
            throw new Error(`–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–ª–∞–π–¥–∏: ${text}`);
        }

        slides = await response.json();
        renderSlidesAdmin();
    } catch (e) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ª–∞–π–¥—ñ–≤:', e);
        showNotification('–ü–æ–º–∏–ª–∫–∞: ' + e.message);
        slides = [];
        renderSlidesAdmin();
    }
}

async function loadMaterials() {
    try {
        const tokenRefreshed = await refreshToken();
        if (!tokenRefreshed) {
            console.warn('–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ª–æ–∫–∞–ª—å–Ω–∏—Ö –¥–∞–Ω–∏—Ö –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è.');
            materials = [];
            updateMaterialOptions();
            return;
        }

        const token = localStorage.getItem('adminToken');
        const response = await fetch('/api/materials', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!response.ok) {
            const text = await response.text();
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('adminToken');
                session = { isActive: false, timestamp: 0 };
                localStorage.setItem('adminSession', LZString.compressToUTF16(JSON.stringify(session)));
                showSection('admin-login');
                showNotification('–°–µ—Å—ñ—è –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—è. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
                return;
            }
            throw new Error(`–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏: ${text}`);
        }

        materials = await response.json();
        updateMaterialOptions();
    } catch (e) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤:', e);
        showNotification(e.message);
        materials = [];
        updateMaterialOptions();
    }
}

async function loadBrands() {
    try {
        const tokenRefreshed = await refreshToken();
        if (!tokenRefreshed) {
            console.warn('–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ª–æ–∫–∞–ª—å–Ω–∏—Ö –¥–∞–Ω–∏—Ö –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è.');
            brands = [];
            updateBrandOptions();
            return;
        }

        const token = localStorage.getItem('adminToken');
        const response = await fetch('/api/brands', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!response.ok) {
            const text = await response.text();
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('adminToken');
                session = { isActive: false, timestamp: 0 };
                localStorage.setItem('adminSession', LZString.compressToUTF16(JSON.stringify(session)));
                showSection('admin-login');
                showNotification('–°–µ—Å—ñ—è –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—è. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
                return;
            }
            throw new Error(`–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –±—Ä–µ–Ω–¥–∏: ${text}`);
        }

        brands = await response.json();
        updateBrandOptions();
    } catch (e) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±—Ä–µ–Ω–¥—ñ–≤:', e);
        showNotification(e.message);
        brands = [];
        updateBrandOptions();
    }
}

function renderFilters() {
    const filterList = document.getElementById('filter-list-admin');
    if (filterList) {
        filterList.innerHTML = filters.map((f, index) => `
            <div>
                ${f.label} (${f.name}, ${f.type}): ${f.options.join(', ')}
                <button class="delete-btn" onclick="deleteFilter(${index})">–í–∏–¥–∞–ª–∏—Ç–∏</button>
            </div>
        `).join('');
    }
    resetInactivityTimer();
}

async function deleteFilter(index) {
    if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ñ—ñ–ª—å—Ç—Ä?')) {
        try {
            const tokenRefreshed = await refreshToken();
            if (!tokenRefreshed) {
                showNotification('–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∞–±–æ –Ω–µ–¥—ñ–π—Å–Ω–∏–π. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
                showSection('admin-login');
                return;
            }

            filters.splice(index, 1);

            const token = localStorage.getItem('adminToken');
            const baseUrl = settings.baseUrl || 'https://mebli.onrender.com';
            const response = await fetch(`${baseUrl}/api/settings`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({ ...settings, filters })
            });

            if (!response.ok) {
                throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏');
            }

            renderFilters();
            showNotification('–§—ñ–ª—å—Ç—Ä –≤–∏–¥–∞–ª–µ–Ω–æ!');
        } catch (err) {
            console.error('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—É:', err);
            showNotification('–ü–æ–º–∏–ª–∫–∞: ' + err.message);
        }
    }
}

function updateMaterialOptions() {
    const materialInput = document.getElementById('product-material');
    if (materialInput && materialInput.tagName === 'INPUT') {
        // –Ø–∫—â–æ —Ü–µ —Ç–µ–∫—Å—Ç–æ–≤–µ –ø–æ–ª–µ, –Ω—ñ—á–æ–≥–æ –Ω–µ —Ä–æ–±–∏–º–æ, –∞–ª–µ –≤ –º–∞–π–±—É—Ç–Ω—å–æ–º—É –º–æ–∂–Ω–∞ –∑–∞–º—ñ–Ω–∏—Ç–∏ –Ω–∞ <select>
    } else if (materialInput && materialInput.tagName === 'SELECT') {
        materialInput.innerHTML = '<option value="">–í–∏–±–µ—Ä—ñ—Ç—å –º–∞—Ç–µ—Ä—ñ–∞–ª</option>' +
            materials.map(m => `<option value="${m}">${m}</option>`).join('');
    }
}

function updateBrandOptions() {
    const brandInput = document.getElementById('product-brand');
    if (brandInput && brandInput.tagName === 'INPUT') {
        // –Ø–∫—â–æ —Ü–µ —Ç–µ–∫—Å—Ç–æ–≤–µ –ø–æ–ª–µ, –Ω—ñ—á–æ–≥–æ –Ω–µ —Ä–æ–±–∏–º–æ, –∞–ª–µ –≤ –º–∞–π–±—É—Ç–Ω—å–æ–º—É –º–æ–∂–Ω–∞ –∑–∞–º—ñ–Ω–∏—Ç–∏ –Ω–∞ <select>
    } else if (brandInput && brandInput.tagName === 'SELECT') {
        brandInput.innerHTML = '<option value="">–í–∏–±–µ—Ä—ñ—Ç—å –±—Ä–µ–Ω–¥</option>' +
            brands.map(b => `<option value="${b}">${b}</option>`).join('');
    }
}

let isInitializing = false;

async function initializeData() {
    if (isInitializing) {
        console.log('–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –≤–∂–µ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ');
        return;
    }

    isInitializing = true;
    try {
        const promises = [
            loadProducts().catch(e => {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤:', e);
                showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ç–æ–≤–∞—Ä–∏: ' + e.message);
                return null;
            }),
            loadCategories().catch(e => {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π:', e);
                showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó: ' + e.message);
                return null;
            }),
            loadSettings().catch(e => {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å:', e);
                showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è: ' + e.message);
                return null;
            }),
            loadOrders().catch(e => {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω—å:', e);
                showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è: ' + e.message);
                return null;
            }),
            loadSlides().catch(e => {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ª–∞–π–¥—ñ–≤:', e);
                showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–ª–∞–π–¥–∏: ' + e.message);
                return null;
            }),
            loadMaterials().catch(e => {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤:', e);
                showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏: ' + e.message);
                return null;
            }),
            loadBrands().catch(e => {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±—Ä–µ–Ω–¥—ñ–≤:', e);
                showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –±—Ä–µ–Ω–¥–∏: ' + e.message);
                return null;
            })
        ];

        await Promise.all(promises);
        console.log('–£—Å—ñ –¥–∞–Ω—ñ —É—Å–ø—ñ—à–Ω–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –∞–±–æ –æ–±—Ä–æ–±–ª–µ–Ω—ñ –ø–æ–º–∏–ª–∫–∏');
    } catch (e) {
        console.error('–ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –¥–∞–Ω–∏—Ö:', e);
        showNotification('–ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó: ' + e.message);
    } finally {
        isInitializing = false;
    }
}

async function checkAuth() {
    const token = localStorage.getItem('adminToken');
    const storedSession = localStorage.getItem('adminSession');
    console.log('–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó, —Ç–æ–∫–µ–Ω:', token, '—Å–µ—Å—ñ—è:', storedSession); // –î–æ–¥–∞—î–º–æ –ª–æ–≥

    if (!token || !storedSession) {
        console.log('–¢–æ–∫–µ–Ω –∞–±–æ —Å–µ—Å—ñ—è –≤—ñ–¥—Å—É—Ç–Ω—ñ, –ø–µ—Ä–µ—Ö—ñ–¥ –¥–æ –≤—Ö–æ–¥—É');
        showSection('admin-login');
        return;
    }

    try {
        session = JSON.parse(LZString.decompressFromUTF16(storedSession));
        if (!session.isActive || (Date.now() - session.timestamp) >= sessionTimeout) {
            console.log('–°–µ—Å—ñ—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞ –∞–±–æ –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—è');
            localStorage.removeItem('adminToken');
            session = { isActive: false, timestamp: 0 };
            localStorage.setItem('adminSession', LZString.compressToUTF16(JSON.stringify(session)));
            showSection('admin-login');
            return;
        }

        const tokenRefreshed = await refreshToken();
        console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω–∞:', tokenRefreshed); // –î–æ–¥–∞—î–º–æ –ª–æ–≥
        if (!tokenRefreshed) {
            showSection('admin-login');
            return;
        }

        showSection('admin-panel');
        await initializeData();
        connectAdminWebSocket();
        resetInactivityTimer();
    } catch (e) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó:', e);
        showSection('admin-login');
    }
}

checkAuth();



    // –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ –º–æ–¥–∞–ª—å–Ω–∏–º –≤—ñ–∫–Ω–æ–º –∑–º—ñ–Ω–∏ —Ä–æ–∑–º—ñ—Ä—ñ–≤
    function openResizeModal(media) {
        // –ó–Ω—ñ—Ç–∞—î–º–æ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –µ–ª–µ–º–µ–Ω—Ç–∞
        const previouslySelected = document.querySelector('.quill-media-selected');
        if (previouslySelected) {
            previouslySelected.classList.remove('quill-media-selected');
        }

        // –í–∏–¥—ñ–ª—è—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π –µ–ª–µ–º–µ–Ω—Ç
        media.classList.add('quill-media-selected');
        selectedMedia = media;

        // –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ—Ç–æ—á–Ω—ñ —Ä–æ–∑–º—ñ—Ä–∏
        const currentWidth = media.getAttribute('width') || media.style.width || '';
        const currentHeight = media.getAttribute('height') || media.style.height || '';

        // –ó–∞–ø–æ–≤–Ω—é—î–º–æ –ø–æ–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
        document.getElementById('media-width').value = currentWidth;
        document.getElementById('media-height').value = currentHeight;

        // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
        const resizeModal = document.getElementById('resize-modal');
        resizeModal.classList.add('active');
        resetInactivityTimer();
    }

    function closeResizeModal() {
        const resizeModal = document.getElementById('resize-modal');
        resizeModal.classList.remove('active');

        // –ó–Ω—ñ—Ç–∞—î–º–æ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è
        if (selectedMedia) {
            selectedMedia.classList.remove('quill-media-selected');
            selectedMedia = null;
        }
        resetInactivityTimer();
    }

function saveMediaSize() {
    if (!selectedMedia) return;

    const width = document.getElementById('media-width').value.trim();
    const height = document.getElementById('media-height').value.trim();

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤–≤–µ–¥–µ–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –∫–æ—Ä–µ–∫—Ç–Ω—ñ
    const isValidDimension = (value) => {
        return value === '' || /^\d+(\.\d+)?(%|px)?$/.test(value);
    };

    if (!isValidDimension(width) || !isValidDimension(height)) {
        alert('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—ñ —Ä–æ–∑–º—ñ—Ä–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 300, 50%, 200px)!');
        return;
    }

    // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ —Ä–æ–∑–º—ñ—Ä–∏
    if (width) {
        selectedMedia.setAttribute('width', width);
        selectedMedia.style.width = width;
        // –î–ª—è iframe –¥–æ–¥–∞—î–º–æ —Å—Ç–∏–ª—å max-width, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è
        if (selectedMedia.tagName === 'IFRAME') {
            selectedMedia.style.maxWidth = '100%';
        }
    } else {
        selectedMedia.removeAttribute('width');
        selectedMedia.style.width = '';
        if (selectedMedia.tagName === 'IFRAME') {
            selectedMedia.style.maxWidth = '';
        }
    }

    if (height) {
        selectedMedia.setAttribute('height', height);
        selectedMedia.style.height = height;
    } else {
        selectedMedia.removeAttribute('height');
        selectedMedia.style.height = '';
    }

    // –û–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–∏—Ö–æ–≤–∞–Ω–µ –ø–æ–ª–µ –∑ –≤–º—ñ—Å—Ç–æ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    const editorId = selectedMedia.closest('#about-editor') ? 'about-edit' : 'product-description';
    const editor = selectedMedia.closest('#about-editor') ? aboutEditor : document.querySelector('#product-description-editor').__quill;
    document.getElementById(editorId).value = editor.root.innerHTML;

    // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
    closeResizeModal();
    unsavedChanges = true;
    resetInactivityTimer();
}

function setDefaultVideoSizes(editor, editorId) {
    const iframes = editor.root.querySelectorAll('iframe');
    iframes.forEach(iframe => {
        if (!iframe.style.width || !iframe.style.height) {
            iframe.style.width = '100%'; // –ê–¥–∞–ø—Ç–∏–≤–Ω–∞ —à–∏—Ä–∏–Ω–∞
            iframe.style.height = '315px'; // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –≤–∏—Å–æ—Ç–∞ –¥–ª—è –≤—ñ–¥–µ–æ
            iframe.style.maxWidth = '560px'; // –û–±–º–µ–∂–µ–Ω–Ω—è —à–∏—Ä–∏–Ω–∏
            iframe.style.display = 'block'; // –î–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
            iframe.style.margin = '0 auto'; // –¶–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—è
        }
    });
    const hiddenInput = document.getElementById(editorId);
    if (hiddenInput) {
        hiddenInput.value = editor.root.innerHTML;
    }
    unsavedChanges = true;
    resetInactivityTimer();
}

function cleanupEditor(editorInstance, editorVariableName) {
    try {
        if (editorInstance) {
            // –í–∏–¥–∞–ª—è—î–º–æ —Å–ª—É—Ö–∞—á—ñ –ø–æ–¥—ñ–π Quill
            editorInstance.off('text-change');
            editorInstance.off('selection-change');

            // –í–∏–¥–∞–ª—è—î–º–æ —Å–ª—É—Ö–∞—á—ñ –ø–æ–¥—ñ–π –¥–ª—è 'click' –Ω–∞ editor.root
            // –û—Å–∫—ñ–ª—å–∫–∏ –º–∏ –Ω–µ –∑–Ω–∞—î–º–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –æ–±—Ä–æ–±–Ω–∏–∫–∞, –∫–ª–æ–Ω—É—î–º–æ –µ–ª–µ–º–µ–Ω—Ç, —â–æ–± –≤–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ —Å–ª—É—Ö–∞—á—ñ
            const oldRoot = editorInstance.root;
            const newRoot = oldRoot.cloneNode(true);
            oldRoot.parentNode.replaceChild(newRoot, oldRoot);
            editorInstance.root = newRoot;

            // –û—á–∏—â–∞—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
            if (editorInstance.container) {
                editorInstance.container.innerHTML = '';
            }

            // –û—á–∏—â–∞—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—É –∑–º—ñ–Ω–Ω—É (aboutEditor –∞–±–æ productEditor)
            if (editorVariableName === 'aboutEditor') {
                aboutEditor = null;
            } else if (editorVariableName === 'productEditor') {
                productEditor = null;
            }
        }
    } catch (e) {
        console.error(`–ü–æ–º–∏–ª–∫–∞ –æ—á–∏—â–µ–Ω–Ω—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ (${editorVariableName}):`, e);
    }
}

function initializeEditors() {
    try {
        // –û—á–∏—â–µ–Ω–Ω—è –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö —Ä–µ–¥–∞–∫—Ç–æ—Ä—ñ–≤
        if (aboutEditor) {
            cleanupEditor(aboutEditor, 'aboutEditor');
        }
        if (productEditor) {
            cleanupEditor(productEditor, 'productEditor');
        }

        // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø–∞–Ω–µ–ª—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤
        const toolbarOptions = [
            ['bold', 'italic', 'underline', 'strike'],
            ['blockquote', 'code-block'],
            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
            [{ 'script': 'sub' }, { 'script': 'super' }],
            [{ 'indent': '-1' }, { 'indent': '+1' }],
            [{ 'direction': 'rtl' }],
            [{ 'size': ['small', false, 'large', 'huge'] }],
            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'font': [] }],
            [{ 'align': [] }],
            ['clean'],
            ['image', 'video'],
            ['undo', 'redo']
        ];

        // –£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–Ω–æ–ø–æ–∫ undo/redo
        const updateButtons = (editor, container) => {
            const undoButton = container.querySelector('.ql-undo');
            const redoButton = container.querySelector('.ql-redo');
            if (undoButton && redoButton) {
                editor.history.stack.undo.length > 0
                    ? undoButton.removeAttribute('disabled')
                    : undoButton.setAttribute('disabled', 'true');
                editor.history.stack.redo.length > 0
                    ? redoButton.removeAttribute('disabled')
                    : redoButton.setAttribute('disabled', 'true');
            }
        };

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –¥–ª—è "–ü—Ä–æ –Ω–∞—Å"
        const aboutEditorContainer = document.getElementById('about-editor');
        if (!aboutEditorContainer) {
            console.warn('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ "–ü—Ä–æ –Ω–∞—Å" (#about-editor) –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ —É DOM.');
            return;
        }

        if (aboutEditorContainer && !aboutEditor) {
            // –û—á–∏—â–∞—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–¥ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—î—é
            aboutEditorContainer.innerHTML = '';
            
            aboutEditor = new Quill(aboutEditorContainer, {
                theme: 'snow',
                modules: {
                    toolbar: toolbarOptions,
                    history: {
                        delay: 1000,
                        maxStack: 500,
                        userOnly: true
                    }
                }
            });

            aboutEditor.on('text-change', () => {
                const content = aboutEditor.root.innerHTML;
                document.getElementById('about-edit').value = content;
                console.log('–í–º—ñ—Å—Ç —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ "–ü—Ä–æ –Ω–∞—Å" –∑–º—ñ–Ω–µ–Ω–æ:', content);
                unsavedChanges = true;
                updateButtons(aboutEditor, aboutEditorContainer);
                resetInactivityTimer();
            });

            // –û–±—Ä–æ–±–∫–∞ –≤–∏–±–æ—Ä—É –º–µ–¥—ñ–∞
            aboutEditor.on('selection-change', (range) => {
                if (range && range.length > 0) {
                    const [leaf] = aboutEditor.getLeaf(range.index);
                    if (leaf && leaf.domNode && (leaf.domNode.tagName === 'IMG' || leaf.domNode.tagName === 'IFRAME')) {
                        selectedMedia = leaf.domNode;
                        document.querySelectorAll('.quill-media-selected').forEach(el => el.classList.remove('quill-media-selected'));
                        selectedMedia.classList.add('quill-media-selected');
                    } else {
                        selectedMedia = null;
                        document.querySelectorAll('.quill-media-selected').forEach(el => el.classList.remove('quill-media-selected'));
                    }
                }
            });

            // –û–±—Ä–æ–±–Ω–∏–∫ –∫–ª—ñ–∫—ñ–≤ –¥–ª—è –∑–º—ñ–Ω–∏ —Ä–æ–∑–º—ñ—Ä—ñ–≤
            aboutEditor.root.addEventListener('click', (e) => {
                const target = e.target;
                if (target.tagName === 'IMG' || target.tagName === 'IFRAME') {
                    selectedMedia = target;
                    openResizeModal(target);
                }
            });

            // –û–±—Ä–æ–±–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ –º–µ–¥—ñ–∞ —á–µ—Ä–µ–∑ clipboard
            aboutEditor.clipboard.addMatcher(Node.ELEMENT_NODE, (node, delta) => {
                if (node.tagName === 'IMG' || node.tagName === 'IFRAME') {
                    const src = node.getAttribute('src');
                    if (src) {
                        const insert = node.tagName === 'IMG' ? { image: src } : { video: src };
                        return { ops: [{ insert }] };
                    }
                }
                return delta;
            });

            // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤–º—ñ—Å—Ç—É
            if (settings.about) {
                try {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(settings.about, 'text/html');
                    if (doc.body) {
                        aboutEditor.root.innerHTML = settings.about;
                        console.log('–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤–º—ñ—Å—Ç "–ü—Ä–æ –Ω–∞—Å":', settings.about);
                    } else {
                        throw new Error('–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π HTML');
                    }
                } catch (e) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ñ –≤–º—ñ—Å—Ç—É "–ü—Ä–æ –Ω–∞—Å":', e);
                    aboutEditor.setText(settings.about || '', 'silent');
                    showNotification('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤–º—ñ—Å—Ç—É "–ü—Ä–æ –Ω–∞—Å"');
                }
            } else {
                console.log('settings.about –ø–æ—Ä–æ–∂–Ω—ñ–π, —Ä–µ–¥–∞–∫—Ç–æ—Ä –æ—á–∏—â–µ–Ω–æ.');
                aboutEditor.root.innerHTML = '';
            }
            document.getElementById('about-edit').value = settings.about || '';

            // –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–æ–∑–º—ñ—Ä—ñ–≤ –≤—ñ–¥–µ–æ
            setDefaultVideoSizes(aboutEditor, 'about-edit');

            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å—Ç–∞–Ω—É –∫–Ω–æ–ø–æ–∫
            setTimeout(() => updateButtons(aboutEditor, aboutEditorContainer), 100);

            // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –∑–æ–±—Ä–∞–∂–µ–Ω—å
aboutEditor.getModule('toolbar').addHandler('image', () => {
    const input = document.createElement('input');
    input.setAttribute('type', 'file');
    input.setAttribute('accept', 'image/*');
    input.click();
    input.onchange = async () => {
        const file = input.files[0];
        if (file) {
            const validation = validateFile(file);
            if (!validation.valid) {
                showNotification(validation.error);
                return;
            }
            const range = aboutEditor.getSelection();
            const url = URL.createObjectURL(file);
            aboutEditor.insertEmbed(range ? range.index : 0, 'image', url);
            // –î–æ–¥–∞—î–º–æ alt –∞—Ç—Ä–∏–±—É—Ç –ø—ñ—Å–ª—è –≤—Å—Ç–∞–≤–∫–∏
            const img = aboutEditor.root.querySelector(`img[src="${url}"]`);
            if (img) {
                img.setAttribute('alt', `–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è ${file.name}`);
            }
        }
    };
});

            // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤—ñ–¥–µ–æ
            aboutEditor.getModule('toolbar').addHandler('video', () => {
                const url = prompt('–í–≤–µ–¥—ñ—Ç—å URL –≤—ñ–¥–µ–æ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, YouTube embed URL):');
                if (url) {
                    const range = aboutEditor.getSelection();
                    aboutEditor.insertEmbed(range ? range.index : 0, 'video', url);
                }
            });
        }

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –¥–ª—è —Ç–æ–≤–∞—Ä—É
        const productEditorContainer = document.getElementById('product-description-editor');
        if (!productEditorContainer) {
            console.log('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —Ç–æ–≤–∞—Ä—É (#product-description-editor) –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ —É DOM, –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—é.');
        } else if (productEditorContainer && !productEditor) {
            // –û—á–∏—â–∞—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–¥ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—î—é
            productEditorContainer.innerHTML = '';

            productEditor = new Quill(productEditorContainer, {
                theme: 'snow',
                modules: {
                    toolbar: toolbarOptions,
                    history: {
                        delay: 1000,
                        maxStack: 500,
                        userOnly: true
                    }
                }
            });

            productEditor.on('text-change', () => {
                const content = productEditor.root.innerHTML;
                document.getElementById('product-description').value = content;
                unsavedChanges = true;
                updateButtons(productEditor, productEditorContainer);
                resetInactivityTimer();
            });

            productEditor.on('selection-change', (range) => {
                if (range && range.length > 0) {
                    const [leaf] = productEditor.getLeaf(range.index);
                    if (leaf && leaf.domNode && (leaf.domNode.tagName === 'IMG' || leaf.domNode.tagName === 'IFRAME')) {
                        selectedMedia = leaf.domNode;
                        document.querySelectorAll('.quill-media-selected').forEach(el => el.classList.remove('quill-media-selected'));
                        selectedMedia.classList.add('quill-media-selected');
                    } else {
                        selectedMedia = null;
                        document.querySelectorAll('.quill-media-selected').forEach(el => el.classList.remove('quill-media-selected'));
                    }
                }
            });

            productEditor.root.addEventListener('click', (e) => {
                const target = e.target;
                if (target.tagName === 'IMG' || target.tagName === 'IFRAME') {
                    selectedMedia = target;
                    openResizeModal(target);
                }
            });

            productEditor.clipboard.addMatcher(Node.ELEMENT_NODE, (node, delta) => {
                if (node.tagName === 'IMG' || node.tagName === 'IFRAME') {
                    const src = node.getAttribute('src');
                    if (src) {
                        const insert = node.tagName === 'IMG' ? { image: src } : { video: src };
                        return { ops: [{ insert }] };
                    }
                }
                return delta;
            });

            setDefaultVideoSizes(productEditor, 'product-description');

            setTimeout(() => updateButtons(productEditor, productEditorContainer), 100);

            // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –∑–æ–±—Ä–∞–∂–µ–Ω—å
            productEditor.getModule('toolbar').addHandler('image', () => {
                const input = document.createElement('input');
                input.setAttribute('type', 'file');
                input.setAttribute('accept', 'image/*');
                input.click();
                input.onchange = async () => {
                    const file = input.files[0];
                    if (file) {
                        const validation = validateFile(file);
                        if (!validation.valid) {
                            showNotification(validation.error);
                            return;
                        }
                        const range = productEditor.getSelection();
                        const url = URL.createObjectURL(file);
                        productEditor.insertEmbed(range ? range.index : 0, 'image', url);
                    }
                };
            });

            // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤—ñ–¥–µ–æ
            productEditor.getModule('toolbar').addHandler('video', () => {
                const url = prompt('–í–≤–µ–¥—ñ—Ç—å URL –≤—ñ–¥–µ–æ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, YouTube embed URL):');
                if (url) {
                    const range = productEditor.getSelection();
                    productEditor.insertEmbed(range ? range.index : 0, 'video', url);
                }
            });
        }

        // –û–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ undo/redo
        const existingUndoListeners = document.querySelectorAll('.ql-undo[data-listener]');
        const existingRedoListeners = document.querySelectorAll('.ql-redo[data-listener]');
        existingUndoListeners.forEach(button => button.removeEventListener('click', button._undoListener));
        existingRedoListeners.forEach(button => button.removeEventListener('click', button._redoListener));

        const undoButtons = document.querySelectorAll('.ql-undo');
        const redoButtons = document.querySelectorAll('.ql-redo');
        undoButtons.forEach(button => {
            const listener = () => {
                if (button.closest('#about-editor') && aboutEditor) aboutEditor.history.undo();
                if (button.closest('#product-description-editor') && productEditor) productEditor.history.undo();
                updateButtons(aboutEditor, aboutEditorContainer);
                updateButtons(productEditor, productEditorContainer);
            };
            button.addEventListener('click', listener);
            button._undoListener = listener;
            button.setAttribute('data-listener', 'true');
        });
        redoButtons.forEach(button => {
            const listener = () => {
                if (button.closest('#about-editor') && aboutEditor) aboutEditor.history.redo();
                if (button.closest('#product-description-editor') && productEditor) productEditor.history.redo();
                updateButtons(aboutEditor, aboutEditorContainer);
                updateButtons(productEditor, productEditorContainer);
            };
            button.addEventListener('click', listener);
            button._redoListener = listener;
            button.setAttribute('data-listener', 'true');
        });

        console.log('–†–µ–¥–∞–∫—Ç–æ—Ä–∏ —É—Å–ø—ñ—à–Ω–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ');
    } catch (e) {
        console.error('–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó —Ä–µ–¥–∞–∫—Ç–æ—Ä—ñ–≤:', e);
        showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∏: ' + e.message);
    }
}

function addToolbarEventListeners() {
    try {
        const toolbars = document.querySelectorAll('.ql-toolbar');
        toolbars.forEach(toolbar => {
            // –û–±—Ä–æ–±–∫–∞ –∫–Ω–æ–ø–æ–∫
            const buttons = toolbar.querySelectorAll('button');
            buttons.forEach(button => {
                // –í–∏–¥–∞–ª—è—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –æ–±—Ä–æ–±–Ω–∏–∫–∏, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –¥—É–±–ª—é–≤–∞–Ω–Ω—è
                button.removeEventListener('click', handleToolbarInteraction);
                button.addEventListener('click', handleToolbarInteraction);
            });

            // –û–±—Ä–æ–±–∫–∞ –≤–∏–ø–∞–¥–∞—é—á–∏—Ö —Å–ø–∏—Å–∫—ñ–≤
            const selects = toolbar.querySelectorAll('select');
            selects.forEach(select => {
                select.removeEventListener('change', handleToolbarInteraction);
                select.addEventListener('change', handleToolbarInteraction);
            });
        });
    } catch (e) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤ –ø–∞–Ω–µ–ª—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤:', e);
    }
}

function handleToolbarInteraction() {
    resetInactivityTimer();
    unsavedChanges = true; // –ü–æ–∑–Ω–∞—á–∫–∞ –Ω–µ–∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö –∑–º—ñ–Ω –ø—Ä–∏ –≤–∑–∞—î–º–æ–¥—ñ—ó
}

function initializeProductEditor(description = '', descriptionDelta = null) {
    const productEditorElement = document.getElementById('product-description-editor');
    if (productEditorElement && !productEditor) {
        productEditorElement.innerHTML = ''; // –û—á–∏—â–∞—î–º–æ –ø–µ—Ä–µ–¥ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—î—é
        productEditor = new Quill('#product-description-editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline'],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    ['link', 'image'],
                    ['undo', 'redo']
                ],
                history: {
                    delay: 1000,
                    maxStack: 100
                }
            }
        });

        // –î–æ–¥–∞—î–º–æ –≤–ª–∞—Å–Ω—ñ –∫–Ω–æ–ø–∫–∏ undo/redo
        const toolbar = productEditor.getModule('toolbar');
        toolbar.addHandler('undo', () => productEditor.history.undo());
        toolbar.addHandler('redo', () => productEditor.history.redo());

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤–º—ñ—Å—Ç—É
        if (description) {
            productEditor.root.innerHTML = description;
        } else if (descriptionDelta) {
            productEditor.setContents(descriptionDelta);
        }

        productEditor.on('text-change', () => {
            const content = productEditor.root.innerHTML;
            document.getElementById('product-description').value = content;
            unsavedChanges = true;
            resetInactivityTimer();
        });

        // –û–±—Ä–æ–±–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ –∑–æ–±—Ä–∞–∂–µ–Ω—å
productEditor.getModule('toolbar').addHandler('image', () => {
    const input = document.createElement('input');
    input.setAttribute('type', 'file');
    input.setAttribute('accept', 'image/*');
    input.click();
    input.onchange = async () => {
        const file = input.files[0];
        if (file) {
            const validation = validateFile(file);
            if (!validation.valid) {
                showNotification(validation.error);
                return;
            }
            const range = productEditor.getSelection();
            const url = URL.createObjectURL(file);
            productEditor.insertEmbed(range ? range.index : 0, 'image', url);
            // –î–æ–¥–∞—î–º–æ alt –∞—Ç—Ä–∏–±—É—Ç –ø—ñ—Å–ª—è –≤—Å—Ç–∞–≤–∫–∏
            const img = productEditor.root.querySelector(`img[src="${url}"]`);
            if (img) {
                img.setAttribute('alt', `–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è ${file.name}`);
            }
        }
    };
});

    // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤—ñ–¥–µ–æ
    toolbar.addHandler('video', () => {
        let url = prompt('–í–≤–µ–¥—ñ—Ç—å URL –≤—ñ–¥–µ–æ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, https://www.youtube.com/watch?v=VIDEO_ID –∞–±–æ https://www.youtube.com/embed/VIDEO_ID):');
        if (url) {
            // –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ URL —É —Ñ–æ—Ä–º–∞—Ç embed
            const watchRegex = /^(https?:\/\/)?(www\.)?youtube\.com\/watch\?v=([^\s&]+)/;
            const embedRegex = /^(https?:\/\/)?(www\.)?youtube\.com\/embed\/([^\s]+)/;
            const shortRegex = /^(https?:\/\/)?youtu\.be\/([^\s]+)/;

            let videoId = null;

            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ñ–æ—Ä–º–∞—Ç watch?v=
            if (watchRegex.test(url)) {
                const match = url.match(watchRegex);
                videoId = match[3];
                url = `https://www.youtube.com/embed/${videoId}`;
            }
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ñ–æ—Ä–º–∞—Ç embed
            else if (embedRegex.test(url)) {
                const match = url.match(embedRegex);
                videoId = match[3];
                url = `https://www.youtube.com/embed/${videoId}`;
            }
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ñ–æ—Ä–º–∞—Ç youtu.be
            else if (shortRegex.test(url)) {
                const match = url.match(shortRegex);
                videoId = match[2];
                url = `https://www.youtube.com/embed/${videoId}`;
            }
            else {
                showNotification('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π URL –¥–ª—è YouTube –≤—ñ–¥–µ–æ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, https://www.youtube.com/watch?v=VIDEO_ID –∞–±–æ https://www.youtube.com/embed/VIDEO_ID)');
                return;
            }

            const range = productEditor.getSelection() || { index: 0 };
            productEditor.insertEmbed(range.index, 'video', url);
            setDefaultVideoSizes(productEditor, 'product-description');
        }
    });

    // –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏—Ö–æ–≤–∞–Ω–æ–≥–æ –ø–æ–ª—è
    productEditor.on('text-change', () => {
        document.getElementById('product-description').value = productEditor.root.innerHTML;
        unsavedChanges = true;
    });

    // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –≤–∏–±–æ—Ä—É –º–µ–¥—ñ–∞ (–∑ –∑–∞–ø—Ä–æ–ø–æ–Ω–æ–≤–∞–Ω–æ–≥–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è)
    productEditor.on('selection-change', (range) => {
        if (range && range.length > 0) {
            const [embed] = productEditor.getContents(range.index, range.length).ops.filter(op => op.insert && (op.insert.image || op.insert.video));
            selectedMedia = embed ? { type: embed.insert.image ? 'image' : 'video', url: embed.insert.image || embed.insert.video } : null;
        } else {
            selectedMedia = null;
        }
    });

    // –û–±—Ä–æ–±–Ω–∏–∫ –∫–ª—ñ–∫—ñ–≤ –¥–ª—è –∑–æ–±—Ä–∞–∂–µ–Ω—å —ñ –≤—ñ–¥–µ–æ
    productEditor.root.addEventListener('click', (e) => {
        const target = e.target;
        if (target.tagName === 'IMG' || target.tagName === 'IFRAME') {
            openResizeModal(target);
        }
    });

    // –û–±—Ä–æ–±–Ω–∏–∫ –≤—Å—Ç–∞–≤–∫–∏ –∑–æ–±—Ä–∞–∂–µ–Ω—å —á–µ—Ä–µ–∑ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è/–≤—Å—Ç–∞–≤–∫—É
    productEditor.clipboard.addMatcher(Node.ELEMENT_NODE, (node, delta) => {
        if (node.tagName === 'IMG') {
            const src = node.getAttribute('src');
            if (src) {
                return { ops: [{ insert: { image: src } }] };
            }
        }
        return delta;
    });

    // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "Undo" —ñ "Redo"
    setTimeout(() => {
        const toolbar = document.querySelector('#product-description-editor').previousElementSibling;
        if (toolbar && toolbar.classList.contains('ql-toolbar')) {
            const undoButton = toolbar.querySelector('.ql-undo');
            const redoButton = toolbar.querySelector('.ql-redo');
            if (undoButton) {
                undoButton.addEventListener('click', () => {
                    productEditor.history.undo();
                });
            }
            if (redoButton) {
                redoButton.addEventListener('click', () => {
                    productEditor.history.redo();
                });
            }
        } else {
            console.error('–ü–∞–Ω–µ–ª—å —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ –¥–ª—è productEditor –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞');
        }
    }, 100);

    resetInactivityTimer();
}

function showSection(sectionId) {
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    const section = document.getElementById(sectionId);
    if (section) {
        section.classList.add('active');
    }
}

session = { isActive: false, timestamp: 0 };

async function login() {
    const username = document.getElementById('admin-username').value;
    const password = document.getElementById('admin-password').value;

    if (!username || !password) {
        showNotification('–í–≤–µ–¥—ñ—Ç—å –ª–æ–≥—ñ–Ω —ñ –ø–∞—Ä–æ–ª—å!');
        return;
    }

    try {
        const csrfToken = await getCsrfToken();
        if (!csrfToken) {
            showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ CSRF-—Ç–æ–∫–µ–Ω.');
            return;
        }

        const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            },
            credentials: 'include',
            body: JSON.stringify({ username, password })
        });

        if (!response.ok) {
            const text = await response.text();
            try {
                const errorData = JSON.parse(text);
                throw new Error(`–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É: ${errorData.error || response.statusText}`);
            } catch {
                throw new Error(`–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É: ${response.status} ${text}`);
            }
        }

        const data = await response.json();
        console.log('–û—Ç—Ä–∏–º–∞–Ω–æ –¥–∞–Ω—ñ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó:', data); // –î–æ–¥–∞—î–º–æ –ª–æ–≥
        localStorage.setItem('adminToken', data.token);
        console.log('–¢–æ–∫–µ–Ω –∑–±–µ—Ä–µ–∂–µ–Ω–æ:', localStorage.getItem('adminToken')); // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
        session = { isActive: true, timestamp: Date.now() };
        localStorage.setItem('adminSession', LZString.compressToUTF16(JSON.stringify(session)));
        showSection('admin-panel');
        await initializeData();
        connectAdminWebSocket();
        showNotification('–í—Ö—ñ–¥ –≤–∏–∫–æ–Ω–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ!');
        resetInactivityTimer();
    } catch (e) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É:', e);
        showNotification('–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É: ' + e.message);
    }
}

    document.getElementById('admin-password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            login();
        }
    });
    document.getElementById('admin-username').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('admin-password').focus();
        }
    });

function logout() {
    if (socket && socket.readyState === WebSocket.OPEN) {
        socket.close(1000, '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∏–π—à–æ–≤ —ñ–∑ —Å–∏—Å—Ç–µ–º–∏');
    }
    localStorage.removeItem('adminToken');
    session = { isActive: false, timestamp: 0 };
    localStorage.setItem('adminSession', LZString.compressToUTF16(JSON.stringify(session)));
    showSection('admin-login');
    showNotification('–í–∏ –≤–∏–π—à–ª–∏ –∑ —Å–∏—Å—Ç–µ–º–∏.');
}

// –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—é
document.addEventListener('DOMContentLoaded', () => {
    const loginBtn = document.getElementById('login-btn');
    if (loginBtn) loginBtn.addEventListener('click', login);
    showSection('admin-login'); // –ó–∞–≤–∂–¥–∏ –ø–æ—á–∏–Ω–∞—î–º–æ –∑ –ª–æ–≥—ñ–Ω—É
});

async function refreshToken() {
    const token = localStorage.getItem('adminToken');
    console.log('–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –≤ refreshToken:', token); // –î–æ–¥–∞—î–º–æ –ª–æ–≥
    if (!token) {
        console.warn('–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π');
        return false;
    }

    try {
        const csrfToken = await getCsrfToken();
        console.log('–û—Ç—Ä–∏–º–∞–Ω–æ CSRF-—Ç–æ–∫–µ–Ω:', csrfToken); // –î–æ–¥–∞—î–º–æ –ª–æ–≥
        if (!csrfToken) {
            console.warn('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ CSRF-—Ç–æ–∫–µ–Ω');
            return false;
        }

        const response = await fetch('/api/auth/refresh', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            },
            credentials: 'include'
        });

        console.log('–í—ñ–¥–ø–æ–≤—ñ–¥—å refreshToken:', response.status); // –î–æ–¥–∞—î–º–æ –ª–æ–≥
        if (!response.ok) {
            localStorage.removeItem('adminToken');
            session = { isActive: false, timestamp: 0 };
            localStorage.setItem('adminSession', LZString.compressToUTF16(JSON.stringify(session)));
            return false;
        }

        const data = await response.json();
        console.log('–ù–æ–≤–∏–π —Ç–æ–∫–µ–Ω:', data.token); // –î–æ–¥–∞—î–º–æ –ª–æ–≥
        localStorage.setItem('adminToken', data.token);
        session.timestamp = Date.now();
        localStorage.setItem('adminSession', LZString.compressToUTF16(JSON.stringify(session)));
        return true;
    } catch (e) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω–∞:', e);
        localStorage.removeItem('adminToken');
        session = { isActive: false, timestamp: 0 };
        localStorage.setItem('adminSession', LZString.compressToUTF16(JSON.stringify(session)));
        return false;
    }
}

function startTokenRefreshTimer() {
    setInterval(async () => {
        if (session.isActive) {
            await refreshToken();
        }
    }, 25 * 60 * 1000); // 25 —Ö–≤–∏–ª–∏–Ω
}

function showNotification(message) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.classList.add('active');
    setTimeout(() => {
        notification.classList.remove('active');
    }, 3000);
}

function resetInactivityTimer() {
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(() => {
        localStorage.removeItem('adminToken');
        session = { isActive: false, timestamp: 0 };
        localStorage.setItem('adminSession', LZString.compressToUTF16(JSON.stringify(session)));
        showSection('admin-login');
        showNotification('–°–µ—Å—ñ—è –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—è —á–µ—Ä–µ–∑ –±–µ–∑–¥—ñ—è–ª—å–Ω—ñ—Å—Ç—å.');
    }, sessionTimeout);
}

    function showAdminTab(tabId) {
        document.querySelectorAll('.admin-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        const tab = document.getElementById(tabId);
        const button = Array.from(document.querySelectorAll('.tab-btn')).find(btn => btn.getAttribute('onclick') === `showAdminTab('${tabId}')`);
        if (tab && button) {
            tab.classList.add('active');
            button.classList.add('active');
            currentPage = 1;
            renderAdmin(tabId);
            resetInactivityTimer();
        }
    }

async function updateStoreInfo() {
    try {
        const tokenRefreshed = await refreshToken();
        if (!tokenRefreshed) {
            showNotification('–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∞–±–æ –Ω–µ–¥—ñ–π—Å–Ω–∏–π. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
            showSection('admin-login');
            return;
        }

        // –û—Ç—Ä–∏–º–∞–Ω–Ω—è –∑–Ω–∞—á–µ–Ω—å –ø–æ–ª—ñ–≤
        const name = document.getElementById('store-name').value.trim();
        const baseUrl = document.getElementById('base-url').value.trim();
        const logoWidth = document.getElementById('logo-width').value.trim();
        const logoUrl = document.getElementById('logo-url').value.trim();
        const logoFile = document.getElementById('logo-file').files[0];
        const faviconUrl = document.getElementById('favicon-url').value.trim();
        const faviconFile = document.getElementById('favicon-file').files[0];

        // –í–∞–ª—ñ–¥–∞—Ü—ñ—è –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–∏—Ö –ø–æ–ª—ñ–≤
        if (!name) {
            showNotification('–ù–∞–∑–≤–∞ –º–∞–≥–∞–∑–∏–Ω—É —î –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ—é!');
            return;
        }

        // –í–∞–ª—ñ–¥–∞—Ü—ñ—è –±–∞–∑–æ–≤–æ–≥–æ URL
        if (!baseUrl) {
            showNotification('–ë–∞–∑–æ–≤–∏–π URL —î –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–∏–º!');
            return;
        }
        const urlPattern = /^(https?:\/\/)([\w-]+(\.[\w-]+)+)(\/[\w-]*)*\/?$/;
        if (!urlPattern.test(baseUrl)) {
            showNotification('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π –±–∞–∑–æ–≤–∏–π URL (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, https://www.yourdomain.com)!');
            return;
        }

        // –í–∞–ª—ñ–¥–∞—Ü—ñ—è —à–∏—Ä–∏–Ω–∏ –ª–æ–≥–æ—Ç–∏–ø—É
        let logoWidthNum = null;
        if (logoWidth) {
            logoWidthNum = parseInt(logoWidth, 10);
            if (isNaN(logoWidthNum) || logoWidthNum < 50 || logoWidthNum > 500) {
                showNotification('–®–∏—Ä–∏–Ω–∞ –ª–æ–≥–æ—Ç–∏–ø—É –º–∞—î –±—É—Ç–∏ —á–∏—Å–ª–æ–º –≤—ñ–¥ 50 –¥–æ 500!');
                return;
            }
        }

        // –í–∞–ª—ñ–¥–∞—Ü—ñ—è –ª–æ–≥–æ—Ç–∏–ø—É
        if (logoFile) {
            const validation = validateFile(logoFile);
            if (!validation.valid) {
                showNotification(validation.error);
                return;
            }
            const formData = new FormData();
            formData.append('file', logoFile);
            const response = await fetchWithAuth('/api/upload', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            settings.logo = data.url;
        } else if (logoUrl) {
            if (!urlPattern.test(logoUrl)) {
                showNotification('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π URL –ª–æ–≥–æ—Ç–∏–ø—É!');
                return;
            }
            settings.logo = logoUrl;
        } else {
            settings.logo = ''; // –û—á–∏—â–∞—î–º–æ, —è–∫—â–æ –Ω—ñ—á–æ–≥–æ –Ω–µ –≤–≤–µ–¥–µ–Ω–æ
        }

        // –í–∞–ª—ñ–¥–∞—Ü—ñ—è favicon
        if (faviconFile) {
            const validation = validateFile(faviconFile);
            if (!validation.valid) {
                showNotification(validation.error);
                return;
            }
            const formData = new FormData();
            formData.append('file', faviconFile);
            const response = await fetchWithAuth('/api/upload', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            settings.favicon = data.url;
        } else if (faviconUrl) {
            if (!urlPattern.test(faviconUrl)) {
                showNotification('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π URL favicon!');
                return;
            }
            settings.favicon = faviconUrl;
        } else {
            settings.favicon = ''; // –û—á–∏—â–∞—î–º–æ, —è–∫—â–æ –Ω—ñ—á–æ–≥–æ –Ω–µ –≤–≤–µ–¥–µ–Ω–æ
        }

        // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
        settings.name = name;
        settings.baseUrl = baseUrl;
        settings.logoWidth = logoWidthNum ? logoWidthNum.toString() : '';

        const response = await fetchWithAuth('/api/settings', {
            method: 'PUT',
            body: JSON.stringify({
                name: settings.name,
                baseUrl: settings.baseUrl,
                logo: settings.logo,
                logoWidth: settings.logoWidth,
                favicon: settings.favicon
            })
        });

        if (!response.ok) {
            throw new Error(`–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –º–∞–≥–∞–∑–∏–Ω—É: ${response.statusText}`);
        }

        showNotification('–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –º–∞–≥–∞–∑–∏–Ω—É –æ–Ω–æ–≤–ª–µ–Ω–æ!');
        unsavedChanges = false;
        resetInactivityTimer();
    } catch (err) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –º–∞–≥–∞–∑–∏–Ω—É:', err);
        showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –º–∞–≥–∞–∑–∏–Ω—É: ' + err.message);
    }
}

async function updateContacts() {
    try {
        const tokenRefreshed = await refreshToken();
        if (!tokenRefreshed) {
            showNotification('–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∞–±–æ –Ω–µ–¥—ñ–π—Å–Ω–∏–π. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
            showSection('admin-login');
            return;
        }

        const phones = document.getElementById('contact-phones').value.trim();
        const addresses = document.getElementById('contact-addresses').value.trim();
        const schedule = document.getElementById('contact-schedule').value.trim();

        // –í–∞–ª—ñ–¥–∞—Ü—ñ—è
        if (!phones && !addresses && !schedule) {
            showNotification('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–Ω–µ –ø–æ–ª–µ (—Ç–µ–ª–µ—Ñ–æ–Ω–∏, –∞–¥—Ä–µ—Å–∏ –∞–±–æ –≥—Ä–∞—Ñ—ñ–∫)!');
            return;
        }

        const phonePattern = /^\+?\d{1,4}[\s-]?(\(\d{1,4}\))?[-\s]?\d{1,4}[-\s]?\d{1,4}[-\s]?\d{1,4}$/;
        if (phones) {
            const phoneLines = phones.split('\n').map(line => line.trim()).filter(line => line);
            for (let phone of phoneLines) {
                if (!phonePattern.test(phone)) {
                    showNotification('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, +38 (067) 123-45-67)!');
                    return;
                }
            }
        }

        settings.contacts.phones = phones;
        settings.contacts.addresses = addresses;
        settings.contacts.schedule = schedule;

        const response = await fetchWithAuth('/api/settings', {
            method: 'PUT',
            body: JSON.stringify({ contacts: settings.contacts })
        });

        if (!response.ok) {
            throw new Error(`–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∏: ${response.statusText}`);
        }

        showNotification('–ö–æ–Ω—Ç–∞–∫—Ç–∏ –æ–Ω–æ–≤–ª–µ–Ω–æ!');
        unsavedChanges = false;
        resetInactivityTimer();
    } catch (err) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤:', err);
        showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∏: ' + err.message);
    }
}

    function addSocial() {
        const url = document.getElementById('social-url').value;
        const icon = document.getElementById('social-icon').value;

        if (url) {
            settings.socials.push({ url, icon });
            localStorage.setItem('settings', LZString.compressToUTF16(JSON.stringify(settings)));
            document.getElementById('social-url').value = '';
            renderAdmin();
            showNotification('–°–æ—Ü–º–µ—Ä–µ–∂—É –¥–æ–¥–∞–Ω–æ!');
            unsavedChanges = false;
            resetInactivityTimer();
        } else {
            alert('–í–≤–µ–¥—ñ—Ç—å URL —Å–æ—Ü–º–µ—Ä–µ–∂—ñ!');
        }
    }

    function editSocial(index) {
        const url = prompt('–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤–∏–π URL —Å–æ—Ü–º–µ—Ä–µ–∂—ñ:', settings.socials[index].url);
        if (url) {
            settings.socials[index].url = url;
            localStorage.setItem('settings', LZString.compressToUTF16(JSON.stringify(settings)));
            renderAdmin();
            showNotification('–°–æ—Ü–º–µ—Ä–µ–∂—É –≤—ñ–¥—Ä–µ–¥–∞–≥–æ–≤–∞–Ω–æ!');
            unsavedChanges = false;
            resetInactivityTimer();
        }
    }

    function deleteSocial(index) {
        if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—é —Å–æ—Ü–º–µ—Ä–µ–∂—É?')) {
            settings.socials.splice(index, 1);
            localStorage.setItem('settings', LZString.compressToUTF16(JSON.stringify(settings)));
            renderAdmin();
            showNotification('–°–æ—Ü–º–µ—Ä–µ–∂—É –≤–∏–¥–∞–ª–µ–Ω–æ!');
            unsavedChanges = false;
            resetInactivityTimer();
        }
    }

    function toggleSocials() {
        settings.showSocials = document.getElementById('social-toggle').checked;
        localStorage.setItem('settings', LZString.compressToUTF16(JSON.stringify(settings)));
        renderAdmin();
        showNotification('–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–æ—Ü–º–µ—Ä–µ–∂ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
        unsavedChanges = false;
        resetInactivityTimer();
    }

    function formatText(command) {
        const textarea = document.getElementById('about-edit');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selectedText = textarea.value.substring(start, end);
        let newText = '';

        if (command === 'bold') {
            newText = `<b>${selectedText}</b>`;
        } else if (command === 'italic') {
            newText = `<i>${selectedText}</i>`;
        } else if (command === 'underline') {
            newText = `<u>${selectedText}</u>`;
        } else if (command === 'h2') {
            newText = `<h2>${selectedText}</h2>`;
        } else if (command === 'p') {
            newText = `<p>${selectedText}</p>`;
        }

        textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
        unsavedChanges = true;
        resetInactivityTimer();
    }

async function updateAbout() {
    try {
        const tokenRefreshed = await refreshToken();
        if (!tokenRefreshed) {
            showNotification('–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∞–±–æ –Ω–µ–¥—ñ–π—Å–Ω–∏–π. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
            showSection('admin-login');
            return;
        }

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞, —è–∫—â–æ –≤—ñ–Ω —â–µ –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π
        initializeEditors();

        const aboutContent = aboutEditor.root.innerHTML;
        const mediaUrls = [];
        const parser = new DOMParser();
        const doc = parser.parseFromString(aboutContent, 'text/html');
        const images = doc.querySelectorAll('img');

        for (let img of images) {
            const src = img.getAttribute('src');
            if (src && src.startsWith('blob:')) {
                try {
                    const response = await fetch(src);
                    const blob = await response.blob();
                    const formData = new FormData();
                    formData.append('file', blob, `about-image-${Date.now()}.png`);
                    const uploadResponse = await fetchWithAuth('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const uploadData = await uploadResponse.json();
                    if (uploadData.url) {
                        mediaUrls.push({ oldUrl: src, newUrl: uploadData.url });
                    } else {
                        throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è');
                    }
                } catch (err) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è:', err);
                    showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è: ' + err.message);
                    return;
                }
            }
        }

        let updatedContent = aboutContent;
        mediaUrls.forEach(({ oldUrl, newUrl }) => {
            updatedContent = updatedContent.replace(oldUrl, newUrl);
        });

        settings.about = updatedContent;
        const response = await fetchWithAuth('/api/settings', {
            method: 'PUT',
            body: JSON.stringify(settings)
        });

        if (!response.ok) {
            throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ —Ä–æ–∑–¥—ñ–ª "–ü—Ä–æ –Ω–∞—Å"');
        }

        showNotification('–†–æ–∑–¥—ñ–ª "–ü—Ä–æ –Ω–∞—Å" –æ–Ω–æ–≤–ª–µ–Ω–æ!');
        unsavedChanges = false;
        resetInactivityTimer();
    } catch (err) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è "–ü—Ä–æ –Ω–∞—Å":', err);
        showNotification('–ü–æ–º–∏–ª–∫–∞: ' + err.message);
    }
}

function renderAdmin(activeTab = 'site-editing') {
    console.log('–†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—ñ –∑ activeTab:', activeTab, 'settings:', settings);

    const storeName = document.getElementById('store-name');
    if (storeName) storeName.value = settings.name || '';
    const baseUrl = document.getElementById('base-url');
    if (baseUrl) baseUrl.value = settings.baseUrl || '';
    const logoUrl = document.getElementById('logo-url');
    if (logoUrl) logoUrl.value = settings.logo || '';
    const logoWidth = document.getElementById('logo-width');
    if (logoWidth) logoWidth.value = settings.logoWidth || 150;
    const faviconUrl = document.getElementById('favicon-url');
    if (faviconUrl) faviconUrl.value = settings.favicon || '';

    const contacts = settings.contacts || { phones: '', addresses: '', schedule: '' };
    const contactPhones = document.getElementById('contact-phones');
    if (contactPhones) contactPhones.value = contacts.phones || '';
    const contactAddresses = document.getElementById('contact-addresses');
    if (contactAddresses) contactAddresses.value = contacts.addresses || '';
    const contactSchedule = document.getElementById('contact-schedule');
    if (contactSchedule) contactSchedule.value = contacts.schedule || '';

    if (document.getElementById('about-editor')) {
        if (!aboutEditor) {
            initializeEditors();
        }
        if (settings.aboutDelta) {
            aboutEditor.setContents(settings.aboutDelta, 'silent');
        } else if (settings.about) {
            try {
                const delta = aboutEditor.clipboard.convert(settings.about);
                aboutEditor.setContents(delta, 'silent');
            } catch (e) {
                aboutEditor.setContents([{ insert: settings.about }], 'silent');
            }
        } else {
            aboutEditor.setContents([], 'silent');
        }
        document.getElementById('about-edit').value = aboutEditor.root.innerHTML;
    } else if (document.getElementById('about-edit')) {
        document.getElementById('about-edit').value = settings.about || '';
    }

    const socialToggle = document.getElementById('social-toggle');
    if (socialToggle) socialToggle.checked = settings.showSocials !== false;
    const slideToggle = document.getElementById('slide-toggle');
    if (slideToggle) slideToggle.checked = settings.showSlides !== false;
    const slideWidth = document.getElementById('slide-width');
    if (slideWidth) slideWidth.value = settings.slideWidth || 75;
    const slideHeight = document.getElementById('slide-height');
    if (slideHeight) slideHeight.value = settings.slideHeight || 200;
    const slideInterval = document.getElementById('slide-interval');
    if (slideInterval) slideInterval.value = settings.slideInterval || 3000;
    const categoryWidth = document.getElementById('category-width');
    if (categoryWidth) categoryWidth.value = settings.categoryWidth || 200;
    const categoryHeight = document.getElementById('category-height');
    if (categoryHeight) categoryHeight.value = settings.categoryHeight || 150;
    const productWidth = document.getElementById('product-width');
    if (productWidth) productWidth.value = settings.productWidth || 300;
    const productHeight = document.getElementById('product-height');
    if (productHeight) productHeight.value = settings.productHeight || 280;

    const socialList = document.getElementById('social-list');
    if (socialList) {
        socialList.innerHTML = settings.socials.map((social, index) => `
            <div class="social-item">
                <span class="social-icon">${social.icon || 'üîó'}</span> ${social.url}
                <button class="edit-btn" onclick="editSocial(${index})">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
                <button class="delete-btn" onclick="deleteSocial(${index})">–í–∏–¥–∞–ª–∏—Ç–∏</button>
            </div>
        `).join('');
    }

    const catList = document.getElementById('cat-list');
    if (catList) {
        catList.innerHTML = categories.map((c, index) => `
            <div class="category-item">
                <button class="move-btn" onclick="moveCategoryUp(${index})" ${index === 0 ? 'disabled' : ''}>‚Üë</button>
                <button class="move-btn" onclick="moveCategoryDown(${index})" ${index === categories.length - 1 ? 'disabled' : ''}>‚Üì</button>
                ${c.name} (${c.slug}) 
                <button class="edit-btn" onclick="editCategory('${c.name}')">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button> 
                <button class="delete-btn" onclick="deleteCategory('${c.name}')">–í–∏–¥–∞–ª–∏—Ç–∏</button>
            </div>
            <div class="subcat-list">
                ${(c.subcategories || []).map((sub, subIndex) => `
                    <p>
                        <button class="move-btn" onclick="moveSubcategoryUp('${c.name}', ${subIndex})" ${subIndex === 0 ? 'disabled' : ''}>‚Üë</button>
                        <button class="move-btn" onclick="moveSubcategoryDown('${c.name}', ${subIndex})" ${subIndex === (c.subcategories.length - 1) ? 'disabled' : ''}>‚Üì</button>
                        ${sub.name} (${sub.slug}) 
                        <button class="edit-btn" onclick="editSubcategory('${c.name}', '${sub.name}')">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button> 
                        <button class="delete-btn" onclick="deleteSubcategory('${c.name}', '${sub.name}')">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                    </p>
                `).join('')}
            </div>
        `).join('');
    }

    const filterList = document.getElementById('filter-list-admin');
    if (filterList) {
        filterList.innerHTML = filters.map((f, index) => `
            <p>
                <button class="move-btn" onclick="moveFilterUp(${index})" ${index === 0 ? 'disabled' : ''}>‚Üë</button>
                <button class="move-btn" onclick="moveFilterDown(${index})" ${index === filters.length - 1 ? 'disabled' : ''}>‚Üì</button>
                ${f.label} (${f.options.sort().join(', ')}) 
                <button class="edit-btn" onclick="editFilter('${f.name}')">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button> 
                <button class="delete-btn" onclick="deleteFilter('${f.name}')">–í–∏–¥–∞–ª–∏—Ç–∏</button>
            </p>
        `).join('');
    }

    const orderFieldList = document.getElementById('order-field-list');
    if (orderFieldList) {
        orderFieldList.innerHTML = orderFields.map(f => `
            <p>${f.label} (${f.type}${f.options ? `: ${f.options.join(', ')}` : ''}) 
                <button class="edit-btn" onclick="editOrderField('${f.name}')">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button> 
                <button class="delete-btn" onclick="deleteOrderField('${f.name}')">–í–∏–¥–∞–ª–∏—Ç–∏</button>
            </p>
        `).join('');
    }

    const slideList = document.getElementById('slide-list');
    if (slideList) {
        slideList.innerHTML = slides.map(s => `
            <p>–°–ª–∞–π–¥ #${s.order} 
                <button class="edit-btn" onclick="editSlide(${s.order})">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
                <button class="delete-btn" onclick="deleteSlide(${s.order})">–í–∏–¥–∞–ª–∏—Ç–∏</button>
            </p>
        `).join('');
    }

    const subcatSelect = document.getElementById('subcat-category');
    if (subcatSelect) {
        subcatSelect.innerHTML = '<option value="">–í–∏–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</option>' + 
            categories.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
    }

    if (activeTab === 'products') {
        const productList = document.getElementById('product-list-admin');
        if (productList) {
            if (Array.isArray(products) && products.length > 0) {
                const start = (currentPage - 1) * productsPerPage;
                const end = start + productsPerPage;
                const paginatedProducts = products.slice(start, end);
                productList.innerHTML = paginatedProducts.map(p => {
                    const saleInfo = p.salePrice ? `<s>${p.price || ''} –≥—Ä–Ω</s> ${p.salePrice} –≥—Ä–Ω ${renderCountdown(p)}` : `${p.price || ''} –≥—Ä–Ω`;
                    const type = p.type || 'simple';
                    let priceDisplay;
                    if (type === 'mattresses') {
                        priceDisplay = p.sizes && Array.isArray(p.sizes) && p.sizes.length > 0 ? Math.min(...p.sizes.map(s => s.price || Infinity)) + ' –≥—Ä–Ω' : '–ù/–î';
                    } else if (type === 'group') {
                        priceDisplay = p.groupProducts && Array.isArray(p.groupProducts) && p.groupProducts.length > 0 ? Math.min(...p.groupProducts.map(pid => {
                            const prod = products.find(pr => pr.id === pid);
                            return prod ? (prod.price || Infinity) : Infinity;
                        })) + ' –≥—Ä–Ω' : '–ù/–î';
                    } else {
                        priceDisplay = p.price ? p.price + ' –≥—Ä–Ω' : '–ù/–î';
                    }
                    const salePriceDisplay = p.salePrice ? `${p.salePrice} –≥—Ä–Ω` : '';
                    const visibilityStatus = p.visible ? '–í–∏–¥–∏–º—ñ—Å—Ç—å: –¢–∞–∫' : '–í–∏–¥–∏–º—ñ—Å—Ç—å: –ù—ñ';
                    return `
                        <div class="product-admin-item">
                            <span>#${p.id}</span>
                            <span>${type}</span>
                            <span>${p.name} (${p.slug || '–±–µ–∑ —à–ª—è—Ö—É'})</span>
                            <span>${p.brand || '–ë–µ–∑ –±—Ä–µ–Ω–¥—É'}</span>
                            <span>${priceDisplay}</span>
                            <span>${salePriceDisplay}</span>
                            <div class="status-column" title="${visibilityStatus}">
                                <div class="buttons">
                                    <button class="edit-btn" onclick="openEditProductModal(${p.id})">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
                                    <button class="delete-btn" onclick="deleteProduct(${p.id})">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                                    <button class="toggle-btn" onclick="toggleProductActive(${p.id})">${p.active ? '–î–µ–∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏' : '–ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏'}</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                renderPagination(products.length, productsPerPage, 'pagination', currentPage);
            } else {
                productList.innerHTML = '<p>–ù–µ–º–∞—î —Ç–æ–≤–∞—Ä—ñ–≤ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è.</p>';
            }
        }
    }

    if (activeTab === 'orders') {
        const statusFilter = document.getElementById('order-status-filter')?.value || '';
        let filteredOrders = [...orders];
        if (statusFilter) {
            filteredOrders = filteredOrders.filter(o => o.status === statusFilter);
        }
        const start = (currentPage - 1) * ordersPerPage;
        const end = start + ordersPerPage;
        const paginatedOrders = filteredOrders.slice(start, end);
        const orderList = document.getElementById('order-list');
        if (orderList) {
            orderList.innerHTML = paginatedOrders.map((o, index) => {
                const orderDate = new Date(o.date);
                const formattedDate = orderDate.toLocaleString('uk-UA', {
                    timeZone: settings.timezone || 'Europe/Kyiv',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                return `
                    <div class="order-item">
                        <span>#${start + index + 1} ${formattedDate} - ${o.total} –≥—Ä–Ω (${o.status})</span>
                        <div>
                            <button class="edit-btn" onclick="viewOrder(${orders.indexOf(o)})">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏</button>
                            <button class="toggle-btn" onclick="changeOrderStatus(${orders.indexOf(o)})">–ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å</button>
                            <button class="delete-btn" onclick="deleteOrder(${orders.indexOf(o)})">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                        </div>
                    </div>
                `;
            }).join('');
            renderPagination(filteredOrders.length, ordersPerPage, 'order-pagination', currentPage);
        }
    }
}

function renderCategoriesAdmin() {
    const catList = document.getElementById('cat-list');
    if (catList) {
        catList.innerHTML = categories.map(cat => `
            <div class="category-item">
                ${cat.name}
                <button class="edit-btn" onclick="editCategory('${cat._id}')">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
                <button class="delete-btn" onclick="deleteCategory('${cat._id}')">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                <div class="subcat-list">
                    ${(cat.subcategories || []).map(sub => `
                        <p>
                            ${sub.name}
                            <button class="edit-btn" onclick="editSubcategory('${cat._id}', '${sub._id}')">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
                            <button class="delete-btn" onclick="deleteSubcategory('${cat._id}', '${sub._id}')">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                        </p>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }
    const subcatSelect = document.getElementById('subcat-category');
    if (subcatSelect) {
        subcatSelect.innerHTML = '<option value="">–í–∏–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</option>' + 
            categories.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
    }
}

function renderSocialsAdmin() {
    const socialList = document.getElementById('social-list');
    if (!socialList) return;
    socialList.innerHTML = settings.socials.map((social, index) => `
        <div class="social-item">
            <span class="social-icon">${social.icon}</span>
            <span>${social.url}</span>
            <button class="delete-btn" onclick="deleteSocial(${index})">–í–∏–¥–∞–ª–∏—Ç–∏</button>
        </div>
    `).join('');
}

function renderSettingsAdmin() {
    try {
        document.getElementById('store-name').value = settings.name || '';
        document.getElementById('base-url').value = settings.baseUrl || '';
        document.getElementById('logo-url').value = settings.logo || '';
        document.getElementById('logo-width').value = settings.logoWidth || '';
        document.getElementById('favicon-url').value = settings.favicon || '';
        document.getElementById('contact-phones').value = settings.contacts?.phones || '';
        document.getElementById('contact-addresses').value = settings.contacts?.addresses || '';
        document.getElementById('contact-schedule').value = settings.contacts?.schedule || '';
        document.getElementById('social-toggle').checked = settings.showSocials ?? true;
        document.getElementById('slide-toggle').checked = settings.showSlides ?? true;
        document.getElementById('slide-width').value = settings.slideWidth || '';
        document.getElementById('slide-height').value = settings.slideHeight || '';
        document.getElementById('slide-interval').value = settings.slideInterval || '';
        document.getElementById('category-width').value = settings.categoryWidth || '';
        document.getElementById('category-height').value = settings.categoryHeight || '';
        document.getElementById('product-width').value = settings.productWidth || '';
        document.getElementById('product-height').value = settings.productHeight || '';

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫—ñ–≤
        renderSocialsAdmin();
        renderCategoriesAdmin();
        renderSlidesAdmin();
        renderFilters();

        resetInactivityTimer();
    } catch (e) {
        console.error('–ü–æ–º–∏–ª–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å:', e);
        showNotification('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å: ' + e.message);
    }
}

function renderSlidesAdmin() {
    const slideList = document.getElementById('slide-list');
    if (slideList) {
        slideList.innerHTML = slides.map((slide, index) => `
            <div>
                ${slide.title || '–ë–µ–∑ –Ω–∞–∑–≤–∏'} (${slide.order || 0})
                <button class="edit-btn" onclick="editSlide(${index})">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
                <button class="delete-btn" onclick="deleteSlide(${index})">–í–∏–¥–∞–ª–∏—Ç–∏</button>
            </div>
        `).join('');
    }
    document.getElementById('slide-toggle').checked = settings.showSlides || false;
    document.getElementById('slide-width').value = settings.slideWidth || '';
    document.getElementById('slide-height').value = settings.slideHeight || '';
    document.getElementById('slide-interval').value = settings.slideInterval || '';
}

    function renderPagination(totalItems, itemsPerPage, containerId, currentPage) {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        if (totalPages <= 1) return;

        if (currentPage > 1) {
            const prevBtn = document.createElement('button');
            prevBtn.textContent = '–ü–æ–ø–µ—Ä–µ–¥–Ω—è';
            prevBtn.onclick = () => { currentPage--; renderAdmin(containerId === 'pagination' ? 'products' : 'orders'); };
            container.appendChild(prevBtn);
        }

        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement('button');
            btn.textContent = i;
            btn.className = i === currentPage ? 'active' : '';
            btn.onclick = () => { currentPage = i; renderAdmin(containerId === 'pagination' ? 'products' : 'orders'); };
            container.appendChild(btn);
        }

        if (currentPage < totalPages) {
            const nextBtn = document.createElement('button');
            nextBtn.textContent = '–ù–∞—Å—Ç—É–ø–Ω–∞';
            nextBtn.onclick = () => { currentPage++; renderAdmin(containerId === 'pagination' ? 'products' : 'orders'); };
            container.appendChild(nextBtn);
        }
    }

function closeModal() {
    const modal = document.getElementById('modal');
    modal.classList.remove('active');
    modal.innerHTML = '';
    if (productEditor) {
        productEditor.root.innerHTML = '';
        productEditor = null; // –°–∫–∏–¥–∞—î–º–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä
    }
    unsavedChanges = false;
    resetInactivityTimer();
}

async function addCategory() {
    try {
        const name = document.getElementById('cat-name').value.trim();
        const slug = document.getElementById('cat-slug').value.trim();
        const imgUrl = document.getElementById('cat-img-url').value.trim();
        const imgFile = document.getElementById('cat-img-file').files[0];

        if (!name || !slug) {
            showNotification('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É —Ç–∞ —à–ª—è—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó!');
            return;
        }

        if (!/^[a-z0-9-]+$/.test(slug)) {
            showNotification('–®–ª—è—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –º–æ–∂–µ –º—ñ—Å—Ç–∏—Ç–∏ –ª–∏—à–µ –º–∞–ª—ñ –ª–∞—Ç–∏–Ω—Å—å–∫—ñ –ª—ñ—Ç–µ—Ä–∏, —Ü–∏—Ñ—Ä–∏ —Ç–∞ –¥–µ—Ñ—ñ—Å–∏!');
            return;
        }

        let imageUrl = imgUrl;
        if (imgFile) {
            const validation = validateFile(imgFile);
            if (!validation.valid) {
                showNotification(validation.error);
                return;
            }
            const formData = new FormData();
            formData.append('file', imgFile);
            const response = await fetchWithAuth('/api/upload', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            imageUrl = data.url;
        }

        const category = { name, slug, image: imageUrl || null }; // –ó–º—ñ–Ω—é—î–º–æ "img" –Ω–∞ "image", —è–∫—â–æ —Å—Ö–µ–º–∞ –æ—á—ñ–∫—É—î "image"

        const response = await fetchWithAuth('/api/categories', {
            method: 'POST',
            body: JSON.stringify(category)
        });

        const newCategory = await response.json();
        categories.push(newCategory);
        renderCategoriesAdmin();
        document.getElementById('cat-name').value = '';
        document.getElementById('cat-slug').value = '';
        document.getElementById('cat-img-url').value = '';
        document.getElementById('cat-img-file').value = '';
        showNotification('–ö–∞—Ç–µ–≥–æ—Ä—ñ—é –¥–æ–¥–∞–Ω–æ!');
        resetInactivityTimer();
    } catch (err) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó:', err);
        showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –¥–æ–¥–∞—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é: ' + err.message);
    }
}

    function editCategory(name) {
        const category = categories.find(c => c.name === name);
        if (category) {
            const modal = document.getElementById('modal');
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</h3>
                    <input type="text" id="edit-cat-name" value="${category.name}"><br/>
                    <label for="edit-cat-name">–ù–∞–∑–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</label>
                    <input type="text" id="edit-cat-slug" value="${category.slug}"><br/>
                    <label for="edit-cat-slug">–®–ª—è—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</label>
                    <input type="text" id="edit-cat-img-url" value="${category.img || ''}"><br/>
                    <label for="edit-cat-img-url">URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</label>
                    <input type="file" id="edit-cat-img-file" accept="image/*"><br/>
                    <label for="edit-cat-img-file">–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</label>
                    ${category.img ? `<img src="${category.img}" style="max-width: 100px;">` : ''}
                    <div class="modal-actions">
                        <button id="save-cat-btn">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                        <button id="cancel-cat-btn">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
            document.getElementById('save-cat-btn').addEventListener('click', () => saveCategoryEdit(name));
            document.getElementById('cancel-cat-btn').addEventListener('click', closeModal);
            resetInactivityTimer();
        }
    }

    function saveCategoryEdit(oldName) {
        const category = categories.find(c => c.name === oldName);
        if (category) {
            const newName = document.getElementById('edit-cat-name').value;
            const newSlug = document.getElementById('edit-cat-slug').value;
            const newImgUrl = document.getElementById('edit-cat-img-url').value;
            const newImgFile = document.getElementById('edit-cat-img-file').files[0];

            if (newName && newSlug) {
                if (categories.some(c => c.slug === newSlug && c.name !== oldName)) {
                    alert('–®–ª—è—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –º–∞—î –±—É—Ç–∏ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–º!');
                    return;
                }
                category.name = newName;
                category.slug = newSlug;
                if (newImgUrl) category.img = newImgUrl;

                if (newImgFile) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        category.img = e.target.result;
                        updateProductsCategory(oldName, newName);
                        localStorage.setItem('categories', LZString.compressToUTF16(JSON.stringify(categories)));
                        localStorage.setItem('products', LZString.compressToUTF16(JSON.stringify(products)));
                        closeModal();
                        renderAdmin();
                        showNotification('–ö–∞—Ç–µ–≥–æ—Ä—ñ—é –≤—ñ–¥—Ä–µ–¥–∞–≥–æ–≤–∞–Ω–æ!');
                        unsavedChanges = false;
                        resetInactivityTimer();
                    };
                    reader.readAsDataURL(newImgFile);
                } else {
                    updateProductsCategory(oldName, newName);
                    localStorage.setItem('categories', LZString.compressToUTF16(JSON.stringify(categories)));
                    localStorage.setItem('products', LZString.compressToUTF16(JSON.stringify(products)));
                    closeModal();
                    renderAdmin();
                    showNotification('–ö–∞—Ç–µ–≥–æ—Ä—ñ—é –≤—ñ–¥—Ä–µ–¥–∞–≥–æ–≤–∞–Ω–æ!');
                    unsavedChanges = false;
                    resetInactivityTimer();
                }
            } else {
                alert('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É —Ç–∞ —à–ª—è—Ö!');
            }
        }
    }

    function updateProductsCategory(oldName, newName) {
        products.forEach(p => {
            if (p.category === oldName) p.category = newName;
        });
    }

    function deleteCategory(name) {
        if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –∫–∞—Ç–µ–≥–æ—Ä—ñ—é?')) {
            categories = categories.filter(c => c.name !== name);
            products.forEach(p => {
                if (p.category === name) {
                    p.category = '';
                    p.subcategory = '';
                }
            });
            localStorage.setItem('categories', LZString.compressToUTF16(JSON.stringify(categories)));
            localStorage.setItem('products', LZString.compressToUTF16(JSON.stringify(products)));
            renderAdmin();
            showNotification('–ö–∞—Ç–µ–≥–æ—Ä—ñ—é –≤–∏–¥–∞–ª–µ–Ω–æ!');
            unsavedChanges = false;
            resetInactivityTimer();
        }
    }

    function moveCategoryUp(index) {
        if (index > 0) {
            [categories[index - 1], categories[index]] = [categories[index], categories[index - 1]];
            localStorage.setItem('categories', LZString.compressToUTF16(JSON.stringify(categories)));
            renderAdmin();
            resetInactivityTimer();
        }
    }

    function moveCategoryDown(index) {
        if (index < categories.length - 1) {
            [categories[index], categories[index + 1]] = [categories[index + 1], categories[index]];
            localStorage.setItem('categories', LZString.compressToUTF16(JSON.stringify(categories)));
            renderAdmin();
            resetInactivityTimer();
        }
    }

async function addSubcategory() {
    try {
        const name = document.getElementById('subcat-name').value.trim();
        const slug = document.getElementById('subcat-slug').value.trim();
        const imgUrl = document.getElementById('subcat-img-url').value.trim();
        const imgFile = document.getElementById('subcat-img-file').files[0];
        const categoryName = document.getElementById('subcat-category').value;

        if (!name || !slug || !categoryName) {
            showNotification('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É, —à–ª—è—Ö —Ç–∞ –≤–∏–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é!');
            return;
        }

        if (!/^[a-z0-9-]+$/.test(slug)) {
            showNotification('–®–ª—è—Ö –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –º–æ–∂–µ –º—ñ—Å—Ç–∏—Ç–∏ –ª–∏—à–µ –º–∞–ª—ñ –ª–∞—Ç–∏–Ω—Å—å–∫—ñ –ª—ñ—Ç–µ—Ä–∏, —Ü–∏—Ñ—Ä–∏ —Ç–∞ –¥–µ—Ñ—ñ—Å–∏!');
            return;
        }

        let imageUrl = imgUrl;
        if (imgFile) {
            const validation = validateFile(imgFile);
            if (!validation.valid) {
                showNotification(validation.error);
                return;
            }
            const formData = new FormData();
            formData.append('file', imgFile);
            const response = await fetchWithAuth('/api/upload', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            imageUrl = data.url;
        }

        const category = categories.find(c => c.name === categoryName);
        if (!category) {
            showNotification('–ö–∞—Ç–µ–≥–æ—Ä—ñ—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞!');
            return;
        }

        const subcategory = { name, slug, image: imageUrl || null }; // –ó–º—ñ–Ω—é—î–º–æ "img" –Ω–∞ "image"
        const response = await fetchWithAuth(`/api/categories/${category._id}/subcategories`, {
            method: 'POST',
            body: JSON.stringify(subcategory)
        });

        const newSubcategory = await response.json();
        if (!category.subcategories) category.subcategories = [];
        category.subcategories.push(newSubcategory);
        renderCategoriesAdmin();
        document.getElementById('subcat-name').value = '';
        document.getElementById('subcat-slug').value = '';
        document.getElementById('subcat-img-url').value = '';
        document.getElementById('subcat-img-file').value = '';
        document.getElementById('subcat-category').value = '';
        showNotification('–ü—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—é –¥–æ–¥–∞–Ω–æ!');
        resetInactivityTimer();
    } catch (err) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó:', err);
        showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –¥–æ–¥–∞—Ç–∏ –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—é: ' + err.message);
    }
}

    function editSubcategory(categoryName, subcatName) {
        const category = categories.find(c => c.name === categoryName);
        if (category) {
            const subcategory = category.subcategories.find(s => s.name === subcatName);
            if (subcategory) {
                const modal = document.getElementById('modal');
                modal.innerHTML = `
                    <div class="modal-content">
                        <h3>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—é</h3>
                        <input type="text" id="edit-subcat-name" value="${subcategory.name}"><br/>
                        <label for="edit-subcat-name">–ù–∞–∑–≤–∞ –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</label>
                        <input type="text" id="edit-subcat-slug" value="${subcategory.slug}"><br/>
                        <label for="edit-subcat-slug">–®–ª—è—Ö –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</label>
                        <input type="text" id="edit-subcat-img-url" value="${subcategory.img || ''}"><br/>
                        <label for="edit-subcat-img-url">URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</label>
                        <input type="file" id="edit-subcat-img-file" accept="image/*"><br/>
                        <label for="edit-subcat-img-file">–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</label>
                        ${subcategory.img ? `<img src="${subcategory.img}" style="max-width: 100px;">` : ''}
                        <div class="modal-actions">
                            <button id="save-subcat-btn">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                            <button id="cancel-subcat-btn">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                        </div>
                    </div>
                `;
                modal.classList.add('active');
                document.getElementById('save-subcat-btn').addEventListener('click', () => saveSubcategoryEdit(categoryName, subcatName));
                document.getElementById('cancel-subcat-btn').addEventListener('click', closeModal);
                resetInactivityTimer();
            }
        }
    }

    function saveSubcategoryEdit(categoryName, oldName) {
        const category = categories.find(c => c.name === categoryName);
        if (category) {
            const subcategory = category.subcategories.find(s => s.name === oldName);
            if (subcategory) {
                const newName = document.getElementById('edit-subcat-name').value;
                const newSlug = document.getElementById('edit-subcat-slug').value;
                const newImgUrl = document.getElementById('edit-subcat-img-url').value;
                const newImgFile = document.getElementById('edit-subcat-img-file').files[0];

                if (newName && newSlug) {
                    if (category.subcategories.some(s => s.slug === newSlug && s.name !== oldName)) {
                        alert('–®–ª—è—Ö –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –º–∞—î –±—É—Ç–∏ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–º —É –º–µ–∂–∞—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó!');
                        return;
                    }
                    subcategory.name = newName;
                    subcategory.slug = newSlug;
                    if (newImgUrl) subcategory.img = newImgUrl;

                    if (newImgFile) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            subcategory.img = e.target.result;
                            updateProductsSubcategory(categoryName, oldName, newName);
                            localStorage.setItem('categories', LZString.compressToUTF16(JSON.stringify(categories)));
                            localStorage.setItem('products', LZString.compressToUTF16(JSON.stringify(products)));
                            closeModal();
                            renderAdmin();
                            showNotification('–ü—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—é –≤—ñ–¥—Ä–µ–¥–∞–≥–æ–≤–∞–Ω–æ!');
                            unsavedChanges = false;
                            resetInactivityTimer();
                        };
                        reader.readAsDataURL(newImgFile);
                    } else {
                        updateProductsSubcategory(categoryName, oldName, newName);
                        localStorage.setItem('categories', LZString.compressToUTF16(JSON.stringify(categories)));
                        localStorage.setItem('products', LZString.compressToUTF16(JSON.stringify(products)));
                        closeModal();
                        renderAdmin();
                        showNotification('–ü—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—é –≤—ñ–¥—Ä–µ–¥–∞–≥–æ–≤–∞–Ω–æ!');
                        unsavedChanges = false;
                        resetInactivityTimer();
                    }
                } else {
                    alert('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É —Ç–∞ —à–ª—è—Ö!');
                }
            }
        }
    }

    function updateProductsSubcategory(categoryName, oldSubcatName, newSubcatName) {
        products.forEach(p => {
            if (p.category === categoryName && p.subcategory === oldSubcatName) {
                p.subcategory = newSubcatName;
            }
        });
    }

    function deleteSubcategory(categoryName, subcatName) {
        if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—é?')) {
            const category = categories.find(c => c.name === categoryName);
            if (category) {
                category.subcategories = category.subcategories.filter(s => s.name !== subcatName);
                products.forEach(p => {
                    if (p.category === categoryName && p.subcategory === subcatName) {
                        p.subcategory = '';
                    }
                });
                localStorage.setItem('categories', LZString.compressToUTF16(JSON.stringify(categories)));
                localStorage.setItem('products', LZString.compressToUTF16(JSON.stringify(products)));
                renderAdmin();
                showNotification('–ü—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—é –≤–∏–¥–∞–ª–µ–Ω–æ!');
                unsavedChanges = false;
                resetInactivityTimer();
            }
        }
    }

    function moveSubcategoryUp(categoryName, index) {
        const category = categories.find(c => c.name === categoryName);
        if (category && index > 0) {
            [category.subcategories[index - 1], category.subcategories[index]] = [category.subcategories[index], category.subcategories[index - 1]];
            localStorage.setItem('categories', LZString.compressToUTF16(JSON.stringify(categories)));
            renderAdmin();
            resetInactivityTimer();
        }
    }

    function moveSubcategoryDown(categoryName, index) {
        const category = categories.find(c => c.name === categoryName);
        if (category && index < category.subcategories.length - 1) {
            [category.subcategories[index], category.subcategories[index + 1]] = [category.subcategories[index + 1], category.subcategories[index]];
            localStorage.setItem('categories', LZString.compressToUTF16(JSON.stringify(categories)));
            renderAdmin();
            resetInactivityTimer();
        }
    }

async function updateCategorySettings() {
    const width = parseInt(document.getElementById('category-width').value) || 300;
    const height = parseInt(document.getElementById('category-height').value) || 200;
    const token = localStorage.getItem('adminToken');

    if (width < 100 || width > 500 || height < 100 || height > 500) {
        alert('–®–∏—Ä–∏–Ω–∞ —Ç–∞ –≤–∏—Å–æ—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –º–∞—é—Ç—å –±—É—Ç–∏ –≤ –º–µ–∂–∞—Ö 100-500 px!');
        return;
    }

    settings.categoryWidth = width;
    settings.categoryHeight = height;

    try {
        const response = await fetch('/api/settings', {
            method: 'PUT',
            headers: {
                credentials: 'include',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ categoryWidth: width, categoryHeight: height })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π: ${errorData.error}`);
        }

        showNotification('–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π –æ–Ω–æ–≤–ª–µ–Ω–æ!');
        resetInactivityTimer();
    } catch (err) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å –∫–∞—Ç–µ–≥–æ—Ä—ñ–π:', err);
        showNotification(err.message);
    }
}

async function updateProductSettings() {
    const width = parseInt(document.getElementById('product-width').value) || 300;
    const height = parseInt(document.getElementById('product-height').value) || 300;
    const token = localStorage.getItem('adminToken');

    if (width < 200 || width > 500 || height < 200 || height > 500) {
        alert('–®–∏—Ä–∏–Ω–∞ —Ç–∞ –≤–∏—Å–æ—Ç–∞ —Ç–æ–≤–∞—Ä—É –º–∞—é—Ç—å –±—É—Ç–∏ –≤ –º–µ–∂–∞—Ö 200-500 px!');
        return;
    }

    settings.productWidth = width;
    settings.productHeight = height;

    try {
        const response = await fetch('/api/settings', {
            method: 'PUT',
            headers: {
                credentials: 'include',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ productWidth: width, productHeight: height })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤: ${errorData.error}`);
        }

        showNotification('–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤ –æ–Ω–æ–≤–ª–µ–Ω–æ!');
        resetInactivityTimer();
    } catch (err) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å —Ç–æ–≤–∞—Ä—ñ–≤:', err);
        showNotification(err.message);
    }
}

async function loadFilters() {
    try {
        const tokenRefreshed = await refreshToken();
        if (!tokenRefreshed) {
            console.warn('–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏.');
            renderFilters(); // –ó–∞–º—ñ–Ω–µ–Ω–æ –Ω–∞ renderFilters
            return;
        }

        const token = localStorage.getItem('adminToken');
        const baseUrl = settings.baseUrl || 'https://mebli.onrender.com';
        const response = await fetch(`${baseUrl}/api/filters`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!response.ok) {
            const text = await response.text();
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('adminToken');
                session = { isActive: false, timestamp: 0 };
                localStorage.setItem('adminSession', LZString.compressToUTF16(JSON.stringify(session)));
                showSection('admin-login');
                showNotification('–°–µ—Å—ñ—è –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—è. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
                return;
            }
            throw new Error(`–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏: ${text}`);
        }

        filters = await response.json();
        renderFilters(); // –ó–∞–º—ñ–Ω–µ–Ω–æ –Ω–∞ renderFilters
    } catch (err) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤:', err);
        showNotification('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤: ' + err.message);
        renderFilters(); // –†–µ–Ω–¥–µ—Ä–∏–º–æ –ª–æ–∫–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ
    }
}

async function addFilter() {
    try {
        const tokenRefreshed = await refreshToken();
        if (!tokenRefreshed) {
            showNotification('–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∞–±–æ –Ω–µ–¥—ñ–π—Å–Ω–∏–π. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
            showSection('admin-login');
            return;
        }

        const name = document.getElementById('filter-name').value;
        const label = document.getElementById('filter-label').value;
        const options = document.getElementById('filter-options').value.split(',').map(opt => opt.trim());

        if (!name || !label || options.length === 0 || options[0] === '') {
            showNotification('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É, –≤—ñ–¥–æ–±—Ä–∞–∂—É–≤–∞–Ω—É –Ω–∞–∑–≤—É —Ç–∞ –æ–ø—Ü—ñ—ó —Ñ—ñ–ª—å—Ç—Ä—É!');
            return;
        }

        const filter = { name, label, type: 'checkbox', options };
        filters.push(filter);

        const token = localStorage.getItem('adminToken');
        const baseUrl = settings.baseUrl || 'https://mebli.onrender.com';
        const response = await fetchWithAuth(`${baseUrl}/api/settings`, {
            method: 'PUT',
            body: JSON.stringify({ ...settings, filters })
        });

        renderFilters();
        document.getElementById('filter-name').value = '';
        document.getElementById('filter-label').value = '';
        document.getElementById('filter-options').value = '';
        showNotification('–§—ñ–ª—å—Ç—Ä –¥–æ–¥–∞–Ω–æ!');
        resetInactivityTimer();
    } catch (err) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä–∞:', err);
        showNotification('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä–∞: ' + err.message);
        // –í—ñ–¥–∫–∞—Ç–∏–º–æ –∑–º—ñ–Ω–∏ —É —Ä–∞–∑—ñ –ø–æ–º–∏–ª–∫–∏
        filters.pop();
        renderFilters();
    }
}

    function editFilter(name) {
        const filter = filters.find(f => f.name === name);
        if (filter) {
            const modal = document.getElementById('modal');
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä</h3>
                    <input type="text" id="edit-filter-name" value="${filter.name}" readonly><br/>
                    <label for="edit-filter-name">–ù–∞–∑–≤–∞ —Ñ—ñ–ª—å—Ç—Ä—É</label>
                    <input type="text" id="edit-filter-label" value="${filter.label}"><br/>
                    <label for="edit-filter-label">–í—ñ–¥–æ–±—Ä–∞–∂—É–≤–∞–Ω–∞ –Ω–∞–∑–≤–∞</label>
                    <input type="text" id="edit-filter-options" value="${filter.options.join(', ')}"><br/>
                    <label for="edit-filter-options">–û–ø—Ü—ñ—ó (—á–µ—Ä–µ–∑ –∫–æ–º—É)</label>
                    <div class="modal-actions">
                        <button id="save-filter-btn">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                        <button id="cancel-filter-btn">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
            document.getElementById('save-filter-btn').addEventListener('click', () => saveFilterEdit(name));
            document.getElementById('cancel-filter-btn').addEventListener('click', closeModal);
            resetInactivityTimer();
        }
    }

    function saveFilterEdit(name) {
        const filter = filters.find(f => f.name === name);
        if (filter) {
            const newLabel = document.getElementById('edit-filter-label').value;
            const newOptions = document.getElementById('edit-filter-options').value.split(',').map(o => o.trim()).filter(o => o);

            if (newLabel && newOptions.length > 0) {
                filter.label = newLabel;
                filter.options = newOptions;
                localStorage.setItem('filters', LZString.compressToUTF16(JSON.stringify(filters)));
                closeModal();
                renderAdmin();
                showNotification('–§—ñ–ª—å—Ç—Ä –≤—ñ–¥—Ä–µ–¥–∞–≥–æ–≤–∞–Ω–æ!');
                unsavedChanges = false;
                resetInactivityTimer();
            } else {
                alert('–í–≤–µ–¥—ñ—Ç—å –ø—ñ–¥–ø–∏—Å —Ç–∞ –æ–ø—Ü—ñ—ó!');
            }
        }
    }

    function deleteFilter(name) {
        if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ñ—ñ–ª—å—Ç—Ä?')) {
            filters = filters.filter(f => f.name !== name);
            localStorage.setItem('filters', LZString.compressToUTF16(JSON.stringify(filters)));
            renderAdmin();
            showNotification('–§—ñ–ª—å—Ç—Ä –≤–∏–¥–∞–ª–µ–Ω–æ!');
            unsavedChanges = false;
            resetInactivityTimer();
        }
    }

    function moveFilterUp(index) {
        if (index > 0) {
            [filters[index - 1], filters[index]] = [filters[index], filters[index - 1]];
            localStorage.setItem('filters', LZString.compressToUTF16(JSON.stringify(filters)));
            renderAdmin();
            resetInactivityTimer();
        }
    }

    function moveFilterDown(index) {
        if (index < filters.length - 1) {
            [filters[index], filters[index + 1]] = [filters[index + 1], filters[index]];
            localStorage.setItem('filters', LZString.compressToUTF16(JSON.stringify(filters)));
            renderAdmin();
            resetInactivityTimer();
        }
    }

async function addOrderField() {
    const token = localStorage.getItem('adminToken');
    if (!token) {
        showNotification('–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
        showSection('admin-login');
        return;
    }

    const name = document.getElementById('order-field-name').value;
    const label = document.getElementById('order-field-label').value;
    const type = document.getElementById('order-field-type').value;
    const options = document.getElementById('order-field-options').value.split(',').map(o => o.trim());

    if (!name || !label) {
        alert('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É —Ç–∞ –ø—ñ–¥–ø–∏—Å –¥–ª—è –ø–æ–ª—è!');
        return;
    }

    const field = { name, label, type };
    if (type === 'select' && options.length > 0) field.options = options;

    try {
        const response = await fetch('/api/order-fields', {
            method: 'POST',
            headers: {
                credentials: 'include',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(field)
        });

        if (!response.ok) throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –¥–æ–¥–∞—Ç–∏ –ø–æ–ª–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è');
        orderFields.push(field);
        document.getElementById('order-field-name').value = '';
        document.getElementById('order-field-label').value = '';
        document.getElementById('order-field-options').value = '';
        renderAdmin('order-fields');
        showNotification('–ü–æ–ª–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –¥–æ–¥–∞–Ω–æ!');
        resetInactivityTimer();
    } catch (e) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –ø–æ–ª—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:', e);
        showNotification(e.message);
    }
}

    function editOrderField(name) {
        const field = orderFields.find(f => f.name === name);
        if (field) {
            const modal = document.getElementById('modal');
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø–æ–ª–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h3>
                    <input type="text" id="edit-order-field-name" value="${field.name}" readonly><br/>
                    <label for="edit-order-field-name">–ù–∞–∑–≤–∞ –ø–æ–ª—è</label>
                    <input type="text" id="edit-order-field-label" value="${field.label}"><br/>
                    <label for="edit-order-field-label">–í—ñ–¥–æ–±—Ä–∞–∂—É–≤–∞–Ω–∞ –Ω–∞–∑–≤–∞</label>
                    <select id="edit-order-field-type">
                        <option value="text" ${field.type === 'text' ? 'selected' : ''}>–¢–µ–∫—Å—Ç</option>
                        <option value="email" ${field.type === 'email' ? 'selected' : ''}>Email</option>
                        <option value="select" ${field.type === 'select' ? 'selected' : ''}>–í–∏–±—ñ—Ä</option>
                    </select><br/>
                    <label for="edit-order-field-type">–¢–∏–ø –ø–æ–ª—è</label>
                    <input type="text" id="edit-order-field-options" value="${field.options ? field.options.join(', ') : ''}" ${field.type !== 'select' ? 'disabled' : ''}><br/>
                    <label for="edit-order-field-options">–û–ø—Ü—ñ—ó (—á–µ—Ä–µ–∑ –∫–æ–º—É, –¥–ª—è select)</label>
                    <div class="modal-actions">
                        <button id="save-order-field-btn">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                        <button id="cancel-order-field-btn">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
            document.getElementById('edit-order-field-type').addEventListener('change', (e) => {
                document.getElementById('edit-order-field-options').disabled = e.target.value !== 'select';
            });
            document.getElementById('save-order-field-btn').addEventListener('click', () => saveOrderFieldEdit(name));
            document.getElementById('cancel-order-field-btn').addEventListener('click', closeModal);
            resetInactivityTimer();
        }
    }

    function saveOrderFieldEdit(name) {
        const field = orderFields.find(f => f.name === name);
        if (field) {
            const newLabel = document.getElementById('edit-order-field-label').value;
            const newType = document.getElementById('edit-order-field-type').value;
            const newOptions = document.getElementById('edit-order-field-options').value.split(',').map(o => o.trim()).filter(o => o);

            if (newLabel) {
                field.label = newLabel;
                field.type = newType;
                if (newType === 'select') {
                    if (newOptions.length > 0) {
                        field.options = newOptions;
                    } else {
                        alert('–í–≤–µ–¥—ñ—Ç—å –æ–ø—Ü—ñ—ó –¥–ª—è —Ç–∏–ø—É "–í–∏–±—ñ—Ä"!');
                        return;
                    }
                } else {
                    delete field.options;
                }
                localStorage.setItem('orderFields', LZString.compressToUTF16(JSON.stringify(orderFields)));
                closeModal();
                renderAdmin();
                showNotification('–ü–æ–ª–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤—ñ–¥—Ä–µ–¥–∞–≥–æ–≤–∞–Ω–æ!');
                unsavedChanges = false;
                resetInactivityTimer();
            } else {
                alert('–í–≤–µ–¥—ñ—Ç—å –≤—ñ–¥–æ–±—Ä–∞–∂—É–≤–∞–Ω—É –Ω–∞–∑–≤—É!');
            }
        }
    }

    function deleteOrderField(name) {
        if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –ø–æ–ª–µ?')) {
            orderFields = orderFields.filter(f => f.name !== name);
            localStorage.setItem('orderFields', LZString.compressToUTF16(JSON.stringify(orderFields)));
            renderAdmin();
            showNotification('–ü–æ–ª–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–æ!');
            unsavedChanges = false;
            resetInactivityTimer();
        }
    }

async function updateSlideshowSettings() {
    const width = parseInt(document.getElementById('slide-width').value) || 100;
    const height = parseInt(document.getElementById('slide-height').value) || 300;
    const interval = parseInt(document.getElementById('slide-interval').value) || 5000;
    const token = localStorage.getItem('adminToken');

    if (width < 10 || width > 100) {
        alert('–®–∏—Ä–∏–Ω–∞ —Å–ª–∞–π–¥—É –º–∞—î –±—É—Ç–∏ –≤ –º–µ–∂–∞—Ö 10-100%!');
        return;
    }
    if (height < 100 || height > 500) {
        alert('–í–∏—Å–æ—Ç–∞ —Å–ª–∞–π–¥—É –º–∞—î –±—É—Ç–∏ –≤ –º–µ–∂–∞—Ö 100-500 px!');
        return;
    }
    if (interval < 1000) {
        alert('–Ü–Ω—Ç–µ—Ä–≤–∞–ª —Å–ª–∞–π–¥—ñ–≤ –º–∞—î –±—É—Ç–∏ –Ω–µ –º–µ–Ω—à–µ 1000 –º—Å!');
        return;
    }

    settings.slideWidth = width;
    settings.slideHeight = height;
    settings.slideInterval = interval;

    try {
        const response = await fetch('/api/settings', {
            method: 'PUT',
            headers: {
                credentials: 'include',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ slideWidth: width, slideHeight: height, slideInterval: interval })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–ª–∞–π–¥—à–æ—É: ${errorData.error}`);
        }

        showNotification('–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–ª–∞–π–¥—à–æ—É –æ–Ω–æ–≤–ª–µ–Ω–æ!');
        resetInactivityTimer();
    } catch (err) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å —Å–ª–∞–π–¥—à–æ—É:', err);
        showNotification(err.message);
    }
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

const debouncedSearchGroupProducts = debounce(searchGroupProducts, 300);

async function addSlide() {
    const button = document.querySelector('button[onclick="addSlide()"]');
    button.disabled = true;
    try {
        const tokenRefreshed = await refreshToken();
        if (!tokenRefreshed) {
            showNotification('–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∞–±–æ –Ω–µ–¥—ñ–π—Å–Ω–∏–π. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
            showSection('admin-login');
            return;
        }

        const imgUrl = document.getElementById('slide-img-url').value;
        const imgFile = document.getElementById('slide-img-file').files[0];
        const title = document.getElementById('slide-title').value;
        const text = document.getElementById('slide-text').value;
        const link = document.getElementById('slide-link').value;
        const linkText = document.getElementById('slide-link-text').value;
        const order = parseInt(document.getElementById('slide-order').value) || slides.length + 1;

        if (!imgUrl && !imgFile) {
            showNotification('–í–≤–µ–¥—ñ—Ç—å URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∞–±–æ –≤–∏–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª!');
            return;
        }

        const token = localStorage.getItem('adminToken');
        let imageUrl = imgUrl;

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è, —è–∫—â–æ –≤–∏–±—Ä–∞–Ω–æ —Ñ–∞–π–ª
        if (imgFile) {
            const validation = validateFile(imgFile);
            if (!validation.valid) {
                showNotification(validation.error);
                return;
            }
            const formData = new FormData();
            formData.append('file', imgFile);
            const response = await fetch('/api/upload', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                credentials: 'include',
                body: formData
            });
            if (!response.ok) {
                throw new Error(`–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è: ${response.statusText}`);
            }
            const data = await response.json();
            imageUrl = data.url;
        }

        const slide = {
            img: imageUrl, // –ó–º—ñ–Ω–µ–Ω–æ –∑ image
            title: title || '',
            text: text || '',
            link: link || '',
            linkText: linkText || '',
            order
        };

        const response = await fetchWithAuth('/api/slides', {
            method: 'POST',
            body: JSON.stringify(slide)
        });

        const newSlide = await response.json();
        slides.push(newSlide);
        renderSlidesAdmin();
        showNotification('–°–ª–∞–π–¥ –¥–æ–¥–∞–Ω–æ!');
        unsavedChanges = false;
        resetInactivityTimer();

        // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—ñ–≤
        document.getElementById('slide-img-url').value = '';
        document.getElementById('slide-img-file').value = '';
        document.getElementById('slide-title').value = '';
        document.getElementById('slide-text').value = '';
        document.getElementById('slide-link').value = '';
        document.getElementById('slide-link-text').value = '';
        document.getElementById('slide-order').value = '';
} catch (err) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Å–ª–∞–π–¥—É:', err);
        showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –¥–æ–¥–∞—Ç–∏ —Å–ª–∞–π–¥: ' + err.message);
    } finally {
        button.disabled = false;
    }
}

// –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –∑ –¥–µ–±–æ–Ω—Å—ñ–Ω–≥–æ–º –¥–æ –∫–Ω–æ–ø–∫–∏
document.getElementById('slide-img-file').parentElement.querySelector('button[onclick="addSlide()"]').onclick = debounce(addSlide, 300);

    function editSlide(order) {
        const slide = slides.find(s => s.order === order);
        if (slide) {
            const modal = document.getElementById('modal');
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Å–ª–∞–π–¥</h3>
                    <input type="number" id="edit-slide-order" value="${slide.order}"><br/>
                    <label for="edit-slide-order">–ü–æ—Ä—è–¥–∫–æ–≤–∏–π –Ω–æ–º–µ—Ä</label>
                    <input type="text" id="edit-slide-img-url" value="${slide.img || ''}"><br/>
                    <label for="edit-slide-img-url">URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</label>
                    <input type="file" id="edit-slide-img-file" accept="image/*"><br/>
                    <label for="edit-slide-img-file">–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</label>
                    ${slide.img ? `<img src="${slide.img}" style="max-width: 100px;">` : ''}
                    <input type="text" id="edit-slide-url" value="${slide.url}"><br/>
                    <label for="edit-slide-url">–ü–æ—Å–∏–ª–∞–Ω–Ω—è</label>
                    <div class="modal-actions">
                        <button id="save-slide-btn">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                        <button id="cancel-slide-btn">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
            document.getElementById('save-slide-btn').addEventListener('click', () => saveSlideEdit(order));
            document.getElementById('cancel-slide-btn').addEventListener('click', closeModal);
            resetInactivityTimer();
        }
    }

    function saveSlideEdit(oldOrder) {
        const newOrder = parseInt(document.getElementById('edit-slide-order').value);
        const newImgUrl = document.getElementById('edit-slide-img-url').value;
        const newImgFile = document.getElementById('edit-slide-img-file').files[0];
        const newUrl = document.getElementById('edit-slide-url').value;

        if (isNaN(newOrder)) {
            alert('–í–≤–µ–¥—ñ—Ç—å –ø–æ—Ä—è–¥–∫–æ–≤–∏–π –Ω–æ–º–µ—Ä —Å–ª–∞–π–¥—É!');
            return;
        }

        const slide = slides.find(s => s.order === oldOrder);
        if (slide) {
            slide.order = newOrder;
            slide.url = newUrl || '#';
            if (newImgUrl) slide.img = newImgUrl;

            if (newImgFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    slide.img = e.target.result;
                    slides = slides.filter(s => s.order !== oldOrder);
                    slides.push(slide);
                    slides.sort((a, b) => a.order - b.order);
                    localStorage.setItem('slides', LZString.compressToUTF16(JSON.stringify(slides)));
                    closeModal();
                    renderAdmin();
                    showNotification('–°–ª–∞–π–¥ –≤—ñ–¥—Ä–µ–¥–∞–≥–æ–≤–∞–Ω–æ!');
                    unsavedChanges = false;
                    resetInactivityTimer();
                };
                reader.readAsDataURL(newImgFile);
            } else {
                slides = slides.filter(s => s.order !== oldOrder);
                slides.push(slide);
                slides.sort((a, b) => a.order - b.order);
                localStorage.setItem('slides', LZString.compressToUTF16(JSON.stringify(slides)));
                closeModal();
                renderAdmin();
                showNotification('–°–ª–∞–π–¥ –≤—ñ–¥—Ä–µ–¥–∞–≥–æ–≤–∞–Ω–æ!');
                unsavedChanges = false;
                resetInactivityTimer();
            }
        }
    }

    function deleteSlide(order) {
        if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Å–ª–∞–π–¥?')) {
            slides = slides.filter(s => s.order !== order);
            localStorage.setItem('slides', LZString.compressToUTF16(JSON.stringify(slides)));
            renderAdmin();
            showNotification('–°–ª–∞–π–¥ –≤–∏–¥–∞–ª–µ–Ω–æ!');
            unsavedChanges = false;
            resetInactivityTimer();
        }
    }

    function toggleSlideshow() {
        settings.showSlides = document.getElementById('slide-toggle').checked;
        localStorage.setItem('settings', LZString.compressToUTF16(JSON.stringify(settings)));
        renderAdmin();
        showNotification('–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–ª–∞–π–¥—à–æ—É –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
        unsavedChanges = false;
        resetInactivityTimer();
    }

    function exportSiteBackup() {
        const data = {
            settings,
            categories,
            filters,
            orderFields,
            slides
        };
        const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'site-backup.json';
        a.click();
        URL.revokeObjectURL(url);
        showNotification('–ë–µ–∫–∞–ø —Å–∞–π—Ç—É –µ–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ!');
        resetInactivityTimer();
    }

    function exportProductsBackup() {
        const blob = new Blob([JSON.stringify(products)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'products-backup.json';
        a.click();
        URL.revokeObjectURL(url);
        showNotification('–ë–µ–∫–∞–ø —Ç–æ–≤–∞—Ä—ñ–≤ –µ–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ!');
        resetInactivityTimer();
    }

    function exportOrdersBackup() {
        const blob = new Blob([JSON.stringify(orders)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'orders-backup.json';
        a.click();
        URL.revokeObjectURL(url);
        showNotification('–ë–µ–∫–∞–ø –∑–∞–º–æ–≤–ª–µ–Ω—å –µ–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ!');
        resetInactivityTimer();
    }

    function importSiteBackup() {
        const file = document.getElementById('import-site-file').files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    settings = data.settings || settings;
                    categories = data.categories || categories;
                    filters = data.filters || filters;
                    orderFields = data.orderFields || orderFields;
                    slides = data.slides || slides;
                    localStorage.setItem('settings', LZString.compressToUTF16(JSON.stringify(settings)));
                    localStorage.setItem('categories', LZString.compressToUTF16(JSON.stringify(categories)));
                    localStorage.setItem('filters', LZString.compressToUTF16(JSON.stringify(filters)));
                    localStorage.setItem('orderFields', LZString.compressToUTF16(JSON.stringify(orderFields)));
                    localStorage.setItem('slides', LZString.compressToUTF16(JSON.stringify(slides)));
                    renderAdmin();
                    showNotification('–ë–µ–∫–∞–ø —Å–∞–π—Ç—É —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ!');
                    unsavedChanges = false;
                    resetInactivityTimer();
                } catch (err) {
                    alert('–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É: ' + err.message);
                }
            };
            reader.readAsText(file);
        } else {
            alert('–í–∏–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª –¥–ª—è —ñ–º–ø–æ—Ä—Ç—É!');
        }
    }

    function importProductsBackup() {
        const file = document.getElementById('import-products-file').files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    products = JSON.parse(e.target.result);
                    localStorage.setItem('products', LZString.compressToUTF16(JSON.stringify(products)));
                    renderAdmin();
                    showNotification('–ë–µ–∫–∞–ø —Ç–æ–≤–∞—Ä—ñ–≤ —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ!');
                    unsavedChanges = false;
                    resetInactivityTimer();
                } catch (err) {
                    alert('–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É: ' + err.message);
                }
            };
            reader.readAsText(file);
        } else {
            alert('–í–∏–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª –¥–ª—è —ñ–º–ø–æ—Ä—Ç—É!');
        }
    }

    function importOrdersBackup() {
        const file = document.getElementById('import-orders-file').files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    orders = JSON.parse(e.target.result);
                    localStorage.setItem('orders', LZString.compressToUTF16(JSON.stringify(orders)));
                    renderAdmin();
                    showNotification('–ë–µ–∫–∞–ø –∑–∞–º–æ–≤–ª–µ–Ω—å —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ!');
                    unsavedChanges = false;
                    resetInactivityTimer();
                } catch (err) {
                    alert('–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É: ' + err.message);
                }
            };
            reader.readAsText(file);
        } else {
            alert('–í–∏–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª –¥–ª—è —ñ–º–ø–æ—Ä—Ç—É!');
        }
    }

    function generateSitemap() {
        const baseUrl = settings.baseUrl || 'https://www.example.com';
        let sitemap = `<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
    <url>
        <loc>${baseUrl}/</loc>
        <lastmod>${new Date().toISOString().split('T')[0]}</lastmod>
        <changefreq>daily</changefreq>
        <priority>1.0</priority>
    </url>`;

        categories.forEach(cat => {
            sitemap += `
    <url>
        <loc>${baseUrl}/catalog/${cat.slug}</loc>
        <lastmod>${new Date().toISOString().split('T')[0]}</lastmod>
        <changefreq>weekly</changefreq>
        <priority>0.8</priority>
    </url>`;
            (cat.subcategories || []).forEach(sub => {
                sitemap += `
    <url>
        <loc>${baseUrl}/catalog/${cat.slug}/${sub.slug}</loc>
        <lastmod>${new Date().toISOString().split('T')[0]}</lastmod>
        <changefreq>weekly</changefreq>
        <priority>0.7</priority>
    </url>`;
            });
        });

        products.forEach(product => {
            if (product.visible) {
                sitemap += `
    <url>
        <loc>${baseUrl}/product/${product.slug}</loc>
        <lastmod>${new Date().toISOString().split('T')[0]}</lastmod>
        <changefreq>weekly</changefreq>
        <priority>0.6</priority>
    </url>`;
            }
        });

        sitemap += `
</urlset>`;
        return sitemap;
    }

    function downloadSitemap() {
        const sitemap = generateSitemap();
        const blob = new Blob([sitemap], { type: 'application/xml' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'sitemap.xml';
        a.click();
        URL.revokeObjectURL(url);
        showNotification('Sitemap –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ!');
        resetInactivityTimer();
    }

    let newProduct = {
        type: 'simple',
        colors: [],
        photos: [],
        sizes: [],
        groupProducts: [],
        active: true,
        visible: true
    };

// –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ —ñ–º–ø–æ—Ä—Ç—É –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É —Ñ–∞–π–ª—É
document.getElementById('import-site-file').addEventListener('change', function() {
    importSiteBackup();
});

document.getElementById('import-products-file').addEventListener('change', function() {
    importProductsBackup();
});

document.getElementById('import-orders-file').addEventListener('change', function() {
    importOrdersBackup();
});

document.getElementById('bulk-price-file').addEventListener('change', function() {
    uploadBulkPrices();
});

function openAddProductModal() {
    // –°–∫–∏–¥–∞—î–º–æ –ø–æ–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ—ó –∑–º—ñ–Ω–Ω–æ—ó newProduct –∑–∞–º—ñ—Å—Ç—å —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ—ó
    newProduct.type = 'simple';
    newProduct.photos = [];
    newProduct.colors = [];
    newProduct.sizes = [];
    newProduct.groupProducts = [];
    newProduct.active = true;
    newProduct.visible = true;

    const modal = document.getElementById('modal');
    modal.innerHTML = `
        <div class="modal-content">
            <h3>–î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä</h3>
            <select id="product-type" onchange="updateProductType()">
                <option value="simple">–ü—Ä–æ—Å—Ç–∏–π —Ç–æ–≤–∞—Ä</option>
                <option value="mattresses">–ú–∞—Ç—Ä–∞—Ü–∏</option>
                <option value="group">–ì—Ä—É–ø–æ–≤–∏–π —Ç–æ–≤–∞—Ä</option>
            </select><br/>
            <label for="product-type">–¢–∏–ø —Ç–æ–≤–∞—Ä—É</label>
            <input type="text" id="product-name" placeholder="–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É"><br/>
            <label for="product-name">–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É</label>
            <input type="text" id="product-slug" placeholder="–®–ª—è—Ö —Ç–æ–≤–∞—Ä—É"><br/>
            <label for="product-slug">–®–ª—è—Ö —Ç–æ–≤–∞—Ä—É</label>
            <input type="text" id="product-brand" placeholder="–í–∏—Ä–æ–±–Ω–∏–∫"><br/>
            <label for="product-brand">–í–∏—Ä–æ–±–Ω–∏–∫</label>
            <select id="product-category">
                <option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</option>
                ${categories.map(c => `<option value="${c.name}">${c.name}</option>`).join('')}
            </select><br/>
            <label for="product-category">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
            <select id="product-subcategory">
                <option value="">–ë–µ–∑ –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</option>
            </select><br/>
            <label for="product-subcategory">–ü—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
            <input type="text" id="product-material" placeholder="–ú–∞—Ç–µ—Ä—ñ–∞–ª"><br/>
            <label for="product-material">–ú–∞—Ç–µ—Ä—ñ–∞–ª</label>
            <div id="price-fields"></div>
            <input type="datetime-local" id="product-sale-end" placeholder="–î–∞—Ç–∞ –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è –∞–∫—Ü—ñ—ó"><br/>
            <label for="product-sale-end">–î–∞—Ç–∞ –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è –∞–∫—Ü—ñ—ó</label>
            <select id="product-visible">
                <option value="true">–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –Ω–∞ —Å–∞–π—Ç—ñ</option>
                <option value="false">–ù–µ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏</option>
            </select><br/>
            <label for="product-visible">–í–∏–¥–∏–º—ñ—Å—Ç—å</label>
            <div id="product-description-editor"></div>
            <input type="hidden" id="product-description">
            <label for="product-description">–û–ø–∏—Å —Ç–æ–≤–∞—Ä—É</label>
            <h4>–†–æ–∑–º—ñ—Ä–∏</h4>
            <input type="number" id="product-width-cm" placeholder="–®–∏—Ä–∏–Ω–∞ (—Å–º)" min="0" step="0.1"><br/>
            <label for="product-width-cm">–®–∏—Ä–∏–Ω–∞ (—Å–º)</label>
            <input type="number" id="product-depth-cm" placeholder="–ì–ª–∏–±–∏–Ω–∞ (—Å–º)" min="0" step="0.1"><br/>
            <label for="product-depth-cm">–ì–ª–∏–±–∏–Ω–∞ (—Å–º)</label>
            <input type="number" id="product-height-cm" placeholder="–í–∏—Å–æ—Ç–∞ (—Å–º)" min="0" step="0.1"><br/>
            <label for="product-height-cm">–í–∏—Å–æ—Ç–∞ (—Å–º)</label>
            <input type="number" id="product-length-cm" placeholder="–î–æ–≤–∂–∏–Ω–∞ (—Å–º)" min="0" step="0.1"><br/>
            <label for="product-length-cm">–î–æ–≤–∂–∏–Ω–∞ (—Å–º)</label>
            <h4>–§–æ—Ç–æ–≥—Ä–∞—Ñ—ñ—ó</h4>
            <input type="text" id="product-photo-url" placeholder="URL —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ—ó"><br/>
            <label for="product-photo-url">URL —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ—ó</label>
            <input type="file" id="product-photo-file" accept="image/jpeg,image/png,image/gif,image/webp" multiple><br/>
            <label for="product-photo-file">–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ—é</label>
            <button onclick="addProductPhoto()">–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ</button>
            <div id="product-photo-list" class="photo-list"></div>
            <h4>–ö–æ–ª—å–æ—Ä–∏</h4>
            <input type="text" id="product-color-name" placeholder="–ù–∞–∑–≤–∞ –∫–æ–ª—å–æ—Ä—É"><br/>
            <label for="product-color-name">–ù–∞–∑–≤–∞ –∫–æ–ª—å–æ—Ä—É</label>
            <input type="color" id="product-color-value" value="#000000"><br/>
            <label for="product-color-value">–ó–Ω–∞—á–µ–Ω–Ω—è –∫–æ–ª—å–æ—Ä—É</label>
            <input type="number" id="product-color-price-change" placeholder="–ó–º—ñ–Ω–∞ —Ü—ñ–Ω–∏ (–≥—Ä–Ω)" step="0.01"><br/>
            <label for="product-color-price-change">–ó–º—ñ–Ω–∞ —Ü—ñ–Ω–∏ –¥–ª—è –∫–æ–ª—å–æ—Ä—É (–≥—Ä–Ω)</label>
            <input type="text" id="product-color-photo-url" placeholder="URL —Ñ–æ—Ç–æ –∫–æ–ª—å–æ—Ä—É"><br/>
            <label for="product-color-photo-url">URL —Ñ–æ—Ç–æ –∫–æ–ª—å–æ—Ä—É</label>
            <input type="file" id="product-color-photo-file" accept="image/jpeg,image/png,image/gif,image/webp"><br/>
            <label for="product-color-photo-file">–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ñ–æ—Ç–æ –∫–æ–ª—å–æ—Ä—É</label>
            <button onclick="addProductColor()">–î–æ–¥–∞—Ç–∏ –∫–æ–ª—ñ—Ä</button>
            <div id="product-color-list" class="color-photo-list"></div>
            <div id="mattress-sizes" class="type-specific">
                <h4>–†–æ–∑–º—ñ—Ä–∏ –º–∞—Ç—Ä–∞—Ü—ñ–≤</h4>
                <input type="text" id="mattress-size-name" placeholder="–†–æ–∑–º—ñ—Ä (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 90x190)"><br/>
                <label for="mattress-size-name">–†–æ–∑–º—ñ—Ä</label>
                <input type="number" id="mattress-size-price" placeholder="–¶—ñ–Ω–∞ (–≥—Ä–Ω)" min="0"><br/>
                <label for="mattress-size-price">–¶—ñ–Ω–∞ (–≥—Ä–Ω)</label>
                <button onclick="addMattressSize()">–î–æ–¥–∞—Ç–∏ —Ä–æ–∑–º—ñ—Ä</button>
                <div id="mattress-size-list"></div>
            </div>
            <div id="group-products" class="type-specific">
                <h4>–ì—Ä—É–ø–æ–≤—ñ —Ç–æ–≤–∞—Ä–∏</h4>
                <div class="group-product-search">
                    <input type="text" id="group-product-search" placeholder="–ü–æ—à—É–∫ —Ç–æ–≤–∞—Ä—ñ–≤" oninput="searchGroupProducts()">
                    <div id="group-product-results"></div>
                </div>
                <div id="group-product-list"></div>
            </div>
            <div class="modal-actions">
                <button onclick="saveNewProduct()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                <button onclick="closeModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    `;
    modal.classList.add('active');
    updateProductType();
    initializeProductEditor();

    // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –ø—ñ—Å–ª—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó DOM
    setTimeout(() => {
        const categorySelect = document.getElementById('product-category');
        if (categorySelect) {
            categorySelect.addEventListener('change', updateSubcategories);
            updateSubcategories();
        }

        const photoInput = document.getElementById('product-photo-file');
        if (photoInput) {
            photoInput.addEventListener('change', () => {
                const files = photoInput.files;
                Array.from(files).forEach(file => {
                    if (!newProduct.photos.includes(file)) {
                        newProduct.photos.push(file);
                    }
                });
                renderPhotoList();
                resetInactivityTimer();
            });
        }

        const colorPhotoInput = document.getElementById('product-color-photo-file');
        if (colorPhotoInput) {
            colorPhotoInput.addEventListener('change', () => {
                const file = colorPhotoInput.files[0];
                if (file) {
                    const name = document.getElementById('product-color-name').value;
                    const value = document.getElementById('product-color-value').value;
                    const priceChange = parseFloat(document.getElementById('product-color-price-change').value) || 0;
                    if (name && value) {
                        const color = { name, value, priceChange, photo: file };
                        newProduct.colors.push(color);
                        document.getElementById('product-color-name').value = '';
                        document.getElementById('product-color-value').value = '#000000';
                        document.getElementById('product-color-price-change').value = '';
                        document.getElementById('product-color-photo-url').value = '';
                        document.getElementById('product-color-photo-file').value = '';
                        renderColorsList();
                        resetInactivityTimer();
                    }
                }
            });
        }
    }, 0);

    resetInactivityTimer();
}

function updateProductType() {
    newProduct.type = document.getElementById('product-type').value;
    document.querySelectorAll('.type-specific').forEach(el => el.classList.remove('active'));
    if (newProduct.type === 'mattresses') {
        document.getElementById('mattress-sizes').classList.add('active');
    } else if (newProduct.type === 'group') {
        document.getElementById('group-products').classList.add('active');
    }
    renderPriceFields(); // –û–Ω–æ–≤–ª—é—î–º–æ –ø–æ–ª—è —Ü—ñ–Ω–∏
    resetInactivityTimer();
}

function renderPriceFields() {
    const priceFields = document.getElementById('price-fields');
    if (!priceFields) return; // –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –ø–æ–º–∏–ª–∫–∏, —è–∫—â–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ

    if (newProduct.type === 'simple') {
        priceFields.innerHTML = `
            <input type="number" id="product-price" value="${newProduct.price || ''}" placeholder="–¶—ñ–Ω–∞ (–≥—Ä–Ω)" min="0"><br/>
            <label for="product-price">–¶—ñ–Ω–∞ (–≥—Ä–Ω)</label>
            <input type="number" id="product-sale-price" value="${newProduct.salePrice || ''}" placeholder="–ê–∫—Ü—ñ–π–Ω–∞ —Ü—ñ–Ω–∞ (–≥—Ä–Ω)" min="0"><br/>
            <label for="product-sale-price">–ê–∫—Ü—ñ–π–Ω–∞ —Ü—ñ–Ω–∞ (–≥—Ä–Ω)</label>
        `;
    } else {
        priceFields.innerHTML = ''; // –û—á–∏—â–∞—î–º–æ –ø–æ–ª—è –¥–ª—è –º–∞—Ç—Ä–∞—Ü—ñ–≤ —ñ –≥—Ä—É–ø–æ–≤–∏—Ö —Ç–æ–≤–∞—Ä—ñ–≤
    }
}

function updateSubcategories() {
    const categoryName = document.getElementById('product-category').value;
    const subcatSelect = document.getElementById('product-subcategory');
    if (subcatSelect) {
        const category = categories.find(c => c.name === categoryName);
        subcatSelect.innerHTML = '<option value="">–ë–µ–∑ –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</option>';
        if (category && category.subcategories && category.subcategories.length > 0) {
            subcatSelect.innerHTML += category.subcategories
                .map(sub => `<option value="${sub.name}">${sub.name}</option>`)
                .join('');
        } else {
            subcatSelect.innerHTML = '<option value="">–ü—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –≤—ñ–¥—Å—É—Ç–Ω—ñ</option>';
        }
    }
}

function addProductPhoto() {
    const url = document.getElementById('product-photo-url').value;
    const fileInput = document.getElementById('product-photo-file');
    const files = fileInput.files;

    if (files.length > 0) {
        let allValid = true;
        Array.from(files).forEach(file => {
            const validation = validateFile(file);
            if (!validation.valid) {
                alert(validation.error);
                allValid = false;
                return;
            }
            newProduct.photos.push(file);
        });
        if (allValid) {
            fileInput.value = '';
            document.getElementById('product-photo-url').value = '';
            renderPhotoList();
            resetInactivityTimer();
        }
    } else if (url) {
        newProduct.photos.push(url);
        document.getElementById('product-photo-url').value = '';
        document.getElementById('product-photo-file').value = '';
        renderPhotoList();
        resetInactivityTimer();
    } else {
        alert('–í–≤–µ–¥—ñ—Ç—å URL –∞–±–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ñ–∞–π–ª!');
    }
}

function renderPhotoList() {
    const photoList = document.getElementById('product-photo-list');
    photoList.innerHTML = newProduct.photos.map((photo, index) => {
        let photoSrc = '';
        if (typeof photo === 'string') {
            photoSrc = photo;
        } else if (photo instanceof File) {
            photoSrc = URL.createObjectURL(photo);
        }
        return `
            <div class="photo-item draggable" draggable="true" ondragstart="dragPhoto(event, ${index})" ondragover="allowDropPhoto(event)" ondrop="dropPhoto(event, ${index})">
                <img src="${photoSrc}" style="max-width: 50px;">
                <button class="delete-btn" onclick="deleteProductPhoto(${index})">–í–∏–¥–∞–ª–∏—Ç–∏</button>
            </div>
        `;
    }).join('');
}

    function dragPhoto(event, index) {
        event.dataTransfer.setData('text/plain', index);
        event.target.classList.add('dragging');
    }

    function allowDropPhoto(event) {
        event.preventDefault();
    }

    function dropPhoto(event, targetIndex) {
        event.preventDefault();
        const sourceIndex = parseInt(event.dataTransfer.getData('text/plain'));
        if (sourceIndex !== targetIndex) {
            const [movedPhoto] = newProduct.photos.splice(sourceIndex, 1);
            newProduct.photos.splice(targetIndex, 0, movedPhoto);
            renderPhotoList();
            resetInactivityTimer();
        }
        document.querySelectorAll('.photo-item').forEach(item => item.classList.remove('dragging'));
    }

    function deleteProductPhoto(index) {
        newProduct.photos.splice(index, 1);
        renderPhotoList();
        resetInactivityTimer();
    }

function addProductColor() {
    const name = document.getElementById('product-color-name').value;
    const value = document.getElementById('product-color-value').value;
    const priceChange = parseFloat(document.getElementById('product-color-price-change').value) || 0;
    const url = document.getElementById('product-color-photo-url').value;
    const colorPhotoInput = document.getElementById('product-color-photo-file');
    const file = colorPhotoInput ? colorPhotoInput.files[0] : null;

    if (name && value) {
        const color = { name, value, priceChange };
        if (file) {
            const validation = validateFile(file);
            if (!validation.valid) {
                alert(validation.error);
                return;
            }
            color.photo = file; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ñ–∞–π–ª, –∞ –Ω–µ Base64
            newProduct.colors.push(color);
            document.getElementById('product-color-name').value = '';
            document.getElementById('product-color-value').value = '#000000';
            document.getElementById('product-color-price-change').value = '';
            document.getElementById('product-color-photo-url').value = '';
            if (colorPhotoInput) colorPhotoInput.value = '';
            renderColorsList();
            resetInactivityTimer();
        } else if (url) {
            color.photo = url;
            newProduct.colors.push(color);
            document.getElementById('product-color-name').value = '';
            document.getElementById('product-color-value').value = '#000000';
            document.getElementById('product-color-price-change').value = '';
            document.getElementById('product-color-photo-url').value = '';
            if (colorPhotoInput) colorPhotoInput.value = '';
            renderColorsList();
            resetInactivityTimer();
        } else {
            newProduct.colors.push(color);
            document.getElementById('product-color-name').value = '';
            document.getElementById('product-color-value').value = '#000000';
            document.getElementById('product-color-price-change').value = '';
            document.getElementById('product-color-photo-url').value = '';
            if (colorPhotoInput) colorPhotoInput.value = '';
            renderColorsList();
            resetInactivityTimer();
        }
    } else {
        alert('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É —Ç–∞ –≤–∏–±–µ—Ä—ñ—Ç—å –∫–æ–ª—ñ—Ä!');
    }
}

function renderColorsList() {
    const colorList = document.getElementById('product-color-list');
    colorList.innerHTML = newProduct.colors.map((color, index) => {
        let photoSrc = '';
        if (color.photo) {
            if (typeof color.photo === 'string') {
                photoSrc = color.photo;
            } else if (color.photo instanceof File) {
                photoSrc = URL.createObjectURL(color.photo);
            }
        }
        return `
            <div class="color-item">
                <span class="color-preview" style="background-color: ${color.value};"></span>
                ${color.name} (–ó–º—ñ–Ω–∞ —Ü—ñ–Ω–∏: ${color.priceChange} –≥—Ä–Ω)
                ${photoSrc ? `<img src="${photoSrc}" alt="–§–æ—Ç–æ –∫–æ–ª—å–æ—Ä—É ${color.name}" style="max-width: 30px;">` : ''}
                <button class="delete-btn" onclick="deleteProductColor(${index})">–í–∏–¥–∞–ª–∏—Ç–∏</button>
            </div>
        `;
    }).join('');
}

    function deleteProductColor(index) {
        newProduct.colors.splice(index, 1);
        renderColorsList();
        resetInactivityTimer();
    }

    function addMattressSize() {
        const name = document.getElementById('mattress-size-name').value;
        const price = parseFloat(document.getElementById('mattress-size-price').value);

        if (name && !isNaN(price) && price >= 0) {
            newProduct.sizes.push({ name, price });
            document.getElementById('mattress-size-name').value = '';
            document.getElementById('mattress-size-price').value = '';
            renderMattressSizes();
            resetInactivityTimer();
        } else {
            alert('–í–≤–µ–¥—ñ—Ç—å —Ä–æ–∑–º—ñ—Ä —Ç–∞ —Ü—ñ–Ω—É!');
        }
    }

    function renderMattressSizes() {
        const sizeList = document.getElementById('mattress-size-list');
        sizeList.innerHTML = newProduct.sizes.map((size, index) => `
            <div class="mattress-size">
                ${size.name}: ${size.price} –≥—Ä–Ω
                <button class="delete-btn" onclick="deleteMattressSize(${index})">–í–∏–¥–∞–ª–∏—Ç–∏</button>
            </div>
        `).join('');
    }

    function deleteMattressSize(index) {
        newProduct.sizes.splice(index, 1);
        renderMattressSizes();
        resetInactivityTimer();
    }

function searchGroupProducts() {
    const query = document.getElementById('group-product-search').value.toLowerCase();
    const results = document.getElementById('group-product-results');
    const filteredProducts = products.filter(p => 
        p.active && 
        p.type === 'simple' && 
        (p.name.toLowerCase().includes(query) || p.id.toString().includes(query))
    );
    results.innerHTML = filteredProducts.slice(0, 5).map(p => `
        <div>
            #${p.id} ${p.name}
            <button onclick="addGroupProduct(${p.id})">–î–æ–¥–∞—Ç–∏</button>
        </div>
    `).join('');
    resetInactivityTimer();
}

    function addGroupProduct(productId) {
        if (!newProduct.groupProducts.includes(productId)) {
            newProduct.groupProducts.push(productId);
            renderGroupProducts();
            document.getElementById('group-product-search').value = '';
            document.getElementById('group-product-results').innerHTML = '';
            resetInactivityTimer();
        }
    }

    function renderGroupProducts() {
        const groupList = document.getElementById('group-product-list');
        if (groupList) {
            groupList.innerHTML = newProduct.groupProducts.map((pid, index) => {
                const p = products.find(pr => pr.id === pid);
                return p ? `
                    <div class="group-product draggable" draggable="true" ondragstart="dragGroupProduct(event, ${index})" ondragover="allowDropGroupProduct(event)" ondrop="dropGroupProduct(event, ${index})">
                        #${p.id} ${p.name}
                        <button class="delete-btn" onclick="deleteGroupProduct(${pid})">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                    </div>
                ` : '';
            }).join('');
        }
    }

    function dragGroupProduct(event, index) {
        event.dataTransfer.setData('text/plain', index);
        event.target.classList.add('dragging');
    }

    function allowDropGroupProduct(event) {
        event.preventDefault();
    }

    function dropGroupProduct(event, targetIndex) {
        event.preventDefault();
        const sourceIndex = parseInt(event.dataTransfer.getData('text/plain'));
        if (sourceIndex !== targetIndex) {
            const [movedProduct] = newProduct.groupProducts.splice(sourceIndex, 1);
            newProduct.groupProducts.splice(targetIndex, 0, movedProduct);
            renderGroupProducts();
            unsavedChanges = true;
            resetInactivityTimer();
        }
        document.querySelectorAll('.group-product').forEach(item => item.classList.remove('dragging'));
    }

    function deleteGroupProduct(productId) {
        newProduct.groupProducts = newProduct.groupProducts.filter(pid => pid !== productId);
        renderGroupProducts();
        resetInactivityTimer();
    }

async function saveNewProduct() {
    try {
        const tokenRefreshed = await refreshToken();
        if (!tokenRefreshed) {
            showNotification('–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
            showSection('admin-login');
            return;
        }

        const name = document.getElementById('product-name').value.trim();
        const slug = document.getElementById('product-slug').value.trim();
        const brand = document.getElementById('product-brand').value.trim();
        const category = document.getElementById('product-category').value;
        const subcategory = document.getElementById('product-subcategory').value;
        const material = document.getElementById('product-material').value.trim();
        let price = null;
        let salePrice = null;
        if (newProduct.type === 'simple') {
            const priceValue = document.getElementById('product-price')?.value.trim();
            price = priceValue ? parseFloat(priceValue) : null;
            const salePriceValue = document.getElementById('product-sale-price')?.value.trim();
            salePrice = salePriceValue ? parseFloat(salePriceValue) : null;
        }
        const saleEnd = document.getElementById('product-sale-end').value;
        const visible = document.getElementById('product-visible').value === 'true';
        const description = document.getElementById('product-description').value || '';
        const widthCm = parseFloat(document.getElementById('product-width-cm').value) || null;
        const depthCm = parseFloat(document.getElementById('product-depth-cm').value) || null;
        const heightCm = parseFloat(document.getElementById('product-height-cm').value) || null;
        const lengthCm = parseFloat(document.getElementById('product-length-cm').value) || null;

        // –í–∞–ª—ñ–¥–∞—Ü—ñ—è
        if (!name || !slug || !category) {
            showNotification('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –Ω–∞–∑–≤—É, —à–ª—è—Ö —ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é —Ç–æ–≤–∞—Ä—É!');
            return;
        }

        if (slug && !/^[a-z0-9-]+$/.test(slug)) {
            showNotification('–®–ª—è—Ö —Ç–æ–≤–∞—Ä—É –º–æ–∂–µ –º—ñ—Å—Ç–∏—Ç–∏ –ª–∏—à–µ –º–∞–ª—ñ –ª–∞—Ç–∏–Ω—Å—å–∫—ñ –ª—ñ—Ç–µ—Ä–∏, —Ü–∏—Ñ—Ä–∏ —Ç–∞ –¥–µ—Ñ—ñ—Å–∏!');
            return;
        }

        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —É–Ω—ñ–∫–∞–ª—å–Ω–æ—Å—Ç—ñ slug
        try {
            const slugCheck = await fetchWithAuth(`/api/products?slug=${encodeURIComponent(slug)}`);
            const existingProducts = await slugCheck.json();
            if (existingProducts.some(p => p.slug === slug)) {
                showNotification('–®–ª—è—Ö —Ç–æ–≤–∞—Ä—É –º–∞—î –±—É—Ç–∏ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–º!');
                return;
            }
        } catch (err) {
            console.error('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —É–Ω—ñ–∫–∞–ª—å–Ω–æ—Å—Ç—ñ:', err);
            showNotification('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —É–Ω—ñ–∫–∞–ª—å–Ω–æ—Å—Ç—ñ: ' + err.message);
            return;
        }

        if (newProduct.type === 'simple' && (isNaN(price) || price < 0)) {
            showNotification('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É —Ü—ñ–Ω—É –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä—É!');
            return;
        }

        if (salePrice !== null && (isNaN(salePrice) || salePrice < 0)) {
            showNotification('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É –∞–∫—Ü—ñ–π–Ω—É —Ü—ñ–Ω—É!');
            return;
        }

        if (saleEnd) {
            const saleEndDate = new Date(saleEnd);
            if (isNaN(saleEndDate.getTime())) {
                showNotification('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É –¥–∞—Ç—É –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è –∞–∫—Ü—ñ—ó!');
                return;
            }
            if (saleEndDate < new Date()) {
                showNotification('–î–∞—Ç–∞ –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è –∞–∫—Ü—ñ—ó –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –≤ –º–∏–Ω—É–ª–æ–º—É!');
                return;
            }
        }

        if (newProduct.type === 'mattresses' && newProduct.sizes.length === 0) {
            showNotification('–î–æ–¥–∞–π—Ç–µ —Ö–æ—á–∞ –± –æ–¥–∏–Ω —Ä–æ–∑–º—ñ—Ä –¥–ª—è –º–∞—Ç—Ä–∞—Ü—É!');
            return;
        }

        if (newProduct.type === 'group' && newProduct.groupProducts.length === 0) {
            showNotification('–î–æ–¥–∞–π—Ç–µ —Ö–æ—á–∞ –± –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä –¥–æ –≥—Ä—É–ø–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä—É!');
            return;
        }

        if (widthCm !== null && (widthCm <= 0 || isNaN(widthCm))) {
            showNotification('–®–∏—Ä–∏–Ω–∞ —Ç–æ–≤–∞—Ä—É –º–∞—î –±—É—Ç–∏ –±—ñ–ª—å—à–µ 0!');
            return;
        }

        if (depthCm !== null && (depthCm <= 0 || isNaN(depthCm))) {
            showNotification('–ì–ª–∏–±–∏–Ω–∞ —Ç–æ–≤–∞—Ä—É –º–∞—î –±—É—Ç–∏ –±—ñ–ª—å—à–µ 0!');
            return;
        }

        if (heightCm !== null && (heightCm <= 0 || isNaN(heightCm))) {
            showNotification('–í–∏—Å–æ—Ç–∞ —Ç–æ–≤–∞—Ä—É –º–∞—î –±—É—Ç–∏ –±—ñ–ª—å—à–µ 0!');
            return;
        }

        if (lengthCm !== null && (lengthCm <= 0 || isNaN(lengthCm))) {
            showNotification('–î–æ–≤–∂–∏–Ω–∞ —Ç–æ–≤–∞—Ä—É –º–∞—î –±—É—Ç–∏ –±—ñ–ª—å—à–µ 0!');
            return;
        }

        // –î–æ–¥–∞–≤–∞–Ω–Ω—è –±—Ä–µ–Ω–¥—É, —è–∫—â–æ –π–æ–≥–æ –Ω–µ–º–∞—î
        if (brand && !brands.includes(brand)) {
            try {
                const response = await fetchWithAuth('/api/brands', {
                    method: 'POST',
                    body: JSON.stringify({ name: brand })
                });
                if (response.ok) {
                    brands.push(brand);
                    updateBrandOptions();
                }
            } catch (e) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –±—Ä–µ–Ω–¥—É:', e);
            }
        }

        // –î–æ–¥–∞–≤–∞–Ω–Ω—è –º–∞—Ç–µ—Ä—ñ–∞–ª—É, —è–∫—â–æ –π–æ–≥–æ –Ω–µ–º–∞—î
        if (material && !materials.includes(material)) {
            try {
                const response = await fetchWithAuth('/api/materials', {
                    method: 'POST',
                    body: JSON.stringify({ name: material })
                });
                if (response.ok) {
                    materials.push(material);
                    updateMaterialOptions();
                }
            } catch (e) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –º–∞—Ç–µ—Ä—ñ–∞–ª—É:', e);
            }
        }

        let product = {
            type: newProduct.type,
            name,
            slug,
            brand: brand || '',
            category: category || '',
            subcategory: subcategory || '',
            material: material || '',
            price: newProduct.type === 'simple' ? price : null,
            salePrice: salePrice,
            saleEnd: saleEnd || null,
            description: description || '',
            widthCm,
            depthCm,
            heightCm,
            lengthCm,
            photos: [],
            colors: newProduct.colors.map(color => ({
                name: color.name,
                value: color.value,
                priceChange: Number(color.priceChange) || 0,
                photo: null
            })),
            sizes: newProduct.sizes.map(size => ({
                name: size.name,
                price: Number(size.price) || 0
            })),
            groupProducts: newProduct.groupProducts,
            active: true,
            visible: visible
        };

        // –û–±—Ä–æ–±–∫–∞ –∑–æ–±—Ä–∞–∂–µ–Ω—å —É –æ–ø–∏—Å—ñ
        const mediaUrls = [];
        const parser = new DOMParser();
        const doc = parser.parseFromString(description, 'text/html');
        const images = doc.querySelectorAll('img');

        for (let img of images) {
            const src = img.getAttribute('src');
            if (src && src.startsWith('blob:')) {
                try {
                    const response = await fetch(src);
                    const blob = await response.blob();
                    const formData = new FormData();
                    formData.append('file', blob, `description-image-${Date.now()}.png`);
                    const uploadResponse = await fetchWithAuth('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const uploadData = await uploadResponse.json();
                    if (uploadData.url) {
                        mediaUrls.push({ oldUrl: src, newUrl: uploadData.url });
                    } else {
                        throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è');
                    }
                } catch (err) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑ –æ–ø–∏—Å—É:', err);
                    showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑ –æ–ø–∏—Å—É: ' + err.message);
                    return;
                }
            }
        }

        let updatedDescription = description;
        mediaUrls.forEach(({ oldUrl, newUrl }) => {
            updatedDescription = updatedDescription.replace(oldUrl, newUrl);
        });
        product.description = updatedDescription;

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –æ—Å–Ω–æ–≤–Ω–∏—Ö —Ñ–æ—Ç–æ
        const photoFiles = newProduct.photos.filter(photo => photo instanceof File);
        for (let file of photoFiles) {
            const validation = validateFile(file);
            if (!validation.valid) {
                showNotification(validation.error);
                return;
            }
            try {
                const formData = new FormData();
                formData.append('file', file);
                const response = await fetchWithAuth('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) {
                    throw new Error(`–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ: ${response.statusText}`);
                }
                const data = await response.json();
                product.photos.push(data.url);
            } catch (err) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ:', err);
                showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–æ—Ç–æ: ' + err.message);
                return;
            }
        }

        product.photos.push(...newProduct.photos.filter(photo => typeof photo === 'string'));

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ –∫–æ–ª—å–æ—Ä—ñ–≤
        for (let i = 0; i < newProduct.colors.length; i++) {
            const color = newProduct.colors[i];
            if (color.photo instanceof File) {
                const validation = validateFile(color.photo);
                if (!validation.valid) {
                    showNotification(validation.error);
                    return;
                }
                try {
                    const formData = new FormData();
                    formData.append('file', color.photo);
                    const response = await fetchWithAuth('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    if (!response.ok) {
                        throw new Error(`–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ –∫–æ–ª—å–æ—Ä—É: ${response.statusText}`);
                    }
                    const data = await response.json();
                    product.colors[i].photo = data.url;
                } catch (err) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ –∫–æ–ª—å–æ—Ä—É:', err);
                    showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–æ—Ç–æ –∫–æ–ª—å–æ—Ä—É: ' + err.message);
                    return;
                }
            } else if (typeof color.photo === 'string') {
                product.colors[i].photo = color.photo;
            }
        }

        // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—É (–±–µ–∑ –ø–æ–ª—è id, –Ω–µ—Ö–∞–π —Å–µ—Ä–≤–µ—Ä –≥–µ–Ω–µ—Ä—É—î)
        const response = await fetchWithAuth('/api/products', {
            method: 'POST',
            body: JSON.stringify(product)
        });

        const newProductData = await response.json();
        products.push(newProductData);
        closeModal();
        renderAdmin('products');
        showNotification('–¢–æ–≤–∞—Ä –¥–æ–¥–∞–Ω–æ!');
        unsavedChanges = false;
        resetInactivityTimer();
    } catch (err) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ —Ç–æ–≤–∞—Ä—É:', err, err.stack);
        showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –¥–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä: ' + err.message);
    }
}

function openEditProductModal(productId) {
    const product = products.find(p => p.id === productId);
    if (product) {
        newProduct = { ...product, colors: [...product.colors], photos: [...product.photos], sizes: [...product.sizes], groupProducts: [...product.groupProducts] };
        // –ï–∫—Ä–∞–Ω—É—î–º–æ –ª–∞–ø–∫–∏ –¥–ª—è HTML, –∑–∞–º—ñ–Ω—é—é—á–∏ " –Ω–∞ &quot;
        const escapedName = product.name.replace(/"/g, '&quot;');
        const modal = document.getElementById('modal');
        modal.innerHTML = `
            <div class="modal-content">
                <h3>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ç–æ–≤–∞—Ä #${product.id}</h3>
                <select id="product-type" onchange="updateProductType()">
                    <option value="simple" ${product.type === 'simple' ? 'selected' : ''}>–ü—Ä–æ—Å—Ç–∏–π —Ç–æ–≤–∞—Ä</option>
                    <option value="mattresses" ${product.type === 'mattresses' ? 'selected' : ''}>–ú–∞—Ç—Ä–∞—Ü–∏</option>
                    <option value="group" ${product.type === 'group' ? 'selected' : ''}>–ì—Ä—É–ø–æ–≤–∏–π —Ç–æ–≤–∞—Ä</option>
                </select><br/>
                <label for="product-type">–¢–∏–ø —Ç–æ–≤–∞—Ä—É</label>
                <input type="text" id="product-name" value="${escapedName}"><br/>
                <label for="product-name">–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É</label>
                <input type="text" id="product-slug" value="${product.slug || ''}"><br/>
                <label for="product-slug">–®–ª—è—Ö —Ç–æ–≤–∞—Ä—É</label>
                <input type="text" id="product-brand" value="${product.brand || ''}"><br/>
                <label for="product-brand">–í–∏—Ä–æ–±–Ω–∏–∫</label>
                <select id="product-category">
                    <option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</option>
                    ${categories.map(c => `<option value="${c.name}" ${c.name === product.category ? 'selected' : ''}>${c.name}</option>`).join('')}
                </select><br/>
                <label for="product-category">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
                <select id="product-subcategory">
                    <option value="">–ë–µ–∑ –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</option>
                </select><br/>
                <label for="product-subcategory">–ü—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
                <input type="text" id="product-material" value="${product.material || ''}" placeholder="–ú–∞—Ç–µ—Ä—ñ–∞–ª"><br/>
                <label for="product-material">–ú–∞—Ç–µ—Ä—ñ–∞–ª</label>
                <div id="price-fields"></div>
                <input type="datetime-local" id="product-sale-end" value="${product.saleEnd || ''}"><br/>
                <label for="product-sale-end">–î–∞—Ç–∞ –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è –∞–∫—Ü—ñ—ó</label>
                <select id="product-visible">
                    <option value="true" ${product.visible ? 'selected' : ''}>–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –Ω–∞ —Å–∞–π—Ç—ñ</option>
                    <option value="false" ${!product.visible ? 'selected' : ''}>–ù–µ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏</option>
                </select><br/>
                <label for="product-visible">–í–∏–¥–∏–º—ñ—Å—Ç—å</label>
                <div id="product-description-editor"></div>
                <input type="hidden" id="product-description">
                <label for="product-description">–û–ø–∏—Å —Ç–æ–≤–∞—Ä—É</label>
                <h4>–†–æ–∑–º—ñ—Ä–∏</h4>
                <input type="number" id="product-width-cm" value="${product.widthCm || ''}" placeholder="–®–∏—Ä–∏–Ω–∞ (—Å–º)" min="0" step="0.1"><br/>
                <label for="product-width-cm">–®–∏—Ä–∏–Ω–∞ (—Å–º)</label>
                <input type="number" id="product-depth-cm" value="${product.depthCm || ''}" placeholder="–ì–ª–∏–±–∏–Ω–∞ (—Å–º)" min="0" step="0.1"><br/>
                <label for="product-depth-cm">–ì–ª–∏–±–∏–Ω–∞ (—Å–º)</label>
                <input type="number" id="product-height-cm" value="${product.heightCm || ''}" placeholder="–í–∏—Å–æ—Ç–∞ (—Å–º)" min="0" step="0.1"><br/>
                <label for="product-height-cm">–í–∏—Å–æ—Ç–∞ (—Å–º)</label>
                <input type="number" id="product-length-cm" value="${product.lengthCm || ''}" placeholder="–î–æ–≤–∂–∏–Ω–∞ (—Å–º)" min="0" step="0.1"><br/>
                <label for="product-length-cm">–î–æ–≤–∂–∏–Ω–∞ (—Å–º)</label>
                <h4>–§–æ—Ç–æ–≥—Ä–∞—Ñ—ñ—ó</h4>
                <input type="text" id="product-photo-url" placeholder="URL —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ—ó"><br/>
                <label for="product-photo-url">URL —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ—ó</label>
                <input type="file" id="product-photo-file" accept="image/jpeg,image/png,image/gif,image/webp" multiple><br/>
                <label for="product-photo-file">–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ—é</label>
                <button onclick="addProductPhoto()">–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ</button>
                <div id="product-photo-list" class="photo-list"></div>
                <h4>–ö–æ–ª—å–æ—Ä–∏</h4>
                <input type="text" id="product-color-name" placeholder="–ù–∞–∑–≤–∞ –∫–æ–ª—å–æ—Ä—É"><br/>
                <label for="product-color-name">–ù–∞–∑–≤–∞ –∫–æ–ª—å–æ—Ä—É</label>
                <input type="color" id="product-color-value"><br/>
                <label for="product-color-value">–ó–Ω–∞—á–µ–Ω–Ω—è –∫–æ–ª—å–æ—Ä—É</label>
                <input type="number" id="product-color-price-change" placeholder="–ó–º—ñ–Ω–∞ —Ü—ñ–Ω–∏ (–≥—Ä–Ω)" step="0.01"><br/>
                <label for="product-color-price-change">–ó–º—ñ–Ω–∞ —Ü—ñ–Ω–∏ –¥–ª—è –∫–æ–ª—å–æ—Ä—É (–≥—Ä–Ω)</label>
                <input type="text" id="product-color-photo-url" placeholder="URL —Ñ–æ—Ç–æ –∫–æ–ª—å–æ—Ä—É"><br/>
                <label for="product-color-photo-url">URL —Ñ–æ—Ç–æ –∫–æ–ª—å–æ—Ä—É</label>
                <input type="file" id="product-color-photo-file" accept="image/jpeg,image/png,image/gif,image/webp"><br/>
                <label for="product-color-photo-file">–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ñ–æ—Ç–æ –∫–æ–ª—å–æ—Ä—É</label>
                <button onclick="addProductColor()">–î–æ–¥–∞—Ç–∏ –∫–æ–ª—ñ—Ä</button>
                <div id="product-color-list" class="color-photo-list"></div>
                <div id="mattress-sizes" class="type-specific">
                    <h4>–†–æ–∑–º—ñ—Ä–∏ –º–∞—Ç—Ä–∞—Ü—ñ–≤</h4>
                    <input type="text" id="mattress-size-name" placeholder="–†–æ–∑–º—ñ—Ä (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 90x190)"><br/>
                    <label for="mattress-size-name">–†–æ–∑–º—ñ—Ä</label>
                    <input type="number" id="mattress-size-price" placeholder="–¶—ñ–Ω–∞ (–≥—Ä–Ω)" min="0"><br/>
                    <label for="mattress-size-price">–¶—ñ–Ω–∞ (–≥—Ä–Ω)</label>
                    <button onclick="addMattressSize()">–î–æ–¥–∞—Ç–∏ —Ä–æ–∑–º—ñ—Ä</button>
                    <div id="mattress-size-list"></div>
                </div>
                <div id="group-products" class="type-specific">
                    <h4>–ì—Ä—É–ø–æ–≤—ñ —Ç–æ–≤–∞—Ä–∏</h4>
                    <div class="group-product-search">
                        <input type="text" id="group-product-search" placeholder="–ü–æ—à—É–∫ —Ç–æ–≤–∞—Ä—ñ–≤" oninput="searchGroupProducts()">
                        <div id="group-product-results"></div>
                    </div>
                    <div id="group-product-list"></div>
                </div>
                <div class="modal-actions">
                    <button onclick="saveEditedProduct(${product.id})">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                    <button onclick="closeModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                </div>
            </div>
        `;
        modal.classList.add('active');
        updateProductType();
        // –ü–µ—Ä–µ–¥–∞—î–º–æ description —ñ descriptionDelta –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—É
        initializeProductEditor(product.description || '', product.descriptionDelta || null);
        document.getElementById('product-category').addEventListener('change', updateSubcategories);
        updateSubcategories();
        const subcatSelect = document.getElementById('product-subcategory');
        if (product.subcategory) {
            subcatSelect.value = product.subcategory;
        }
        renderColorsList();
        renderPhotoList();
        renderMattressSizes();
        renderGroupProducts();

        // –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø—Ä–µ–≤‚Äô—é –æ—Å–Ω–æ–≤–Ω–∏—Ö —Ñ–æ—Ç–æ
        const photoInput = document.getElementById('product-photo-file');
        photoInput.addEventListener('change', () => {
            const files = photoInput.files;
            Array.from(files).forEach(file => {
                if (!newProduct.photos.includes(file)) {
                    newProduct.photos.push(file);
                }
            });
            renderPhotoList();
            resetInactivityTimer();
        });

        // –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø—Ä–µ–≤‚Äô—é —Ñ–æ—Ç–æ –∫–æ–ª—å–æ—Ä—ñ–≤
        const colorPhotoInput = document.getElementById('product-color-photo-file');
        colorPhotoInput.addEventListener('change', () => {
            const file = colorPhotoInput.files[0];
            if (file) {
                const name = document.getElementById('product-color-name').value;
                const value = document.getElementById('product-color-value').value;
                const priceChange = parseFloat(document.getElementById('product-color-price-change').value) || 0;
                if (name && value) {
                    const color = { name, value, priceChange, photo: file };
                    newProduct.colors.push(color);
                    document.getElementById('product-color-name').value = '';
                    document.getElementById('product-color-value').value = '#000000';
                    document.getElementById('product-color-price-change').value = '';
                    document.getElementById('product-color-photo-url').value = '';
                    document.getElementById('product-color-photo-file').value = '';
                    renderColorsList();
                    resetInactivityTimer();
                }
            }
        });

        resetInactivityTimer();
    }
}

async function saveEditedProduct(productId) {
    try {
        const tokenRefreshed = await refreshToken();
        if (!tokenRefreshed) {
            showNotification('–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∞–±–æ –Ω–µ–¥—ñ–π—Å–Ω–∏–π. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
            showSection('admin-login');
            return;
        }

        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ productId
        if (!productId || isNaN(parseInt(productId))) {
            showNotification('–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π ID —Ç–æ–≤–∞—Ä—É!');
            return;
        }

        const name = document.getElementById('product-name').value.trim();
        const slug = document.getElementById('product-slug').value.trim();
        const brand = document.getElementById('product-brand').value.trim();
        const category = document.getElementById('product-category').value;
        const subcategory = document.getElementById('product-subcategory').value;
        const material = document.getElementById('product-material').value.trim();
        let price = null;
        let salePrice = null;
        if (newProduct.type === 'simple') {
            const priceValue = document.getElementById('product-price')?.value.trim();
            price = priceValue ? parseFloat(priceValue) : null;
            const salePriceValue = document.getElementById('product-sale-price')?.value.trim();
            salePrice = salePriceValue ? parseFloat(salePriceValue) : null;
        }
        const saleEnd = document.getElementById('product-sale-end').value || null;
        const visible = document.getElementById('product-visible').value === 'true';
        const description = document.getElementById('product-description').value || '';
        const widthCm = parseFloat(document.getElementById('product-width-cm').value) || null;
        const depthCm = parseFloat(document.getElementById('product-depth-cm').value) || null;
        const heightCm = parseFloat(document.getElementById('product-height-cm').value) || null;
        const lengthCm = parseFloat(document.getElementById('product-length-cm').value) || null;

        if (!name || !slug) {
            showNotification('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É —Ç–∞ —à–ª—è—Ö —Ç–æ–≤–∞—Ä—É!');
            return;
        }

        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —É–Ω—ñ–∫–∞–ª—å–Ω–æ—Å—Ç—ñ —à–ª—è—Ö—É
        try {
            const slugCheck = await fetchWithAuth(`/api/products?slug=${encodeURIComponent(slug)}`);
            const existingProducts = await slugCheck.json();
            if (existingProducts.some(p => p.slug === slug && p.id !== productId)) {
                showNotification('–®–ª—è—Ö —Ç–æ–≤–∞—Ä—É –º–∞—î –±—É—Ç–∏ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–º!');
                return;
            }
        } catch (err) {
            console.error('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —É–Ω—ñ–∫–∞–ª—å–Ω–æ—Å—Ç—ñ:', err);
            showNotification('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —É–Ω—ñ–∫–∞–ª—å–Ω–æ—Å—Ç—ñ: ' + err.message);
            return;
        }

        if (newProduct.type === 'simple' && (price === null || price < 0)) {
            showNotification('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É —Ü—ñ–Ω—É –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä—É!');
            return;
        }

        if (salePrice !== null && (salePrice < 0 || isNaN(salePrice))) {
            showNotification('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É –∞–∫—Ü—ñ–π–Ω—É —Ü—ñ–Ω—É!');
            return;
        }

        if (newProduct.type === 'mattresses' && newProduct.sizes.length === 0) {
            showNotification('–î–æ–¥–∞–π—Ç–µ —Ö–æ—á–∞ –± –æ–¥–∏–Ω —Ä–æ–∑–º—ñ—Ä –¥–ª—è –º–∞—Ç—Ä–∞—Ü—É!');
            return;
        }

        if (newProduct.type === 'group' && newProduct.groupProducts.length === 0) {
            showNotification('–î–æ–¥–∞–π—Ç–µ —Ö–æ—á–∞ –± –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä –¥–æ –≥—Ä—É–ø–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä—É!');
            return;
        }

        if (widthCm !== null && (widthCm <= 0 || isNaN(widthCm))) {
            showNotification('–®–∏—Ä–∏–Ω–∞ —Ç–æ–≤–∞—Ä—É –º–∞—î –±—É—Ç–∏ –±—ñ–ª—å—à–µ 0!');
            return;
        }

        if (depthCm !== null && (depthCm <= 0 || isNaN(depthCm))) {
            showNotification('–ì–ª–∏–±–∏–Ω–∞ —Ç–æ–≤–∞—Ä—É –º–∞—î –±—É—Ç–∏ –±—ñ–ª—å—à–µ 0!');
            return;
        }

        if (heightCm !== null && (heightCm <= 0 || isNaN(heightCm))) {
            showNotification('–í–∏—Å–æ—Ç–∞ —Ç–æ–≤–∞—Ä—É –º–∞—î –±—É—Ç–∏ –±—ñ–ª—å—à–µ 0!');
            return;
        }

        if (lengthCm !== null && (lengthCm <= 0 || isNaN(lengthCm))) {
            showNotification('–î–æ–≤–∂–∏–Ω–∞ —Ç–æ–≤–∞—Ä—É –º–∞—î –±—É—Ç–∏ –±—ñ–ª—å—à–µ 0!');
            return;
        }

        if (brand && !brands.includes(brand)) {
            try {
                const response = await fetchWithAuth('/api/brands', {
                    method: 'POST',
                    body: JSON.stringify({ name: brand })
                });
                if (response.ok) {
                    brands.push(brand);
                    updateBrandOptions();
                }
            } catch (e) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –±—Ä–µ–Ω–¥—É:', e);
            }
        }

        if (material && !materials.includes(material)) {
            try {
                const response = await fetchWithAuth('/api/materials', {
                    method: 'POST',
                    body: JSON.stringify({ name: material })
                });
                if (response.ok) {
                    materials.push(material);
                    updateMaterialOptions();
                }
            } catch (e) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –º–∞—Ç–µ—Ä—ñ–∞–ª—É:', e);
            }
        }

        let product = {
            type: newProduct.type,
            name,
            slug,
            brand: brand || '',
            category: category || '',
            subcategory: subcategory || '',
            material: material || '',
            price: newProduct.type === 'simple' ? price : null,
            salePrice: salePrice || null,
            saleEnd: saleEnd || null,
            description,
            widthCm,
            depthCm,
            heightCm,
            lengthCm,
            photos: [],
            colors: newProduct.colors.map(color => ({
                name: color.name,
                value: color.value,
                priceChange: Number(color.priceChange) || 0,
                photo: color.photo || null
            })),
            sizes: newProduct.sizes.map(size => ({
                name: size.name,
                price: Number(size.price) || 0
            })),
            groupProducts: newProduct.groupProducts,
            active: newProduct.active,
            visible
        };

        const mediaUrls = [];
        const parser = new DOMParser();
        const doc = parser.parseFromString(description, 'text/html');
        const images = doc.querySelectorAll('img');
        const videos = doc.querySelectorAll('iframe');

        for (let img of images) {
            const src = img.getAttribute('src');
            if (src && src.startsWith('blob:')) {
                try {
                    const response = await fetch(src);
                    const blob = await response.blob();
                    const formData = new FormData();
                    formData.append('file', blob, `description-image-${Date.now()}.png`);
                    const uploadResponse = await fetchWithAuth('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    if (!uploadResponse.ok) {
                        throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è');
                    }
                    const uploadData = await uploadResponse.json();
                    if (uploadData.url) {
                        mediaUrls.push({ oldUrl: src, newUrl: uploadData.url });
                    }
                } catch (err) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è:', err);
                    showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è: ' + err.message);
                    return;
                }
            }
        }

        let updatedDescription = description;
        mediaUrls.forEach(({ oldUrl, newUrl }) => {
            updatedDescription = updatedDescription.replace(oldUrl, newUrl);
        });
        product.description = updatedDescription;

        const photoFiles = newProduct.photos.filter(photo => photo instanceof File);
        for (let file of photoFiles) {
            const validation = validateFile(file);
            if (!validation.valid) {
                showNotification(validation.error);
                return;
            }
            try {
                const formData = new FormData();
                formData.append('file', file);
                const response = await fetchWithAuth('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) {
                    throw new Error(`–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ: ${response.statusText}`);
                }
                const data = await response.json();
                product.photos.push(data.url);
            } catch (err) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ:', err);
                showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–æ—Ç–æ: ' + err.message);
                return;
            }
        }

        product.photos.push(...newProduct.photos.filter(photo => typeof photo === 'string'));

        for (let i = 0; i < newProduct.colors.length; i++) {
            const color = newProduct.colors[i];
            if (color.photo instanceof File) {
                const validation = validateFile(color.photo);
                if (!validation.valid) {
                    showNotification(validation.error);
                    return;
                }
                try {
                    const formData = new FormData();
                    formData.append('file', color.photo);
                    const response = await fetchWithAuth('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    if (!response.ok) {
                        throw new Error(`–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ –∫–æ–ª—å–æ—Ä—É: ${response.statusText}`);
                    }
                    const data = await response.json();
                    product.colors[i].photo = data.url;
                } catch (err) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ç–æ –∫–æ–ª—å–æ—Ä—É:', err);
                    showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–æ—Ç–æ –∫–æ–ª—å–æ—Ä—É: ' + err.message);
                    return;
                }
            }
        }

        const response = await fetchWithAuth(`/api/products/${productId}`, {
            method: 'PUT',
            body: JSON.stringify(product)
        });

        const updatedProduct = await response.json();
        const index = products.findIndex(p => p.id === productId);
        if (index !== -1) {
            products[index] = updatedProduct;
        } else {
            products.push(updatedProduct);
        }
        closeModal();
        renderAdmin('products');
        showNotification('–¢–æ–≤–∞—Ä –æ–Ω–æ–≤–ª–µ–Ω–æ!');
        unsavedChanges = false;
        resetInactivityTimer();
    } catch (err) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ —Ç–æ–≤–∞—Ä—É:', err);
        showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ —Ç–æ–≤–∞—Ä: ' + err.message);
    }
}

async function deleteProduct(productId) {
    if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ç–æ–≤–∞—Ä?')) {
        try {
            const response = await fetchWithAuth(`/api/products/${productId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                throw new Error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ —Ç–æ–≤–∞—Ä—É: ' + response.statusText);
            }

            products = products.filter(p => p.id !== productId);
            products.forEach(p => {
                if (p.type === 'group') {
                    p.groupProducts = p.groupProducts.filter(pid => pid !== productId);
                }
            });
            renderAdmin('products');
            showNotification('–¢–æ–≤–∞—Ä –≤–∏–¥–∞–ª–µ–Ω–æ!');
            unsavedChanges = false;
            resetInactivityTimer();
        } catch (err) {
            console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ —Ç–æ–≤–∞—Ä—É:', err);
            showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ —Ç–æ–≤–∞—Ä: ' + err.message);
        }
    }
}

async function toggleProductActive(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) {
        showNotification('–¢–æ–≤–∞—Ä –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!');
        return;
    }

    const newActiveStatus = !product.active;

    try {
        const response = await fetchWithAuth(`/api/products/${productId}`, {
            method: 'PATCH',
            body: JSON.stringify({ active: newActiveStatus })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ —Å—Ç–∞—Ç—É—Å—É —Ç–æ–≤–∞—Ä—É: ${errorData.error || response.statusText}`);
        }

        product.active = newActiveStatus;
        renderAdmin('products');
        showNotification(`–¢–æ–≤–∞—Ä ${product.active ? '–∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ' : '–¥–µ–∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ'}!`);
        resetInactivityTimer();
    } catch (err) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ —Å—Ç–∞—Ç—É—Å—É —Ç–æ–≤–∞—Ä—É:', err);
        showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å —Ç–æ–≤–∞—Ä—É: ' + err.message);
    }
}

    function sortAdminProducts(sortType) {
        const [key, order] = sortType.split('-');
        products.sort((a, b) => {
            let valA, valB;
            if (key === 'id') {
                valA = a.id;
                valB = b.id;
            } else if (key === 'name') {
                valA = a.name.toLowerCase();
                valB = b.name.toLowerCase();
            } else if (key === 'brand') {
                valA = (a.brand || '').toLowerCase();
                valB = (b.brand || '').toLowerCase();
            } else if (key === 'price') {
                valA = a.price || (a.sizes ? Math.min(...a.sizes.map(s => s.price)) : Infinity);
                valB = b.price || (b.sizes ? Math.min(...b.sizes.map(s => s.price)) : Infinity);
            }
            if (valA < valB) return order === 'asc' ? -1 : 1;
            if (valA > valB) return order === 'asc' ? 1 : -1;
            return 0;
        });
        renderAdmin('products');
        resetInactivityTimer();
    }

function sortOrders(sortType) {
    const [key, order] = sortType.split('-');
    orders.sort((a, b) => {
        let valA, valB;
        if (key === 'date') {
            valA = new Date(a.date);
            valB = new Date(b.date);
        } else if (key === 'total') {
            valA = a.total || 0;
            valB = b.total || 0;
        } else if (key === 'status') {
            valA = (a.status || '').toLowerCase();
            valB = (b.status || '').toLowerCase();
        }
        if (valA < valB) return order === 'asc' ? -1 : 1;
        if (valA > valB) return order === 'asc' ? 1 : -1;
        return 0;
    });
    currentPage = 1;
    renderAdmin('orders');
    resetInactivityTimer();
}

async function uploadBulkPrices() {
    const file = document.getElementById('bulk-price-file').files[0];
    if (!file) {
        showNotification('–í–∏–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è!');
        return;
    }

    try {
        const tokenRefreshed = await refreshToken();
        if (!tokenRefreshed) {
            showNotification('–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∞–±–æ –Ω–µ–¥—ñ–π—Å–Ω–∏–π. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
            showSection('admin-login');
            return;
        }

        const reader = new FileReader();
        reader.onload = async (e) => {
            const lines = e.target.result.split('\n').map(line => line.trim()).filter(line => line);
            let updated = 0;

            for (const line of lines) {
                const parts = line.split(',');
                if (parts.length < 4) continue;
                const id = parseInt(parts[0].trim());
                const product = products.find(p => p.id === id);
                if (!product) continue;

                if (product.type === 'simple') {
                    const price = parseFloat(parts[parts.length - 1].trim());
                    if (!isNaN(price) && price >= 0) {
                        product.price = price;
                        try {
                            const response = await fetchWithAuth(`/api/products/${id}`, {
                                method: 'PUT',
                                body: JSON.stringify(product)
                            });
                            if (!response.ok) {
                                throw new Error(`–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—É #${id}`);
                            }
                            updated++;
                        } catch (e) {
                            console.error(`–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—É #${id}:`, e);
                        }
                    }
                } else if (product.type === 'mattresses') {
                    const sizePart = parts[parts.length - 2].trim();
                    const price = parseFloat(parts[parts.length - 1].trim());
                    if (sizePart.startsWith('–†–æ–∑–º—ñ—Ä: ')) {
                        const size = sizePart.replace('–†–æ–∑–º—ñ—Ä: ', '').trim();
                        const sizeObj = product.sizes.find(s => s.name === size);
                        if (sizeObj && !isNaN(price) && price >= 0) {
                            sizeObj.price = price;
                            try {
                                const response = await fetchWithAuth(`/api/products/${id}`, {
                                    method: 'PUT',
                                    body: JSON.stringify(product)
                                });
                                if (!response.ok) {
                                    throw new Error(`–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—É #${id}`);
                                }
                                updated++;
                            } catch (e) {
                                console.error(`–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—É #${id}:`, e);
                            }
                        }
                    }
                }
            }

            renderAdmin('products');
            showNotification(`–û–Ω–æ–≤–ª–µ–Ω–æ —Ü—ñ–Ω –¥–ª—è ${updated} —Ç–æ–≤–∞—Ä—ñ–≤!`);
            resetInactivityTimer();
        };
        reader.readAsText(file);
    } catch (e) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ü—ñ–Ω:', e);
        showNotification('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ü—ñ–Ω: ' + e.message);
    }
}

    function exportPrices() {
        const exportData = products
            .filter(p => p.active && p.type !== 'group')
            .map(p => {
                if (p.type === 'simple') {
                    return `${p.id},${p.name},${p.brand || '–ë–µ–∑ –±—Ä–µ–Ω–¥—É'},${p.price || '0'}`;
                } else if (p.type === 'mattresses') {
                    return p.sizes.map(s => `${p.id},${p.name},${p.brand || '–ë–µ–∑ –±—Ä–µ–Ω–¥—É'},–†–æ–∑–º—ñ—Ä: ${s.name},${s.price || '0'}`).join('\n');
                }
                return '';
            })
            .filter(line => line)
            .join('\n');
        const blob = new Blob([exportData], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'prices-export.txt';
        a.click();
        URL.revokeObjectURL(url);
        showNotification('–¶—ñ–Ω–∏ –µ–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ!');
        resetInactivityTimer();
    }

    function renderCountdown(product) {
        if (product.saleEnd) {
            const endDate = new Date(product.saleEnd).getTime();
            const now = new Date().getTime();
            const timeLeft = endDate - now;
            if (timeLeft > 0) {
                const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                return `<span class="sale-countdown">–ó–∞–ª–∏—à–∏–ª–æ—Å—å: ${days}–¥ ${hours}–≥ ${minutes}—Ö–≤</span>`;
            }
        }
        return '';
    }

function viewOrder(index) {
    const order = orders[index];
    if (order) {
        // –§–æ—Ä–º–∞—Ç—É—î–º–æ –¥–∞—Ç—É –≤ –ª–æ–∫–∞–ª—å–Ω–∏–π —á–∞—Å–æ–≤–∏–π –ø–æ—è—Å
        const orderDate = new Date(order.date);
        const formattedDate = orderDate.toLocaleString('uk-UA', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });

        const modal = document.getElementById('modal');
        modal.innerHTML = `
            <div class="modal-content">
                <h3>–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è #${index + 1}</h3>
                <p>–î–∞—Ç–∞: ${formattedDate}</p>
                <p>–°—Ç–∞—Ç—É—Å: ${order.status || '–ù/–î'}</p>
                <p>–°—É–º–∞: ${order.total ? order.total + ' –≥—Ä–Ω' : '–ù/–î'}</p>
                <h4>–î–∞–Ω—ñ –∫–ª—ñ—î–Ω—Ç–∞:</h4>
                ${
                    order.customer && typeof order.customer === 'object'
                        ? Object.entries(order.customer).map(([key, value]) => {
                              const field = orderFields.find(f => f.name === key);
                              return `<p>${field ? field.label : key}: ${value}</p>`;
                          }).join('')
                        : '<p>–î–∞–Ω—ñ –∫–ª—ñ—î–Ω—Ç–∞ –≤—ñ–¥—Å—É—Ç–Ω—ñ.</p>'
                }
                <h4>–¢–æ–≤–∞—Ä–∏:</h4>
                ${
                    order.items && Array.isArray(order.items) && order.items.length > 0
                        ? order.items.map(item => {
                              const product = products.find(p => p.id === item.id);
                              const colorInfo = item.color && item.color.trim() !== '' ? `, –ö–æ–ª—ñ—Ä: ${item.color}` : '';
                              return product
                                  ? `<p>${product.name}${colorInfo} - ${item.quantity} —à—Ç. - ${item.price} –≥—Ä–Ω</p>`
                                  : `<p>–¢–æ–≤–∞—Ä #${item.id} (–≤–∏–¥–∞–ª–µ–Ω–∏–π)${colorInfo} - ${item.quantity} —à—Ç. - ${item.price} –≥—Ä–Ω</p>`;
                          }).join('')
                        : '<p>–¢–æ–≤–∞—Ä–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ.</p>'
                }
                <div class="modal-actions">
                    <button onclick="closeModal()">–ó–∞–∫—Ä–∏—Ç–∏</button>
                </div>
            </div>
        `;
        modal.classList.add('active');
        resetInactivityTimer();
    } else {
        showNotification('–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!');
    }
}

function changeOrderStatus(index) {
    const order = orders[index];
    if (order) {
        const modal = document.getElementById('modal');
        modal.innerHTML = `
            <div class="modal-content">
                <h3>–ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è #${index + 1}</h3>
                <p>–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞—Ç—É—Å: ${order.status || '–ù/–î'}</p>
                <select id="new-order-status">
                    <option value="–ù–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è" ${order.status === '–ù–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è' ? 'selected' : ''}>–ù–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</option>
                    <option value="–í –æ–±—Ä–æ–±—Ü—ñ" ${order.status === '–í –æ–±—Ä–æ–±—Ü—ñ' ? 'selected' : ''}>–í –æ–±—Ä–æ–±—Ü—ñ</option>
                    <option value="–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ" ${order.status === '–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ' ? 'selected' : ''}>–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ</option>
                    <option value="–ó–∞–≤–µ—Ä—à–µ–Ω–æ" ${order.status === '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' ? 'selected' : ''}>–ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                </select><br/>
                <label for="new-order-status">–ù–æ–≤–∏–π —Å—Ç–∞—Ç—É—Å</label>
                <div class="modal-actions">
                    <button onclick="saveOrderStatus(${index})">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                    <button onclick="closeModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                </div>
            </div>
        `;
        modal.classList.add('active');
        resetInactivityTimer();
    }
}

async function saveOrderStatus(index) {
    try {
        const tokenRefreshed = await refreshToken();
        if (!tokenRefreshed) {
            showNotification('–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∞–±–æ –Ω–µ–¥—ñ–π—Å–Ω–∏–π. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
            showSection('admin-login');
            return;
        }

        const order = orders[index];
        if (!order || !order._id) {
            showNotification('–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∞–±–æ –Ω–µ–¥—ñ–π—Å–Ω–µ!');
            return;
        }

        const newStatus = document.getElementById('new-order-status').value;
        if (!newStatus) {
            showNotification('–í–∏–±–µ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π —Å—Ç–∞—Ç—É—Å!');
            return;
        }

        // –û—á–∏—â–∞—î–º–æ items –≤—ñ–¥ —Å–∏—Å—Ç–µ–º–Ω–∏—Ö –ø–æ–ª—ñ–≤
        const cleanedItems = (order.items || []).map(item => {
            const { _id, ...cleanedItem } = item;
            return cleanedItem;
        });

        const updatedOrder = {
            status: newStatus,
            date: order.date,
            total: order.total || 0,
            customer: order.customer || {},
            items: cleanedItems
        };

        const response = await fetchWithAuth(`/api/orders/${order._id}`, {
            method: 'PUT',
            body: JSON.stringify(updatedOrder)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É: ${errorData.error || response.statusText}`);
        }

        // –û–Ω–æ–≤–ª—é—î–º–æ –ª–æ–∫–∞–ª—å–Ω–∏–π –º–∞—Å–∏–≤ orders
        orders[index] = { ...order, ...updatedOrder };
        closeModal();
        renderAdmin('orders');
        showNotification('–°—Ç–∞—Ç—É—Å –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑–º—ñ–Ω–µ–Ω–æ!');
        resetInactivityTimer();
    } catch (err) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:', err, err.stack);
        showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è: ' + err.message);
    }
}

async function deleteOrder(index) {
    if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è?')) {
        try {
            const tokenRefreshed = await refreshToken();
            if (!tokenRefreshed) {
                showNotification('–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∞–±–æ –Ω–µ–¥—ñ–π—Å–Ω–∏–π. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
                showSection('admin-login');
                return;
            }

            const order = orders[index];
            if (!order || !order._id) {
                showNotification('–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∞–±–æ –Ω–µ–¥—ñ–π—Å–Ω–µ!');
                return;
            }

            const response = await fetchWithAuth(`/api/orders/${order._id}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è');
            }

            orders.splice(index, 1);
            renderAdmin('orders');
            showNotification('–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–æ!');
            unsavedChanges = false;
            resetInactivityTimer();
        } catch (e) {
            console.error('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:', e);
            showNotification('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è: ' + e.message);
        }
    }
}

    function sortOrders(criteria) {
        const [key, direction] = criteria.split('-');
        orders.sort((a, b) => {
            let valA = key === 'date' ? new Date(a[key]) : a[key];
            let valB = key === 'date' ? new Date(b[key]) : b[key];
            if (direction === 'asc') {
                return typeof valA === 'string' ? valA.localeCompare(valB) : valA - valB;
            } else {
                return typeof valA === 'string' ? valB.localeCompare(valA) : valB - valA;
            }
        });
        currentPage = 1;
        renderAdmin('orders');
        resetInactivityTimer();
    }

    function filterOrders() {
        currentPage = 1;
        renderAdmin('orders');
        resetInactivityTimer();
    }

// –í–∏–∫–ª–∏–∫ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó —Ä–µ–¥–∞–∫—Ç–æ—Ä—ñ–≤ –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è

document.addEventListener('DOMContentLoaded', () => {
    const storedSession = localStorage.getItem('adminSession');
    const token = localStorage.getItem('adminToken');
    if (storedSession && token) {
        session = JSON.parse(LZString.decompressFromUTF16(storedSession));
        if (session.isActive && (Date.now() - session.timestamp) < sessionTimeout) {
            showSection('admin-panel');
            initializeData();
            connectAdminWebSocket();
            resetInactivityTimer();
        } else {
            localStorage.removeItem('adminToken');
            session = { isActive: false, timestamp: 0 };
            localStorage.setItem('adminSession', LZString.compressToUTF16(JSON.stringify(session)));
            showSection('admin-login');
        }
    } else {
        session = { isActive: false, timestamp: 0 };
        localStorage.setItem('adminSession', LZString.compressToUTF16(JSON.stringify(session)));
        showSection('admin-login');
    }

    const loginBtn = document.getElementById('login-btn');
    if (loginBtn) {
        loginBtn.addEventListener('click', login);
    }
});

document.addEventListener('mousemove', resetInactivityTimer);
document.addEventListener('keypress', resetInactivityTimer);

function connectAdminWebSocket(attempt = 1, maxAttempts = 10) {
    const wsUrl = window.location.hostname === 'localhost'
        ? 'ws://localhost:3000'
        : 'wss://mebli.onrender.com';
    const token = localStorage.getItem('adminToken');

    if (!token) {
        console.warn('–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π, WebSocket –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ');
        showSection('admin-login');
        showNotification('–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
        return;
    }

    if (socket && socket.readyState === WebSocket.OPEN) {
        console.log('WebSocket —É–∂–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ');
        return;
    }

    if (attempt > maxAttempts) {
        console.error('–î–æ—Å—è–≥–Ω—É—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å–ø—Ä–æ–± –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ WebSocket');
        showNotification('–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ WebSocket –ø—ñ—Å–ª—è –∫—ñ–ª—å–∫–æ—Ö —Å–ø—Ä–æ–±.');
        return;
    }

    socket = new WebSocket(`${wsUrl}?token=${encodeURIComponent(token)}`);

    socket.onopen = () => {
        console.log('–ê–¥–º—ñ–Ω –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–æ WebSocket');
        const subscriptions = ['products', 'categories', 'settings', 'orders', 'slides', 'materials', 'brands', 'filters'];
        subscriptions.forEach(type => {
            if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type, action: 'subscribe' }));
            }
        });
        resetInactivityTimer();
    };

    socket.onmessage = (event) => {
        try {
            const { type, data } = JSON.parse(event.data);
            console.log(`–û—Ç—Ä–∏–º–∞–Ω–æ WebSocket –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–ª—è ${type}:`, data);
            if (type === 'settings') {
                settings = { ...settings, ...data };
                renderSettingsAdmin();
            } else if (type === 'products') {
                products = data;
                renderAdmin('products');
            } else if (type === 'categories') {
                categories = data;
                renderCategoriesAdmin();
            } else if (type === 'orders') {
                orders = data;
                renderAdmin('orders');
            } else if (type === 'slides') {
                slides = data;
                renderSlidesAdmin();
            } else if (type === 'materials') {
                materials = data;
                updateMaterialOptions();
            } else if (type === 'brands') {
                brands = data;
                updateBrandOptions();
            } else if (type === 'filters') {
                filters = data;
                renderFilters();
            }
            resetInactivityTimer();
        } catch (e) {
            console.error('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ WebSocket –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:', e);
        }
    };

    socket.onclose = (event) => {
        console.log(`WebSocket –∑–∞–∫—Ä–∏—Ç–æ, –∫–æ–¥: ${event.code}, –ø—Ä–∏—á–∏–Ω–∞: ${event.reason}`);
        if (event.code === 4001) { // –ö–æ–¥ 4001 –¥–ª—è –ø–æ–º–∏–ª–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
            localStorage.removeItem('adminToken');
            session = { isActive: false, timestamp: 0 };
            localStorage.setItem('adminSession', LZString.compressToUTF16(JSON.stringify(session)));
            showSection('admin-login');
            showNotification('–°–µ—Å—ñ—è –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—è. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
        } else {
            const delay = Math.min(1000 * Math.pow(2, attempt), 30000);
            console.log(`–°–ø—Ä–æ–±–∞ –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è ${attempt}/${maxAttempts} —á–µ—Ä–µ–∑ ${delay}–º—Å...`);
            setTimeout(() => connectAdminWebSocket(attempt + 1, maxAttempts), delay);
        }
    };

    socket.onerror = (error) => {
        console.error('–ü–æ–º–∏–ª–∫–∞ WebSocket:', error);
        showNotification('–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ WebSocket. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è.');
    };
}

// –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –¥–ª—è —ñ–º–ø–æ—Ä—Ç—É —Ñ–∞–π–ª—ñ–≤
document.getElementById('import-site-file').addEventListener('change', async function() {
    const file = this.files[0];
    if (file) {
        try {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = JSON.parse(e.target.result);
                const tokenRefreshed = await refreshToken();
                if (!tokenRefreshed) {
                    showNotification('–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∞–±–æ –Ω–µ–¥—ñ–π—Å–Ω–∏–π. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
                    showSection('admin-login');
                    return;
                }
                const response = await fetchWithAuth('/api/settings', {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    settings = data;
                    renderSettingsAdmin();
                    showNotification('–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–∞–π—Ç—É —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ!');
                } else {
                    throw new Error('–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å —Å–∞–π—Ç—É');
                }
            };
            reader.readAsText(file);
        } catch (e) {
            console.error('–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å —Å–∞–π—Ç—É:', e);
            showNotification('–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å —Å–∞–π—Ç—É: ' + e.message);
        }
    }
});

document.getElementById('import-products-file').addEventListener('change', async function() {
    const file = this.files[0];
    if (file) {
        try {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = JSON.parse(e.target.result);
                const tokenRefreshed = await refreshToken();
                if (!tokenRefreshed) {
                    showNotification('–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∞–±–æ –Ω–µ–¥—ñ–π—Å–Ω–∏–π. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
                    showSection('admin-login');
                    return;
                }
                const response = await fetchWithAuth('/api/products/bulk', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    products = data;
                    renderAdmin('products');
                    showNotification('–¢–æ–≤–∞—Ä–∏ —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ!');
                } else {
                    throw new Error('–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É —Ç–æ–≤–∞—Ä—ñ–≤');
                }
            };
            reader.readAsText(file);
        } catch (e) {
            console.error('–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É —Ç–æ–≤–∞—Ä—ñ–≤:', e);
            showNotification('–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É —Ç–æ–≤–∞—Ä—ñ–≤: ' + e.message);
        }
    }
});

document.getElementById('import-orders-file').addEventListener('change', async function() {
    const file = this.files[0];
    if (file) {
        try {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = JSON.parse(e.target.result);
                const tokenRefreshed = await refreshToken();
                if (!tokenRefreshed) {
                    showNotification('–¢–æ–∫–µ–Ω –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∞–±–æ –Ω–µ–¥—ñ–π—Å–Ω–∏–π. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.');
                    showSection('admin-login');
                    return;
                }
                const response = await fetchWithAuth('/api/orders/bulk', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    orders = data;
                    renderAdmin('orders');
                    showNotification('–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ!');
                } else {
                    throw new Error('–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É –∑–∞–º–æ–≤–ª–µ–Ω—å');
                }
            };
            reader.readAsText(file);
        } catch (e) {
            console.error('–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É –∑–∞–º–æ–≤–ª–µ–Ω—å:', e);
            showNotification('–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É –∑–∞–º–æ–≤–ª–µ–Ω—å: ' + e.message);
        }
    }
});

document.getElementById('bulk-price-file').addEventListener('change', function() {
    uploadBulkPrices();
});

window.addEventListener('beforeunload', (e) => {
    if (unsavedChanges) {
        const confirmationMessage = '–£ –≤–∞—Å —î –Ω–µ–∑–±–µ—Ä–µ–∂–µ–Ω—ñ –∑–º—ñ–Ω–∏. –í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –∑–∞–ª–∏—à–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É?';
        e.returnValue = confirmationMessage;
        return confirmationMessage;
    }
});
  </script>
 </body>
</html>